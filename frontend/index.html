<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval'; 
        style-src 'self' 'unsafe-inline'; 
        img-src 'self' data: https:; 
        connect-src 'self' http://127.0.0.1:8545 http://localhost:8545;
    ">
    <title>SplitExpense - Gestor de Gastos Compartidos</title>
    <link rel="stylesheet" href="styles-platform.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loadingText">Cargando...</p>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Header -->
    <header class="app-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>üí∞ SplitExpense</h1>
                    <span class="version-badge">Gestor de Gastos Compartidos</span>
                </div>
                
                <div class="header-actions">
                    <div id="userNickname" class="nickname-badge" style="display: none;">
                        <span class="nickname-icon">üë§</span>
                        <span id="nicknameDisplay"></span>
                    </div>
                    <button id="connectWallet" class="btn btn-primary">
                        <span class="btn-icon">ü¶ä</span>
                        <span>Conectar Wallet</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            
            <!-- Nickname Setup Modal (first time users) -->
            <div id="nicknameModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h2>üëã ¬°Bienvenido a SplitExpense!</h2>
                    <p>Puedes elegir un <strong>nickname opcional</strong> para que sea m√°s f√°cil identificarte en los grupos, o continuar usando tu direcci√≥n de wallet.</p>
                    
                    <div class="form-group">
                        <label for="nicknameInput">Tu Nickname (Opcional)</label>
                        <input 
                            type="text" 
                            id="nicknameInput" 
                            placeholder="Ej: Juan, Maria123, etc."
                            minlength="3"
                            maxlength="32"
                            pattern="[a-zA-Z0-9]+"
                        >
                        <small>3-32 caracteres, solo letras y n√∫meros. Puedes establecerlo despu√©s.</small>
                    </div>
                    
                    <button id="setNicknameBtn" class="btn btn-primary btn-block">
                        Establecer Nickname
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="dashboard-section">
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <h3 id="totalFundsCreated">0</h3>
                            <p>Grupos Creados</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3 id="totalFundsParticipating">0</h3>
                            <p>Grupos Activos</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üíé</div>
                        <div class="stat-content">
                            <h3 id="totalValueLocked">0</h3>
                            <p>ETH Total</p>
                        </div>
                    </div>
                </div>

                <!-- Pending Invitations Banner -->
                <div id="pendingInvitationsSection" class="pending-invitations-section" style="display: none;">
                    <div class="invitations-header">
                        <h3>üé´ Invitaciones Pendientes</h3>
                        <span class="invitations-count" id="invitationsCount">0</span>
                    </div>
                    <div id="invitationsList" class="invitations-list">
                        <!-- Invitations will be loaded here -->
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="action-bar">
                    <h2>Mis Grupos</h2>
                    <button id="createFundBtn" class="btn btn-primary">
                        <span class="btn-icon">‚ûï</span>
                        <span>Crear Nuevo Grupo</span>
                    </button>
                </div>

                <!-- Fund Filters -->
                <div class="fund-filters">
                    <button class="filter-btn active" data-filter="all">
                        Todos (<span id="countAll">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="created">
                        Creados (<span id="countCreated">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="participating">
                        Participando (<span id="countParticipating">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="travel">
                        üå¥ Viajes (<span id="countTravel">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="savings">
                        üí∞ Ahorros (<span id="countSavings">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="shared">
                        ü§ù Compartidos (<span id="countShared">0</span>)
                    </button>
                </div>

                <!-- Funds Grid -->
                <div id="fundsGrid" class="funds-grid">
                    <!-- Funds will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-icon">üì¶</div>
                    <h3>No tienes grupos a√∫n</h3>
                    <p>Crea tu primer grupo para comenzar a gestionar gastos compartidos</p>
                    <button class="btn btn-primary" onclick="document.getElementById('createFundBtn').click()">
                        Crear Mi Primer Grupo
                    </button>
                </div>

            </section>

            <!-- Fund Detail Section (Single Fund View) -->
            <section id="fundDetailSection" class="fund-detail-section">
                
                <!-- Back Button -->
                <div class="back-bar">
                    <button id="backToDashboard" class="btn btn-secondary">
                        <span class="btn-icon">‚Üê</span>
                        <span>Volver a Mis Grupos</span>
                    </button>
                </div>

                <!-- Fund Header -->
                <div class="fund-detail-header">
                    <div class="fund-header-icon" id="fundHeaderIcon">üå¥</div>
                    <div class="fund-header-info">
                        <h1 id="fundDetailName">Cargando...</h1>
                        <p id="fundDetailDescription">-</p>
                        <div class="fund-badges">
                            <span class="badge" id="fundTypeBadge">Tipo</span>
                            <span class="badge" id="fundStatusBadge">Estado</span>
                            <span class="badge" id="fundPrivacyBadge">Privacidad</span>
                        </div>
                    </div>
                </div>

                <!-- Fund Stats Bar -->
                <div class="fund-stats-bar">
                    <div class="fund-stat-item">
                        <span class="stat-label">Balance</span>
                        <span class="stat-value" id="fundBalance">0 ETH</span>
                    </div>
                    <div class="fund-stat-item">
                        <span class="stat-label">Meta</span>
                        <span class="stat-value" id="fundTarget">0 ETH</span>
                    </div>
                    <div class="fund-stat-item">
                        <span class="stat-label">Progreso</span>
                        <span class="stat-value" id="fundProgress">0%</span>
                    </div>
                    <div class="fund-stat-item">
                        <span class="stat-label">Miembros</span>
                        <span class="stat-value" id="fundMembers">0</span>
                    </div>
                    <div class="fund-stat-item">
                        <span class="stat-label">Propuestas</span>
                        <span class="stat-value" id="fundProposals">0</span>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" id="fundProgressBar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Invitation Banner (if pending) -->
                <div id="invitationBanner" class="invitation-banner" style="display: none;">
                    <div class="invitation-content">
                        <span class="invitation-icon">üé´</span>
                        <p>Tienes una invitaci√≥n pendiente para este fondo</p>
                    </div>
                    <button id="acceptInvitationBtn" class="btn btn-primary">
                        Aceptar Invitaci√≥n
                    </button>
                </div>

                <!-- Closed Fund Banner -->
                <div id="closedFundBanner" class="closed-fund-banner" style="display: none;">
                    <div class="closed-fund-content">
                        <span class="closed-fund-icon">üîí</span>
                        <div>
                            <h4>Grupo Cerrado</h4>
                            <p>Este grupo ha sido cerrado permanentemente. Los fondos fueron distribuidos proporcionalmente entre todos los miembros.</p>
                        </div>
                    </div>
                </div>

                <!-- Fund Tabs -->
                <div class="fund-tabs">
                    <button class="fund-tab-btn active" data-tab="deposit">
                        <span class="tab-icon">üíµ</span>
                        <span>Depositar</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="invite">
                        <span class="tab-icon">üé´</span>
                        <span>Invitar</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="propose">
                        <span class="tab-icon">üìù</span>
                        <span>Proponer Gasto</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="vote">
                        <span class="tab-icon">üó≥Ô∏è</span>
                        <span>Votar</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="history">
                        <span class="tab-icon">üìú</span>
                        <span>Historial</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="balances">
                        <span class="tab-icon">‚öñÔ∏è</span>
                        <span>Balances</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="members">
                        <span class="tab-icon">üë•</span>
                        <span>Miembros</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="manage">
                        <span class="tab-icon">‚öôÔ∏è</span>
                        <span>Gestionar</span>
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="fund-tab-content">
                    
                    <!-- Deposit Tab -->
                    <div id="depositTab" class="tab-pane active">
                        <div class="tab-card">
                            <h3>üí∞ Aportar al Bote Com√∫n</h3>
                            <p>Deposita dinero al grupo. √ötil para gastos futuros o para equilibrar balances.</p>
                            
                            <div class="form-group">
                                <label for="depositAmount">Monto a Depositar (ETH)</label>
                                <input type="number" id="depositAmount" placeholder="0.0" step="0.01" min="0.01">
                            </div>
                            
                            <div class="contribution-info">
                                <span>Tu contribuci√≥n actual: <strong id="userContribution">0 ETH</strong></span>
                            </div>
                            
                            <button id="depositBtn" class="btn btn-primary btn-block">
                                Aportar al Bote
                            </button>
                        </div>
                    </div>

                    <!-- Invite Tab -->
                    <div id="inviteTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>üé´ Invitar Miembros</h3>
                            <p>Invita amigos para que se unan al grupo. Ellos deber√°n aceptar la invitaci√≥n.</p>
                            
                            <div class="invite-info-box">
                                <p><strong>‚ÑπÔ∏è Informaci√≥n:</strong></p>
                                <ul>
                                    <li>Solo el creador del grupo puede invitar</li>
                                    <li>Los invitados ver√°n la invitaci√≥n en su dashboard</li>
                                    <li>Deben aceptar antes de poder registrar gastos</li>
                                    <li>No puedes invitarte a ti mismo</li>
                                </ul>
                            </div>
                            
                            <div class="form-group">
                                <label for="inviteAddress">Nickname o Direcci√≥n</label>
                                <input type="text" id="inviteAddress" placeholder="Ej: Bob o 0x123...">
                                <small>Ingresa el nickname del usuario o su direcci√≥n Ethereum</small>
                            </div>
                            
                            <button id="inviteBtn" class="btn btn-primary btn-block">
                                Enviar Invitaci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Propose Tab -->
                    <div id="proposeTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>üìù Proponer Gasto</h3>
                            <p>Prop√≥n usar dinero del bote com√∫n para pagar a un proveedor externo. El grupo votar√° si aprueba.</p>
                            
                            <div class="info-box">
                                <p><strong>üí° C√≥mo funciona:</strong></p>
                                <ul>
                                    <li>Prop√≥n pagar un gasto desde el bote com√∫n (hotel, restaurante, etc.)</li>
                                    <li>Indica a qui√©n se le pagar√° (proveedor externo con su direcci√≥n)</li>
                                    <li>El grupo vota si aprueba o rechaza usar el dinero del bote</li>
                                    <li>Si se aprueba, el dinero se env√≠a directo del bote al proveedor</li>
                                </ul>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalRecipient">A qui√©n se le pagar√° (Direcci√≥n del proveedor)</label>
                                <input type="text" id="proposalRecipient" placeholder="0x123... (direcci√≥n del hotel, restaurante, etc.)">
                                <small>Direcci√≥n Ethereum del agente externo que recibir√° el pago</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalAmount">Monto a Pagar (ETH)</label>
                                <input type="number" id="proposalAmount" placeholder="0.0" step="0.01" min="0.01">
                                <small>Cantidad que se pagar√° del bote com√∫n al proveedor</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalDescription">Descripci√≥n del Gasto</label>
                                <textarea id="proposalDescription" rows="3" placeholder="Ej: Hotel 3 noches en Canc√∫n - Pago a Marriott, Cena grupal en Restaurante La Costa..."></textarea>
                                <small>Explica el motivo del gasto y a qui√©n se le pagar√°</small>
                            </div>
                            
                            <button id="createProposalBtn" class="btn btn-primary btn-block">
                                üìù Proponer Uso de Fondos
                            </button>
                        </div>
                    </div>

                    <!-- Vote Tab -->
                    <div id="voteTab" class="tab-pane">
                        <h3>üó≥Ô∏è Votar Propuestas</h3>
                        <p class="tab-description">Propuestas de uso de fondos. Vota si apruebas o rechazas pagar a cada proveedor.</p>
                        <div id="proposalsList">
                            <!-- Proposals will be loaded here -->
                        </div>
                        <div id="noProposals" class="empty-state" style="display: none;">
                            <div class="empty-icon">üìã</div>
                            <h4>No hay propuestas activas</h4>
                            <p>Crea la primera propuesta para este fondo</p>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div id="historyTab" class="tab-pane">
                        <h3>üìú Historial de Propuestas</h3>
                        <p class="tab-description">Todas las propuestas: ejecutadas, canceladas y expiradas</p>
                        <div id="historyList">
                            <!-- History will be loaded here -->
                        </div>
                        <div id="noHistory" class="empty-state" style="display: none;">
                            <div class="empty-icon">üìã</div>
                            <h4>No hay historial a√∫n</h4>
                            <p>El historial de propuestas aparecer√° aqu√≠</p>
                        </div>
                    </div>

                    <!-- Balances Tab -->
                    <div id="balancesTab" class="tab-pane">
                        <h3>‚öñÔ∏è Balances del Grupo</h3>
                        <p class="tab-description">C√°lculo autom√°tico de qui√©n debe dinero a qui√©n basado en aportes y gastos ejecutados.</p>
                        
                        <div class="balances-summary">
                            <div class="balance-stat-card positive">
                                <div class="balance-stat-icon">üí∞</div>
                                <div class="balance-stat-content">
                                    <span class="balance-stat-label">Total Aportado</span>
                                    <span class="balance-stat-value" id="totalContributed">0 ETH</span>
                                </div>
                            </div>
                            <div class="balance-stat-card negative">
                                <div class="balance-stat-icon">üí∏</div>
                                <div class="balance-stat-content">
                                    <span class="balance-stat-label">Total Gastado</span>
                                    <span class="balance-stat-value" id="totalSpent">0 ETH</span>
                                </div>
                            </div>
                            <div class="balance-stat-card neutral">
                                <div class="balance-stat-icon">üìä</div>
                                <div class="balance-stat-content">
                                    <span class="balance-stat-label">Balance Disponible</span>
                                    <span class="balance-stat-value" id="availableBalance">0 ETH</span>
                                </div>
                            </div>
                        </div>

                        <div class="info-box" style="margin: 1.5rem 0;">
                            <p><strong>üí° C√≥mo se calculan los balances:</strong></p>
                            <ul>
                                <li><strong>Parte justa de cada uno</strong> = Total gastado √∑ N√∫mero de miembros</li>
                                <li><strong>Balance personal</strong> = Lo que aportaste - Tu parte justa</li>
                                <li><strong>Positivo (verde)</strong> = Otros te deben dinero</li>
                                <li><strong>Negativo (rojo)</strong> = Debes dinero al grupo</li>
                                <li><strong>Cero (gris)</strong> = Est√°s equilibrado</li>
                            </ul>
                        </div>

                        <div id="balancesList">
                            <!-- Balances will be loaded here -->
                        </div>
                        
                        <div id="noBalances" class="empty-state" style="display: none;">
                            <div class="empty-icon">‚öñÔ∏è</div>
                            <h4>No hay gastos ejecutados a√∫n</h4>
                            <p>Los balances se calcular√°n cuando haya gastos aprobados y ejecutados</p>
                        </div>
                    </div>

                    <!-- Members Tab -->
                    <div id="membersTab" class="tab-pane">
                        <h3>üë• Miembros del Fondo</h3>
                        <div id="membersList">
                            <!-- Members will be loaded here -->
                        </div>
                        <div id="noMembers" class="empty-state" style="display: none;">
                            <div class="empty-icon">üë§</div>
                            <h4>No hay miembros a√∫n</h4>
                        </div>
                    </div>

                    <!-- Manage Tab -->
                    <div id="manageTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>‚öôÔ∏è Gesti√≥n del Fondo</h3>
                            <p>Opciones avanzadas para administrar el fondo.</p>
                            
                            <div class="manage-section">
                                <div class="danger-zone">
                                    <h4>üö® Zona de Peligro</h4>
                                    <p><strong>Cerrar y Distribuir Fondo</strong></p>
                                    <p class="help-text">
                                        Esta acci√≥n cerrar√° permanentemente el fondo y distribuir√° todos los fondos restantes 
                                        proporcionalmente entre los contribuyentes seg√∫n su aportaci√≥n.
                                    </p>
                                    
                                    <div class="info-box warning-box">
                                        <p><strong>‚ö†Ô∏è Advertencia:</strong></p>
                                        <ul>
                                            <li>Esta acci√≥n es <strong>irreversible</strong></li>
                                            <li>Solo el creador del fondo puede ejecutarla</li>
                                            <li>Cada contribuyente recibir√°: (su aportaci√≥n / total) √ó balance actual</li>
                                            <li>El fondo quedar√° cerrado permanentemente</li>
                                            <li>No se podr√°n hacer m√°s dep√≥sitos ni propuestas</li>
                                        </ul>
                                    </div>
                                    
                                    <div id="closeFundPreview" class="distribution-preview" style="display: none;">
                                        <h5>üìä Vista Previa de Distribuci√≥n</h5>
                                        <div id="distributionList"></div>
                                    </div>
                                    
                                    <div class="button-group">
                                        <button id="previewCloseFundBtn" class="btn btn-secondary">
                                            üìä Vista Previa de Distribuci√≥n
                                        </button>
                                        <button id="closeFundBtn" class="btn btn-danger">
                                            üîí Cerrar y Distribuir Fondo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </section>

            <!-- Create Fund Modal -->
            <div id="createFundModal" class="modal" style="display: none;">
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h2>‚ûï Crear Nuevo Grupo</h2>
                        <button class="modal-close" onclick="closeCreateFundModal()">&times;</button>
                    </div>
                    
                    <form id="createFundForm">
                        <!-- Fund Type Selection -->
                        <div class="form-group">
                            <label>Tipo de Grupo</label>
                            <div class="fund-type-grid">
                                <label class="fund-type-card">
                                    <input type="radio" name="fundType" value="0" checked>
                                    <div class="fund-type-content">
                                        <div class="fund-type-icon">üå¥</div>
                                        <h4>Viaje</h4>
                                        <p>Gastos de vacaciones</p>
                                    </div>
                                </label>
                                
                                <label class="fund-type-card">
                                    <input type="radio" name="fundType" value="1">
                                    <div class="fund-type-content">
                                        <div class="fund-type-icon">üí∞</div>
                                        <h4>Ahorro</h4>
                                        <p>Ahorrar juntos</p>
                                    </div>
                                </label>
                                
                                <label class="fund-type-card">
                                    <input type="radio" name="fundType" value="2">
                                    <div class="fund-type-content">
                                        <div class="fund-type-icon">ü§ù</div>
                                        <h4>Roommates</h4>
                                        <p>Gastos del hogar</p>
                                    </div>
                                </label>
                                
                                <label class="fund-type-card">
                                    <input type="radio" name="fundType" value="3">
                                    <div class="fund-type-content">
                                        <div class="fund-type-icon">üéØ</div>
                                        <h4>Otro</h4>
                                        <p>Prop√≥sito personalizado</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Fund Details -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fundName">Nombre del Grupo *</label>
                                <input 
                                    type="text" 
                                    id="fundName" 
                                    placeholder="Ej: Viaje a Canc√∫n 2025"
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="targetAmount">Meta / Presupuesto (ETH) - Opcional</label>
                                <input 
                                    type="number" 
                                    id="targetAmount" 
                                    placeholder="0"
                                    step="0.01"
                                    min="0"
                                    value="0"
                                >
                                <small>Deja en 0 para gastos sin l√≠mite, o establece un presupuesto</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="fundDescription">Descripci√≥n</label>
                            <textarea 
                                id="fundDescription" 
                                rows="3"
                                placeholder="Ej: Viaje a Canc√∫n 2025, Gastos del depa 304, Fiesta de aniversario..."
                            ></textarea>
                        </div>

                        <!-- Privacy Settings -->
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="isPrivate" checked>
                                <span>Grupo Privado (requiere invitaci√≥n)</span>
                            </label>
                            <small>Los grupos privados requieren que invites a cada miembro</small>
                        </div>

                        <!-- Governance Settings -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="approvalPercentage">% de Aprobaci√≥n *</label>
                                <input 
                                    type="number" 
                                    id="approvalPercentage" 
                                    value="60"
                                    min="1"
                                    max="100"
                                    required
                                >
                                <small>% de votos a favor para aprobar gastos</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="minimumVotes">M√≠nimo de Votos *</label>
                                <input 
                                    type="number" 
                                    id="minimumVotes" 
                                    value="2"
                                    min="1"
                                    required
                                >
                                <small>Votos m√≠nimos para aprobar un gasto</small>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeCreateFundModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <span class="btn-icon">üöÄ</span>
                                <span>Crear Fondo</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- Scripts -->
    <script src="ethers.umd.min.js"></script>
    <script src="app-platform.js"></script>
</body>
</html>
