<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8G443F7LPT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('consent', 'default', {
            'analytics_storage': 'denied'
        });
        gtag('config', 'G-8G443F7LPT');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://www.gstatic.com https://apis.google.com https://*.firebaseio.com https://www.googletagmanager.com https://*.google-analytics.com https://js.stripe.com;
        script-src-elem 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://www.gstatic.com https://apis.google.com https://*.firebaseio.com https://www.googletagmanager.com https://*.google-analytics.com https://js.stripe.com;
        style-src 'self' 'unsafe-inline'; 
        img-src 'self' data: https:; 
        media-src 'self' blob:;
        font-src 'self' https://fonts.gstatic.com;
        frame-src 'self' https://*.firebaseapp.com https://*.firebaseio.com https://accounts.google.com https://js.stripe.com https://checkout.stripe.com;
        connect-src 'self' http://127.0.0.1:8545 http://localhost:8545 https://*.base.org https://*.polygon.technology https://polygon-rpc.com https://*.basescan.org https://*.polygonscan.com wss://*.base.org wss://*.polygon.technology https://*.walletconnect.com wss://*.walletconnect.com https://cdn.jsdelivr.net https://*.coinbase.com https://chain-proxy.wallet.coinbase.com wss://*.walletlink.org https://*.walletlink.org https://www.gstatic.com https://*.firebaseio.com wss://*.firebaseio.com https://*.googleapis.com https://*.cloudfunctions.net https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://apis.google.com https://accounts.google.com https://api.exchangerate-api.com https://api.openai.com https://www.googletagmanager.com https://*.google-analytics.com https://api.stripe.com;
    ">
    <title>Ant Pool - Cooperative Finance Colony</title>
    <meta name="description" content="Work together like ants. Share expenses the simple way or use blockchain for automatic payments. Your choice.">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ant Pool">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <link rel="stylesheet" href="styles-platform.css">
    <link rel="stylesheet" href="wallet-connector.css">
    <link rel="stylesheet" href="create-group-styles.css">
    <link rel="stylesheet" href="simple-mode-styles.css">
    <link rel="stylesheet" href="form-wizard-styles.css">
    <link rel="stylesheet" href="new-features-styles.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Stripe Pricing Table -->
    <script async src="https://js.stripe.com/v3/pricing-table.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText" class="loading-text">Cargando...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- PWA Install Prompt -->
    <div id="pwaInstallPrompt" class="pwa-install-prompt" style="display: none;">
        <div class="pwa-install-content">
            <div class="pwa-install-icon">📱</div>
            <div class="pwa-install-text">
                <strong>Install Ant Pool</strong>
                <p>Get the full app experience with offline access</p>
            </div>
            <div class="pwa-install-actions">
                <button id="installPWAButton" class="btn btn-primary btn-sm">
                    <span>Install</span>
                </button>
                <button id="dismissPWAPrompt" class="btn btn-ghost btn-sm">
                    <span>×</span>
                </button>
            </div>
        </div>
    </div>

        <!-- Sign In Modal (for Simple Mode) -->
    <div id="signInModal" class="modal" style="display: none;">
        <div class="modal-content modal-auth">
            <button class="modal-close" onclick="closeSignInModal()">&times;</button>
            
            <div class="auth-container">
                <!-- Left Side - Branding -->
                <div class="auth-brand">
                    <div class="brand-content">
                        <div class="brand-icon"></div>
                        <h1 class="brand-title">Ant Pool</h1>
                        <p class="brand-subtitle">Track expenses with your team.<br>Simple, fast, and free.</p>
                        <div class="brand-features">
                            <div class="feature-item">
                                <span class="feature-icon"></span>
                                <span>Split expenses easily</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon"></span>
                                <span>Real-time tracking</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon"></span>
                                <span>Secure & private</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side - Sign In Form -->
                <div class="auth-form-container">
                    <div class="auth-form-content">
                        <h2 class="auth-title">Get Started</h2>
                        <p class="auth-description">Choose your preferred sign-in method</p>
                        
                        <!-- Main Sign In Options -->
                        <div id="mainSignInOptions" class="auth-options">
                            <button class="auth-btn auth-btn-google" onclick="signInWithGoogleOnly()">
                                <svg class="auth-btn-icon" viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <span class="auth-btn-text">Continue with Google</span>
                            </button>
                            
                            <button class="auth-btn auth-btn-email" onclick="showEmailSignIn()">
                                <span class="auth-btn-icon"></span>
                                <span class="auth-btn-text">Sign in with Email</span>
                            </button>
                            
                            <!-- Advanced Options Toggle -->
                            <div class="auth-divider">
                                <span>Advanced Options</span>
                            </div>
                            
                            <details class="auth-advanced">
                                <summary class="auth-advanced-summary">
                                    <span class="advanced-icon"></span>
                                    <span class="advanced-text">Blockchain Mode</span>
                                    <span class="advanced-badge">Optional</span>
                                    <span class="advanced-arrow"></span>
                                </summary>
                                <div class="auth-advanced-content">
                                    <p class="advanced-description">
                                        Connect your MetaMask wallet for automatic on-chain payments and settlements.
                                    </p>
                                    <button class="auth-btn auth-btn-metamask" onclick="signInWithWallet()">
                                        <span class="auth-btn-icon"></span>
                                        <span class="auth-btn-text">Connect MetaMask</span>
                                    </button>
                                    <p class="advanced-note">Requires MetaMask extension</p>
                                </div>
                            </details>
                        </div>
                        
                        <!-- Email Sign In Form (Hidden by default) -->
                        <div id="emailSignInForm" style="display: none;">
                            <form onsubmit="handleEmailSignIn(event)">
                                <div class="form-group">
                                    <label for="signInEmail">Email Address</label>
                                    <input type="email" id="signInEmail" class="input-modern" required placeholder="your@email.com">
                                </div>
                                <div class="form-group">
                                    <label for="signInPassword">Password</label>
                                    <input type="password" id="signInPassword" class="input-modern" required placeholder="">
                                </div>
                                <button type="submit" class="auth-btn auth-btn-primary" style="width: 100%;">
                                    Sign In
                                </button>
                                <button type="button" class="btn btn-link" onclick="showCreateAccount()">
                                    Create new account
                                </button>
                                <button type="button" class="btn btn-link" onclick="closeEmailSignIn()">
                                     Back to options
                                </button>
                            </form>
                        </div>
                        
                        <!-- Create Account Form (Hidden by default) -->
                        <div id="createAccountForm" style="display: none;">
                            <form onsubmit="handleCreateAccount(event)">
                                <div class="form-group">
                                    <label for="createName">Display Name</label>
                                    <input type="text" id="createName" class="input-modern" required placeholder="Your Name">
                                </div>
                                <div class="form-group">
                                    <label for="createEmail">Email Address</label>
                                    <input type="email" id="createEmail" class="input-modern" required placeholder="your@email.com">
                                </div>
                                <div class="form-group">
                                    <label for="createPassword">Password</label>
                                    <input type="password" id="createPassword" class="input-modern" required minlength="6" placeholder="Minimum 6 characters">
                                </div>
                                <button type="submit" class="auth-btn auth-btn-primary" style="width: 100%;">
                                    Create Account
                                </button>
                                <button type="button" class="btn btn-link" onclick="showEmailSignIn()">
                                     Back to Sign In
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="container">
            <div class="header-content">
                <!-- Logo Section -->
                <div class="logo" onclick="goToHome()" style="cursor: pointer;" title="Go to Home">
                    <h1>
                        <img src="/assets/LogoAntPool.png" alt="Ant Pool" style="height: 36px; vertical-align: middle; margin-right: 10px;">
                        Ant Pool
                    </h1>
                    <span class="version-badge">🐜 Simple Mode or Blockchain - You Choose</span>
                </div>
                
                <!-- Header Actions Section -->
                <div class="header-actions">
                    <!-- Action Buttons Group -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <!-- Upgrade PRO Button -->
                        <button id="upgradeProBtn" class="upgrade-pro-btn" onclick="openProfilePanel(); setTimeout(() => switchProfileTab('subscription'), 100);" title="Upgrade to PRO">
                            <span>💎</span>
                            <span class="upgrade-text">PRO</span>
                        </button>
                        
                        <!-- Notifications -->
                        <button id="notificationsBtn" class="notifications-btn" onclick="toggleNotificationsPanel()" title="Notifications">
                            <span class="bell-icon">🔔</span>
                            <span id="notificationBadge" class="notification-badge hidden">0</span>
                        </button>
                        
                        <!-- Settings -->
                        <button class="settings-btn-app" onclick="openAppSettings()" title="Settings">⚙️</button>
                        
                        <!-- Unified User Menu Button -->
                        <div class="user-menu-container">
                            <button id="userMenuBtn" class="user-menu-btn" onclick="toggleUserMenu()" title="Account">
                                <div class="user-menu-avatar">
                                    <span id="userMenuIcon">👤</span>
                                </div>
                                <div class="user-menu-info">
                                    <div id="userMenuName" class="user-menu-name">Sign In</div>
                                    <div id="userMenuStatus" class="user-menu-status"></div>
                                </div>
                                <span class="user-menu-arrow">▼</span>
                            </button>
                            
                            <!-- Dropdown Menu -->
                            <div id="userMenuDropdown" class="user-menu-dropdown" style="display: none;">
                                <!-- Sign In Option (shown when not authenticated) -->
                                <div id="menuSignInOption" class="menu-section" style="display: none;">
                                    <button class="menu-item" onclick="showSignInModal(); closeUserMenu();">
                                        <span class="menu-icon">🔐</span>
                                        <div class="menu-content">
                                            <div class="menu-title">Sign In</div>
                                            <div class="menu-desc">Access Simple Mode</div>
                                        </div>
                                    </button>
                                </div>
                                
                                <!-- User Info Section (shown when authenticated) -->
                                <div id="menuUserInfo" class="menu-section" style="display: none;">
                                    <div class="menu-header">
                                        <div class="menu-header-avatar">
                                            <span id="menuUserAvatar">👤</span>
                                        </div>
                                        <div class="menu-header-info">
                                            <div id="menuUserDisplayName" class="menu-header-name"></div>
                                            <div id="menuUserEmail" class="menu-header-email"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Wallet Info Section (shown when wallet connected) -->
                                <div id="menuWalletInfo" class="menu-section" style="display: none;">
                                    <div class="menu-item-static">
                                        <span class="menu-icon">🦊</span>
                                        <div class="menu-content">
                                            <div class="menu-title">Wallet Connected</div>
                                            <div id="menuWalletAddress" class="menu-desc wallet-address"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="menu-divider"></div>
                                
                                <!-- Profile Option -->
                                <button class="menu-item" onclick="openProfilePanel(); closeUserMenu();">
                                    <span class="menu-icon">👤</span>
                                    <div class="menu-content">
                                        <div class="menu-title">My Profile</div>
                                    </div>
                                </button>
                                
                                <div class="menu-divider"></div>
                                
                                <!-- Sign Out Options -->
                                <div id="menuSignOutFirebase" class="menu-section" style="display: none;">
                                    <button id="signOutFirebase" class="menu-item menu-item-danger" onclick="signOutFromFirebase(); closeUserMenu();">
                                        <span class="menu-icon">🚪</span>
                                        <div class="menu-content">
                                            <div class="menu-title">Sign Out</div>
                                            <div class="menu-desc">From Simple Mode</div>
                                        </div>
                                    </button>
                                </div>
                                
                                <div id="menuDisconnectWallet" class="menu-section" style="display: none;">
                                    <button id="disconnectWallet" class="menu-item menu-item-danger" onclick="closeUserMenu();">
                                        <span class="menu-icon">🔌</span>
                                        <div class="menu-content">
                                            <div class="menu-title">Disconnect Wallet</div>
                                            <div class="menu-desc">From Blockchain Mode</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Notification Banner (Main Page) -->
    <div id="notificationBanner" class="notification-banner hidden">
        <div class="notification-banner-content">
            <span class="notification-banner-icon">🔔</span>
            <span id="notificationBannerText">You have unread notifications</span>
            <button class="notification-banner-btn" onclick="event.stopPropagation(); toggleNotificationsPanel();">View</button>
            <button class="notification-banner-close" onclick="event.stopPropagation(); closeNotificationBanner();">&times;</button>
        </div>
    </div>

    <!-- Notifications Panel -->
    <div id="notificationsPanel" class="notifications-panel hidden">
        <div class="notifications-header">
            <h3>🔔 Notifications</h3>
            <div class="notifications-header-actions">
                <button class="btn-text" onclick="markAllNotificationsAsRead()" id="markAllReadBtn" style="display: none;">Mark all as read</button>
                <button class="btn-text" onclick="deleteAllNotifications()" id="deleteAllBtn" title="Delete all notifications">🗑️</button>
                <button id="closeNotificationsBtn" class="btn-icon-close">&times;</button>
            </div>
        </div>
        <div id="emptyNotifications" class="empty-notifications hidden">
            <span class="empty-icon">🔕</span>
            <p>No notifications yet</p>
        </div>
        <div id="notificationsList" class="notifications-list">
        </div>
    </div>

    <!-- Profile Panel -->
    <div id="profilePanel" class="profile-panel hidden">
        <div class="profile-panel-overlay" onclick="closeProfilePanel()"></div>
        <div class="profile-panel-content">
            <!-- Header -->
            <div class="profile-header">
                <div class="profile-header-top">
                    <h2>👤 My Profile</h2>
                    <button class="btn-icon-close" onclick="closeProfilePanel()">&times;</button>
                </div>
                <div class="profile-user-info">
                    <div class="profile-avatar" id="profileAvatar">
                        <span id="profileAvatarText">U</span>
                    </div>
                    <div class="profile-details">
                        <h3 id="profileUserName">User Name</h3>
                        <p id="profileUserEmail">user@email.com</p>
                        <div class="profile-badges">
                            <span class="profile-badge" id="profileAuthBadge">
                                <span class="badge-icon">🔐</span>
                                <span class="badge-text">Firebase Auth</span>
                            </span>
                            <span class="profile-badge" id="profileWalletBadge" style="display: none;">
                                <span class="badge-icon">🦊</span>
                                <span class="badge-text" id="profileWalletText">Not Connected</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="profile-stats">
                <div class="profile-stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-info">
                        <div class="stat-value" id="profileStatsGroups">0</div>
                        <div class="stat-label">Groups</div>
                    </div>
                </div>
                <div class="profile-stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-info">
                        <div class="stat-value" id="profileStatsExpenses">$0</div>
                        <div class="stat-label">Total Spent</div>
                    </div>
                </div>
                <div class="profile-stat-card">
                    <div class="stat-icon">🧾</div>
                    <div class="stat-info">
                        <div class="stat-value" id="profileStatsTransactions">0</div>
                        <div class="stat-label">Transactions</div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="profile-tabs">
                <button class="profile-tab active" data-tab="overview" onclick="switchProfileTab('overview')">
                    <span>📊</span> Overview
                </button>
                <button class="profile-tab" data-tab="groups" onclick="switchProfileTab('groups')">
                    <span>👥</span> Groups
                </button>
                <button class="profile-tab" data-tab="subscription" onclick="switchProfileTab('subscription')">
                    <span>💎</span> Plan
                </button>
                <button class="profile-tab" data-tab="settings" onclick="switchProfileTab('settings')">
                    <span>⚙️</span> Settings
                </button>
            </div>

            <!-- Tab Contents -->
            <div class="profile-tab-content">
                <!-- Overview Tab -->
                <div id="profileTabOverview" class="profile-tab-panel active">
                    <div class="profile-section">
                        <h4>Account Information</h4>
                        <div class="profile-info-grid">
                            <div class="profile-info-item">
                                <label>Email</label>
                                <span id="profileInfoEmail">-</span>
                            </div>
                            <div class="profile-info-item">
                                <label>Member Since</label>
                                <span id="profileInfoMemberSince">-</span>
                            </div>
                            <div class="profile-info-item">
                                <label>Last Login</label>
                                <span id="profileInfoLastLogin">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h4>Recent Activity</h4>
                        <div id="profileRecentActivity" class="profile-activity-list">
                            <p class="empty-state-text">No recent activity</p>
                        </div>
                    </div>
                </div>

                <!-- Groups Tab -->
                <div id="profileTabGroups" class="profile-tab-panel">
                    <div class="profile-section">
                        <div class="section-header">
                            <h4>My Groups</h4>
                            <button class="btn btn-sm btn-primary" onclick="closeProfilePanel(); document.getElementById('createFundBtn').click();">
                                <span>➕</span> New Group
                            </button>
                        </div>
                        <div id="profileGroupsList" class="profile-groups-list">
                            <p class="empty-state-text">No groups yet</p>
                        </div>
                    </div>
                </div>

                <!-- Subscription Tab -->
                <div id="profileTabSubscription" class="profile-tab-panel">
                    <div class="profile-section">
                        <div class="subscription-header">
                            <h4>🐜 Subscription Plans</h4>
                            <p>Unlock premium features and support Ant Pool development</p>
                        </div>
                        
                        <div class="subscription-plans">
                            <!-- FREE Plan -->
                            <div id="freePlanCard" class="subscription-card free-plan">
                                <div class="plan-badge current">CURRENT PLAN</div>
                                <div class="plan-icon">🆓</div>
                                <h3>Free</h3>
                                <div class="plan-price">
                                    <span class="price">$0</span>
                                    <span class="period">/month</span>
                                </div>
                                <p class="plan-description">Perfect for getting started</p>
                            </div>
                            
                            <!-- PRO Plan -->
                            <div id="proPlanCard" class="subscription-card pro-plan">
                                <div id="proPlanBadge" class="plan-badge recommended">RECOMMENDED</div>
                                <div class="plan-icon">💎</div>
                                <h3>PRO</h3>
                                <div class="plan-price">
                                    <span class="price">$2.99</span>
                                    <span class="period">/month</span>
                                </div>
                                <div class="plan-price-annual">
                                    or $29/year <span class="save-badge">Save 19%</span>
                                </div>
                                <p class="plan-description">Support development and get premium features</p>
                                
                                <!-- Stripe Checkout Button (shown when not subscribed) -->
                                <div id="stripeButtonContainer" class="stripe-button-container">
                                    <button class="btn btn-primary btn-block" onclick="openStripeCheckout()">
                                        💎 Subscribe to PRO - $2.99/month
                                    </button>
                                </div>
                                
                                <!-- Manage Subscription Button (shown when subscribed) -->
                                <div id="manageSubscriptionContainer" class="stripe-button-container" style="display: none;">
                                    <button class="btn btn-primary btn-block" onclick="openCustomerPortal()">
                                        ⚙️ Manage Subscription
                                    </button>
                                    <p id="subscriptionStatus" style="margin-top: 1rem; text-align: center; color: #43e97b; font-weight: 600;"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="subscription-footer">
                            <p>💡 Early adopters get lifetime discounts!</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="profileTabSettings" class="profile-tab-panel">
                    <div class="profile-section">
                        <h4>Preferences</h4>
                        <div class="settings-list">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <div class="setting-label">🌙 Dark Mode</div>
                                    <div class="setting-description">Toggle dark theme</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingDarkMode" onchange="toggleDarkModeSetting(this)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <div class="setting-label">🔔 Push Notifications</div>
                                    <div class="setting-description">Get alerts on your device</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingPushNotifications" onchange="togglePushNotifications(this)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <div class="setting-label">🔔 In-App Notifications</div>
                                    <div class="setting-description">Show notification panel</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="settingNotifications" checked onchange="toggleNotificationsSetting(this)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="profile-section">
                        <h4>Account Actions</h4>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-block" onclick="closeProfilePanel(); openAppSettings();">
                                <span>⚙️</span> App Settings
                            </button>
                            <button class="btn btn-secondary btn-block" onclick="exportUserData();">
                                <span>📥</span> Export My Data
                            </button>
                            <button class="btn btn-danger btn-block" onclick="confirmSignOut();">
                                <span>🚪</span> Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="appSettingsModal" class="modal-overlay" onclick="closeAppSettings(event)">
        <div class="settings-modal" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2><span class="settings-emoji">⚙️</span> <span class="settings-title-text">Settings</span></h2>
                <button class="close-btn" onclick="closeAppSettings()">&times;</button>
            </div>
            <div class="settings-content">
                <!-- Language Selection -->
                <div class="setting-group">
                    <label>🌍 Language</label>
                    <div class="setting-options">
                        <button class="setting-option" data-lang="en" onclick="changeLanguage('en')">
                            <span class="option-flag">🇺🇸</span>
                            <span>English</span>
                            <span class="option-check">✓</span>
                        </button>
                        <button class="setting-option" data-lang="es" onclick="changeLanguage('es')">
                            <span class="option-flag">🇪🇸</span>
                            <span>Español</span>
                            <span class="option-check">✓</span>
                        </button>
                    </div>
                </div>

                <!-- Theme Selection -->
                <div class="setting-group">
                    <label>🎨 Theme</label>
                    <div class="setting-options">
                        <button class="setting-option" data-theme="light" onclick="changeTheme('light')">
                            <span class="option-icon">☀️</span>
                            <span>Light Mode</span>
                            <span class="option-check">✓</span>
                        </button>
                        <button class="setting-option" data-theme="dark" onclick="changeTheme('dark')">
                            <span class="option-icon">🌙</span>
                            <span>Dark Mode</span>
                            <span class="option-check">✓</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="modal" style="display: none;">
        <div class="modal-content qr-scanner-modal">
            <div class="modal-header">
                <h3 id="qrScannerTitle">📷 Scan QR Code</h3>
                <button class="modal-close" id="closeQRScannerBtn1">&times;</button>
            </div>
            
            <div class="warning-box qr-warning">
                <p><strong id="qrWarningTitle">⚠️ IMPORTANT - Read carefully:</strong></p>
                <ul id="qrWarningList">
                    <li><strong>Base Network Only:</strong> The address MUST be a valid address on the <strong>Base blockchain</strong></li>
                    <li><strong>Verify carefully:</strong> If you send funds to an incorrect address, <strong>they will be lost forever</strong></li>
                    <li><strong>No refunds:</strong> Blockchain transactions are irreversible</li>
                    <li><strong>Your responsibility:</strong> Double-check that the address belongs to the intended recipient</li>
                </ul>
            </div>
            
            <div id="qrReader" class="qr-reader"></div>
            
            <div id="qrScanResult" style="display: none;">
                <div class="scan-result-box">
                    <p><strong id="qrDetectedLabel">✅ Address detected:</strong></p>
                    <div class="address-display">
                        <code id="scannedAddress"></code>
                    </div>
                </div>
                
                <div class="warning-box critical-warning">
                    <p><strong id="qrFinalConfirmTitle">🚨 FINAL CONFIRMATION</strong></p>
                    <p id="qrConfirmationText">By clicking "Confirm", you declare that:</p>
                    <ul id="qrConfirmationList">
                        <li>This address is correct and belongs to the intended recipient</li>
                        <li>This address is on the <strong>Base blockchain</strong></li>
                        <li>You understand that funds sent to an incorrect address <strong>cannot be recovered</strong></li>
                        <li>You assume full responsibility for this address</li>
                    </ul>
                    
                    <label class="checkbox-label">
                        <input type="checkbox" id="qrConfirmCheckbox">
                        <span id="qrCheckboxLabel">I have verified the address and accept full responsibility</span>
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="qrCancelBtn2">Cancel</button>
                    <button id="confirmQRBtn" class="btn btn-primary" disabled>
                        ✓ Confirm and Use Address
                    </button>
                </div>
            </div>
            
            <button id="cancelScanBtn" class="btn btn-secondary btn-block">
                Cancel Scan
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            
            <!-- Nickname Setup Modal (first time users) -->
            <div id="nicknameModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h2>👋 Welcome to Ant Pool!</h2>
                    <p>Share expenses simply or use blockchain for automatic payments. <strong>No wallet needed to start.</strong></p>
                    <p>First, set a <strong>nickname</strong> to identify yourself in groups.</p>
                    
                    <div class="form-group">
                        <label for="nicknameInput">Your Nickname *</label>
                        <input 
                            type="text" 
                            id="nicknameInput" 
                            placeholder="Ex: John, Maria123, etc."
                            minlength="3"
                            maxlength="32"
                            pattern="[a-zA-Z0-9]+"
                            required
                        >
                        <small>3-32 characters, letters and numbers only. It will identify you in all your groups.</small>
                    </div>
                    
                    <button id="setNicknameBtn" class="btn btn-primary btn-block">
                        Set Nickname and Continue
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="dashboard-section">
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <h3 id="totalGroupsCreated">0</h3>
                            <p>Groups Created</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">👥</div>
                        <div class="stat-content">
                            <h3 id="totalGroupsParticipating">0</h3>
                            <p>Active Groups</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">�</div>
                        <div class="stat-content">
                            <h3 id="totalGroupsJoined">0</h3>
                            <p>Groups Joined</p>
                        </div>
                    </div>
                </div>

                <!-- Pending Invitations Banner -->
                <div id="pendingInvitationsSection" class="pending-invitations-section" style="display: none;">
                    <div class="invitations-header">
                        <h3>🎫 Pending Invitations</h3>
                        <span class="invitations-count" id="invitationsCount">0</span>
                    </div>
                    <div id="invitationsList" class="invitations-list">
                        <!-- Invitations will be loaded here -->
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="action-bar">
                    <h2>My Groups</h2>
                    <button id="createFundBtn" class="btn btn-primary btn-create-group" title="Create a new expense group">
                        <span class="btn-icon">➕</span>
                        <span class="btn-text">
                            <strong>Create New Group</strong>
                            <small>Tap here to create group</small>
                        </span>
                    </button>
                </div>

                <!-- Fund Filters -->
                <div class="fund-filters">
                    <button class="filter-btn active" data-filter="all">
                        📋 All (<span id="countAll">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="created">
                        👑 Created by me (<span id="countCreated">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="participating">
                        👥 Member of (<span id="countParticipating">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="simple">
                        📝 Simple Mode (<span id="countSimple">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="blockchain">
                        ⛓️ Blockchain (<span id="countBlockchain">0</span>)
                    </button>
                </div>

                <!-- Search and Sort Bar -->
                <div class="search-sort-bar">
                    <div class="search-box-container">
                        <input 
                            type="text" 
                            id="groupSearchInput" 
                            class="search-input" 
                            placeholder="🔍 Search groups by name..."
                            onkeyup="filterAndSortGroups()"
                        />
                    </div>
                    <div class="sort-controls">
                        <label for="sortOrder" class="sort-label">Sort by:</label>
                        <select id="sortOrder" class="sort-select" onchange="filterAndSortGroups()">
                            <option value="recent">📅 Most Recent</option>
                            <option value="oldest">📅 Oldest First</option>
                            <option value="name-asc">🔤 A → Z</option>
                            <option value="name-desc">🔤 Z → A</option>
                        </select>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingGroups" class="loading-groups-state" style="display: none;">
                    <div class="loading-spinner"></div>
                    <h3>Loading your groups...</h3>
                    <p>Please wait while we fetch your expense groups</p>
                </div>

                <!-- Groups Grid -->
                <div id="groupsGrid" class="groups-grid">
                    <!-- Groups will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-icon">🚀</div>
                    <h3>Start your first adventure!</h3>
                    <p>Create your first group to manage shared expenses. <strong>No wallet needed</strong> - start with Simple Mode or use blockchain for automatic payments.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('createFundBtn').click()">
                        <span class="btn-icon">✨</span>
                        <span>Create My First Group</span>
                    </button>
                </div>

            </section>

            <!-- Fund Detail Section (Single Fund View) -->
            <section id="fundDetailSection" class="fund-detail-section">
                
                <!-- Fund Header with integrated back button and stats -->
                <div class="fund-detail-header">
                    <!-- Back Button -->
                    <button id="backToDashboard" class="back-button-integrated">
                        <span class="back-icon">←</span>
                        <span class="back-text">Back to My Groups</span>
                    </button>

                    <!-- Header Content -->
                    <div class="fund-header-content">
                        <div class="fund-header-icon" id="fundHeaderIcon">🌴</div>
                        <h1 id="fundDetailName" class="fund-header-title">Cargando...</h1>
                        <p id="fundDetailDescription" class="fund-header-description">-</p>
                        <div class="fund-badges">
                            <span class="badge" id="fundTypeBadge">Tipo</span>
                            <span class="badge" id="groupStatusBadge">Estado</span>
                        </div>
                    </div>

                    <!-- Integrated Stats -->
                    <div class="fund-stats-integrated">
                        <div class="fund-stat-card">
                            <div class="stat-icon">💰</div>
                            <div class="stat-content">
                                <span class="stat-label">Total Balance</span>
                                <span class="stat-value" id="fundBalanceMain">0 ETH</span>
                                <div class="stat-breakdown" id="fundBalanceBreakdown" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="fund-stat-card">
                            <div class="stat-icon">👥</div>
                            <div class="stat-content">
                                <span class="stat-label">Members</span>
                                <span class="stat-value" id="fundMembers">0</span>
                            </div>
                        </div>
                        <div class="fund-stat-card">
                            <div class="stat-icon">💸</div>
                            <div class="stat-content">
                                <span class="stat-label">Expenses</span>
                                <span class="stat-value" id="fundProposals">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invitation Banner (if pending) -->
                <div id="invitationBanner" class="invitation-banner" style="display: none;">
                    <div class="invitation-content">
                        <span class="invitation-icon">🎫</span>
                        <p>You have a pending invitation for this fund</p>
                    </div>
                    <button id="acceptInvitationBtn" class="btn btn-primary">
                        Accept Invitation
                    </button>
                </div>

                <!-- Closed Fund Banner -->
                <div id="closedFundBanner" class="closed-fund-banner" style="display: none;">
                    <div class="closed-fund-content">
                        <span class="closed-fund-icon">🔒</span>
                        <div>
                            <h4>Closed Group</h4>
                            <p>This group has been permanently closed. Balances were settled proportionally among all members.</p>
                        </div>
                    </div>
                </div>

                <!-- Fund Tabs -->
                <div class="fund-tabs">
                    <button class="fund-tab-btn active" data-tab="deposit">
                        <span class="tab-icon">💵</span>
                        <span>Deposit</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="invite">
                        <span class="tab-icon">🎫</span>
                        <span>Invite</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="propose">
                        <span class="tab-icon">📝</span>
                        <span>Propose</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="vote">
                        <span class="tab-icon">🗳️</span>
                        <span>Vote</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="history">
                        <span class="tab-icon">📜</span>
                        <span>History</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="balances">
                        <span class="tab-icon">⚖️</span>
                        <span>Balances</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="members">
                        <span class="tab-icon">👥</span>
                        <span>Members</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="manage">
                        <span class="tab-icon">⚙️</span>
                        <span>Manage</span>
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="fund-tab-content">
                    
                    <!-- Deposit Tab -->
                    <div id="depositTab" class="tab-pane active">
                        <div class="tab-card">
                            <h3>💰 Contribute to the Pot</h3>
                            <p>Deposit money to the group. Useful for future expenses or to balance contributions.</p>
                            
                            <div class="form-group">
                                <label for="depositAmount">Amount to Deposit (ETH)</label>
                                <input type="number" id="depositAmount" placeholder="0.0" step="0.01" min="0.01">
                            </div>
                            
                            <div class="contribution-info">
                                <span>Your current contribution: <strong id="userContribution">0 ETH</strong></span>
                            </div>
                            
                            <button id="depositBtn" class="btn btn-primary btn-block">
                                Deposit to Pot
                            </button>
                        </div>
                    </div>

                    <!-- Invite Tab -->
                    <div id="inviteTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>🎫 Invite Members</h3>
                            <p>Invite friends to join the group. They must accept the invitation.</p>
                            
                            <div class="invite-info-box">
                                <p><strong>ℹ️ Information:</strong></p>
                                <ul>
                                    <li>Only the group creator can invite</li>
                                    <li>Invitees will see the invitation in their dashboard</li>
                                    <li>They must accept before they can register expenses</li>
                                    <li>You cannot invite yourself</li>
                                </ul>
                            </div>
                            
                            <div class="form-group">
                                <label for="inviteAddress">Nickname or Address</label>
                                <input type="text" id="inviteAddress" placeholder="E.g: Bob or 0x123...">
                                <small>Enter the user's nickname or their Ethereum address</small>
                            </div>
                            
                            <button id="inviteBtn" class="btn btn-primary btn-block">
                                Send Invitation
                            </button>
                        </div>
                    </div>

                    <!-- Propose Tab -->
                    <div id="proposeTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>📝 Propose Expense</h3>
                            <p>Propose using money from the common pot to pay an external provider. The group will vote whether to approve.</p>
                            
                            <div class="info-box">
                                <p><strong>💡 How it works:</strong></p>
                                <ul>
                                    <li>Propose paying an expense from the common pot (hotel, restaurant, etc.)</li>
                                    <li>Indicate who will be paid (external provider with their address)</li>
                                    <li>The group votes whether to approve or reject using money from the pot</li>
                                    <li>If approved, the money is sent directly from the pot to the provider</li>
                                </ul>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalRecipient">Who will be paid (Provider's address)</label>
                                <div class="input-with-button">
                                    <input type="text" id="proposalRecipient" placeholder="0x123... (hotel, restaurant, etc. address)">
                                    <button type="button" id="openQRScannerBtn" class="btn-qr-scan" title="Scan QR Code">
                                        📷
                                    </button>
                                </div>
                                <small>Ethereum address of the external agent who will receive payment</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalAmount">Amount to Pay (ETH)</label>
                                <input type="number" id="proposalAmount" placeholder="0.0" step="0.01" min="0.01">
                                <small>Amount that will be paid from the common pot to the provider</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalDescription">Expense Description</label>
                                <textarea id="proposalDescription" rows="3" placeholder="E.g: 3-night hotel in Cancun - Payment to Marriott, Group dinner at La Costa Restaurant..."></textarea>
                                <small>Explain the reason for the expense and who will be paid</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="involvedMembers">Who is involved in this expense?</label>
                                <div class="info-box warning" style="margin-bottom: 1rem; background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3);">
                                    <p><strong>⚠️ IMPORTANTE:</strong></p>
                                    <ul style="margin: 0.5rem 0 0 1.2rem; font-size: 0.9rem;">
                                        <li><strong>Only selected members can vote!</strong></li>
                                        <li>Make sure to check YOUR OWN checkbox if you want to vote</li>
                                        <li>If you uncheck yourself, you won't be able to vote on your own proposal</li>
                                    </ul>
                                </div>
                                <div class="info-box" style="margin-bottom: 1rem; background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3);">
                                    <p><strong>💡 Flexible Bill Splitting:</strong></p>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                        Use the <strong>+</strong> and <strong>−</strong> buttons to add extra portions when a member covers for people outside the group. 
                                        For example: if your sister brings 2 friends, add 3 portions (her + 2 friends) and the expense will be split counting her 3 times.
                                    </p>
                                </div>
                                <div class="members-selection-actions">
                                    <button type="button" id="selectAllMembersBtn" class="btn-select-action">
                                        ✓ Select All
                                    </button>
                                    <button type="button" id="deselectAllMembersBtn" class="btn-select-action">
                                        ✗ Deselect All
                                    </button>
                                </div>
                                <div id="involvedMembersList" class="members-checkbox-list">
                                    <!-- Member checkboxes will be loaded here -->
                                </div>
                                <small>Select the members who will share this expense. Use the +/− buttons to adjust how many portions of the expense correspond to each member.</small>
                            </div>
                            
                            <button id="createProposalBtn" class="btn btn-primary btn-block">
                                📝 Propose Settlement
                            </button>
                        </div>
                    </div>

                    <!-- Vote Tab -->
                    <div id="voteTab" class="tab-pane">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3>🗳️ Vote on Proposals</h3>
                                <p class="tab-description">Settlement proposals. Vote whether you approve or reject each payment.</p>
                            </div>
                            <button onclick="refreshCurrentView()" class="btn btn-secondary" style="height: fit-content;" title="Refresh proposals from blockchain">
                                🔄 Refresh
                            </button>
                        </div>
                        <div id="proposalsList">
                            <!-- Proposals will be loaded here -->
                        </div>
                        <div id="noProposals" class="empty-state" style="display: none;">
                            <div class="empty-icon">📋</div>
                            <h4>No active proposals</h4>
                            <p>Create the first proposal for this fund</p>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div id="historyTab" class="tab-pane">
                        <!-- Simple Mode: Add Expense Action Card -->
                        <div id="simpleAddExpenseCard" class="action-card" style="display: none;">
                            <div class="action-card-content">
                                <div class="action-card-icon">💸</div>
                                <div class="action-card-text">
                                    <h4>Register an Expense</h4>
                                    <p>Track shared expenses with your group. Split costs fairly and keep everyone in sync.</p>
                                </div>
                                <button id="addExpenseCardBtn" class="btn btn-primary btn-large btn-add-expense" title="Click to add a new expense">
                                    <span class="btn-icon">💵</span>
                                    <span class="btn-text">
                                        <strong>Add Expense</strong>
                                        <small>Click to add new payment</small>
                                    </span>
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions for New Features -->
                        <div id="simpleQuickActions" class="quick-actions-compact" style="display: none; margin-bottom: 1rem;">
                            <button class="quick-action-btn-compact" onclick="showRecurringExpenseModal()" title="Set up recurring expenses like rent or subscriptions">
                                <span class="quick-icon">🔄</span>
                                <span class="quick-label">Recurring</span>
                            </button>
                            
                            <button class="quick-action-btn-compact" onclick="showBudgetModal()" title="Set spending limits and get alerts">
                                <span class="quick-icon">💰</span>
                                <span class="quick-label">Budget</span>
                            </button>
                            
                            <button class="quick-action-btn-compact" onclick="showAnalyticsModal()" title="View spending analytics and insights">
                                <span class="quick-icon">📊</span>
                                <span class="quick-label">Analytics</span>
                            </button>
                            
                            <button class="quick-action-btn-compact" onclick="showOpenAIConfigModal()" title="Configure OpenAI for receipt scanning">
                                <span class="quick-icon">🔑</span>
                                <span class="quick-label">AI Setup</span>
                            </button>
                        </div>

                        <!-- Budget Status Bar (if budget is set) -->
                        <div id="budgetStatusBar" style="display: none; margin-bottom: 1.5rem;">
                            <div class="collapsible-header" onclick="toggleCollapsible('budgetContent')" style="background: rgba(255,255,255,0.05); padding: 1rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s ease;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem;">💰</span>
                                    <strong style="font-size: 1rem;">Budget Tracker</strong>
                                </div>
                                <span id="budgetContentToggle" style="font-size: 1.2rem; transition: transform 0.3s ease;">▼</span>
                            </div>
                            <div id="budgetContent" class="collapsible-content" style="display: none; margin-top: 0.5rem;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- Active Recurring Expenses -->
                        <div id="recurringExpensesSection" style="display: none; margin-bottom: 1.5rem;">
                            <div class="collapsible-header" onclick="toggleCollapsible('recurringContent')" style="background: rgba(255,255,255,0.05); padding: 1rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s ease;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem;">🔄</span>
                                    <strong style="font-size: 1rem;">Active Recurring Expenses</strong>
                                    <span id="recurringCount" class="badge-count" style="background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">0</span>
                                </div>
                                <span id="recurringContentToggle" style="font-size: 1.2rem; transition: transform 0.3s ease;">▼</span>
                            </div>
                            <div id="recurringContent" class="collapsible-content" style="display: none; margin-top: 0.5rem;">
                                <div style="text-align: right; margin-bottom: 0.75rem;">
                                    <button class="btn btn-secondary btn-small" onclick="showManageRecurringModal()" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                                        📋 View All
                                    </button>
                                </div>
                                <div id="recurringExpensesList" class="recurring-list">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <h3>📜 Proposal History</h3>
                        <p class="tab-description">All proposals: executed, cancelled and expired</p>
                        
                        <!-- Expense Search Filter - Collapsible -->
                        <div id="expenseSearchSection" style="display: none; margin-bottom: 1rem;">
                            <div class="collapsible-header" onclick="toggleCollapsible('searchContent')" style="background: rgba(255,255,255,0.05); padding: 1rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s ease;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem;">🔍</span>
                                    <strong style="font-size: 1rem;">Search & Filter</strong>
                                </div>
                                <span id="searchContentToggle" style="font-size: 1.2rem; transition: transform 0.3s ease;">▼</span>
                            </div>
                            <div id="searchContent" class="collapsible-content" style="display: none; margin-top: 0.5rem;">
                                <div class="expense-search-section">
                                    <div class="search-filters">
                                        <div class="search-input-wrapper">
                                            <input type="text" 
                                                   id="expenseSearchInput" 
                                                   class="search-input" 
                                                   placeholder="🔍 Search by name..." 
                                                   onkeyup="filterExpenses()">
                                        </div>
                                        <div class="date-filters-row">
                                            <div class="date-filter-group">
                                                <label class="filter-label">From:</label>
                                                <input type="date" 
                                                       id="expenseFilterStart" 
                                                       class="date-filter-input" 
                                                       onchange="filterExpenses()">
                                            </div>
                                            <div class="date-filter-group">
                                                <label class="filter-label">To:</label>
                                                <input type="date" 
                                                       id="expenseFilterEnd" 
                                                       class="date-filter-input" 
                                                       onchange="filterExpenses()">
                                            </div>
                                            <button class="btn-clear-filters" onclick="clearExpenseFilters()" title="Clear filters">
                                                ✕
                                            </button>
                                        </div>
                                        <div class="filter-checkbox-row" style="margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <label class="filter-checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                                <input type="checkbox" id="expenseFilterMyExpenses" onchange="filterExpenses()" style="cursor: pointer;">
                                                <span>🙋 Only my expenses (where I'm involved)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="historyList">
                            <!-- History will be loaded here -->
                        </div>
                        <div id="noHistory" class="empty-state" style="display: none;">
                            <div class="empty-icon">📋</div>
                            <h4>No history yet</h4>
                            <p>Proposal history will appear here</p>
                        </div>
                    </div>

                    <!-- Balances Tab -->
                    <div id="balancesTab" class="tab-pane">
                        <div class="balances-header-simple">
                            <h3>⚖️ Group Balances</h3>
                            <p class="tab-description">See who owes money and who is owed based on shared expenses</p>
                        </div>

                        <!-- Date Filter for Timeline -->
                        <div id="timelineFilterSection" class="timeline-filter-section" style="display: none;">
                            <div class="filter-header">
                                <h4>📅 Expense Timeline</h4>
                                <button class="toggle-timeline-btn" onclick="toggleTimeline()">
                                    <span id="timelineToggleIcon">▼</span> <span id="timelineToggleText">Show Timeline</span>
                                </button>
                            </div>
                            <div id="timelineContent" class="timeline-content" style="display: none;">
                                <div class="date-range-selector">
                                    <div class="date-input-group">
                                        <label for="startDate">From:</label>
                                        <input type="date" id="startDate" class="date-input" onchange="filterTimelineByDate()">
                                    </div>
                                    <div class="date-input-group">
                                        <label for="endDate">To:</label>
                                        <input type="date" id="endDate" class="date-input" onchange="filterTimelineByDate()">
                                    </div>
                                    <button class="btn-reset-dates" onclick="resetDateFilter()">
                                        🔄 Reset
                                    </button>
                                </div>
                                <div id="expenseTimeline" class="expense-timeline">
                                    <!-- Timeline items will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Balance Dashboard for Simple Mode -->
                        <div id="simpleModeBalanceDashboard" class="balance-dashboard-simple" style="display: none;">
                            <div class="dashboard-stats">
                                <div class="stat-card stat-expenses">
                                    <div class="stat-icon">💸</div>
                                    <div class="stat-content">
                                        <span class="stat-label">Total Expenses</span>
                                        <span class="stat-value" id="simpleModeTotalExpenses">$0</span>
                                    </div>
                                </div>
                                <div class="stat-card stat-per-person">
                                    <div class="stat-icon">👤</div>
                                    <div class="stat-content">
                                        <span class="stat-label">Per Person</span>
                                        <span class="stat-value" id="simpleModePerPerson">$0</span>
                                    </div>
                                </div>
                                <div class="stat-card stat-members">
                                    <div class="stat-icon">👥</div>
                                    <div class="stat-content">
                                        <span class="stat-label">Active Members</span>
                                        <span class="stat-value" id="simpleModeActiveMembers">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Visual Balance Chart -->
                            <div class="balance-chart-container">
                                <h4 class="chart-title">💰 Balance Overview</h4>
                                <div id="balanceChart" class="balance-chart">
                                    <!-- Chart will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Balance List -->
                        <div class="balances-list-container">
                            <div id="balancesList" class="balances-list-simple">
                                <!-- Balances will be loaded here -->
                            </div>
                            
                            <div id="noBalances" class="empty-state" style="display: none;">
                                <div class="empty-icon">⚖️</div>
                                <h4>No members yet</h4>
                                <p>Balances will appear when members start contributing to expenses</p>
                            </div>
                        </div>

                        <!-- Smart Settlements Button -->
                        <div id="smartSettlementsSection" class="smart-settlements-section" style="display: none;">
                            <button class="btn-smart-settle" onclick="openSmartSettlements()">
                                <span class="btn-icon">🎯</span>
                                <div class="btn-content">
                                    <span class="btn-title">Smart Settlements</span>
                                    <span class="btn-subtitle">Simplify payments with one click</span>
                                </div>
                            </button>
                        </div>

                        <!-- How it works info -->
                        <div class="info-box-simple">
                            <h4>💡 How balances work:</h4>
                            <ul class="info-list">
                                <li><strong>Green (+):</strong> Others owe you money</li>
                                <li><strong>Red (-):</strong> You owe money to others</li>
                                <li><strong>Balanced transactions:</strong> Simplified to minimize payments</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Members Tab -->
                    <div id="membersTab" class="tab-pane">
                        <h3>👥 Fund Members</h3>
                        
                        <!-- Removal Requests Section (Only for creator) -->
                        <div id="removalRequestsSection" style="display: none; margin-bottom: 2rem;">
                            <h4 style="color: var(--warning); margin-bottom: 1rem;">⚠️ Pending Removal Requests</h4>
                            <div id="removalRequestsList">
                                <!-- Removal requests will be loaded here -->
                            </div>
                        </div>
                        
                        <div id="membersList">
                            <!-- Members will be loaded here -->
                        </div>
                        <div id="noMembers" class="empty-state" style="display: none;">
                            <div class="empty-icon">👤</div>
                            <h4>No members yet</h4>
                        </div>
                    </div>

                    <!-- Manage Tab -->
                    <div id="manageTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>⚙️ Fund Management</h3>
                            <p>Advanced options to manage the fund.</p>
                            
                            <div class="manage-section">
                                <!-- Kick Member Section -->
                                <div class="member-management-section">
                                    <h4>👥 Member Management</h4>
                                    <p><strong>Remove Member</strong></p>
                                    <p class="help-text">
                                        Remove a member from the group by returning their proportional share of the current balance.
                                    </p>
                                    
                                    <div class="info-box">
                                        <p><strong>💡 How it works:</strong></p>
                                        <ul>
                                            <li>The member is permanently removed from the group</li>
                                            <li>Receives: (Their contribution / Total contributions) × Current balance</li>
                                            <li>Cannot participate in future votes</li>
                                            <li>Their previous votes remain recorded</li>
                                        </ul>
                                    </div>
                                    
                                    <div id="kickMembersList" class="kick-members-list">
                                        <!-- Member cards will be loaded here -->
                                    </div>
                                    
                                    <div id="noMembersToKick" class="empty-state" style="display: none;">
                                        <div class="empty-icon">👥</div>
                                        <h4>No members to remove</h4>
                                        <p>There is only one member in the group or you are not the creator</p>
                                    </div>
                                </div>
                                
                                <div class="danger-zone">
                                    <h4>🚨 Danger Zone</h4>
                                    <p><strong>Close and Distribute Fund</strong></p>
                                    <p class="help-text">
                                        This action will permanently close the group and settle all remaining balances 
                                        proportionally among contributors according to their contribution.
                                    </p>
                                    
                                    <div class="info-box warning-box">
                                        <p><strong>⚠️ Warning:</strong></p>
                                        <ul>
                                            <li>This action is <strong>irreversible</strong></li>
                                            <li>Only the fund creator can execute it</li>
                                            <li>Each contributor will receive: (their contribution / total) × current balance</li>
                                            <li>The fund will be permanently closed</li>
                                            <li>No more deposits or proposals can be made</li>
                                        </ul>
                                    </div>
                                    
                                    <div id="closeFundPreview" class="distribution-preview" style="display: none;">
                                        <h5>📊 Distribution Preview</h5>
                                        <div id="distributionList"></div>
                                    </div>
                                    
                                    <div class="button-group">
                                        <button id="previewCloseFundBtn" class="btn btn-secondary">
                                            📊 Distribution Preview
                                        </button>
                                        <button id="closeFundBtn" class="btn btn-danger">
                                            🔒 Close and Distribute Fund
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </section>

            <!-- Floating Add Expense Button (Simple Mode only) -->
            <div id="addExpenseBtn" class="fab-container" style="display: none;">
                <button class="fab-main" onclick="toggleFabMenu()" title="Quick Actions">
                    <span class="fab-icon">➕</span>
                </button>
                <div class="fab-menu" id="fabMenu" style="display: none;">
                    <button class="fab-option" onclick="showAddExpenseModal()" title="Add Expense">
                        <span class="fab-option-icon">💵</span>
                        <span class="fab-option-text">Add Expense</span>
                    </button>
                    <button class="fab-option" onclick="showAddRecurringExpenseModal()" title="Recurring Expense">
                        <span class="fab-option-icon">🔄</span>
                        <span class="fab-option-text">Recurring Expense</span>
                    </button>
                </div>
            </div>

            <!-- Add Expense Modal (Simple Mode) -->
            <div id="addExpenseModal" class="modal" style="display: none;">
                <div class="modal-content modal-medium">
                    <div class="modal-header">
                        <h2>➕ Add Expense</h2>
                        <button class="modal-close" onclick="closeAddExpenseModal()">&times;</button>
                    </div>
                    
                    <form id="addExpenseForm" class="expense-form-clean">
                        <div class="form-header-clean">
                            <h3>Add Expense</h3>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn-scan-receipt" onclick="triggerReceiptScan()">
                                    📸 Scan Receipt
                                </button>
                                <button type="button" class="btn-challenge-mode" onclick="showChallengeModeSelection()">
                                    🎮 Challenge Mode
                                </button>
                                <input 
                                    type="file" 
                                    id="receiptImageInput" 
                                    accept="image/*" 
                                    capture="environment"
                                    style="display: none;"
                                    onchange="handleReceiptImage(event)"
                                >
                            </div>
                        </div>

                        <div id="scanningIndicator" style="display: none; background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; padding: 1rem; border-radius: 8px; margin: 1rem 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div class="spinner-small"></div>
                                <div>
                                    <strong style="color: #667eea;">Scanning receipt...</strong>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                                        Extracting amount, description, and date from image
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="expenseDescription" class="form-label">Description *</label>
                                <input 
                                    type="text" 
                                    id="expenseDescription"
                                    name="description"
                                    class="form-input"
                                    placeholder="What did you pay for?"
                                    required
                                    autocomplete="off"
                                >
                            </div>

                            <div class="form-field">
                                <label for="expenseAmount" class="form-label">Amount *</label>
                                <div class="form-hint" style="margin-bottom: 0.5rem; font-size: 0.85rem; color: #9ca3af;">
                                    Enter a <strong>positive</strong> number for expenses, or a <strong>negative</strong> number for payments received/loans.
                                </div>
                                <div class="amount-input-wrapper">
                                    <span class="currency-symbol" id="currencySymbol">$</span>
                                    <input 
                                        type="number" 
                                        id="expenseAmount"
                                        name="amount"
                                        class="form-input amount-input"
                                        placeholder="0.00"
                                        step="any"
                                        required
                                    >
                                </div>
                                <div class="form-examples" style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                    Examples: 50 (expense), -50 (payment received)
                                </div>
                            </div>

                            <div class="form-field">
                                <label for="expenseCurrency" class="form-label">Currency</label>
                                <select id="expenseCurrency" name="currency" class="form-input form-select" onchange="updateCurrencySymbol()">
                                    <option value="USD" selected>🇺🇸 USD - US Dollar</option>
                                    <option value="EUR">🇪🇺 EUR - Euro</option>
                                    <option value="GBP">🇬🇧 GBP - British Pound</option>
                                    <option value="MXN">🇲🇽 MXN - Mexican Peso</option>
                                    <option value="COP">🇨🇴 COP - Colombian Peso</option>
                                    <option value="BRL">🇧🇷 BRL - Brazilian Real</option>
                                    <option value="CAD">🇨🇦 CAD - Canadian Dollar</option>
                                    <option value="AUD">🇦🇺 AUD - Australian Dollar</option>
                                    <option value="JPY">🇯🇵 JPY - Japanese Yen</option>
                                    <option value="CNY">🇨🇳 CNY - Chinese Yuan</option>
                                    <option value="INR">🇮🇳 INR - Indian Rupee</option>
                                    <option value="CHF">🇨🇭 CHF - Swiss Franc</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <label class="form-label">Paid by *</label>
                                <div id="expensePaidBy" class="split-members-list">
                                    <!-- Will be populated dynamically with checkboxes -->
                                </div>
                                <small class="field-hint">Select who paid (can be multiple people)</small>
                            </div>

                            <div class="form-field">
                                <label for="expenseDate" class="form-label">Date</label>
                                <input 
                                    type="date" 
                                    id="expenseDate"
                                    name="date"
                                    class="form-input"
                                >
                            </div>

                            <div class="form-field">
                                <label for="expenseCategory" class="form-label">Category</label>
                                <select id="expenseCategory" name="category" class="form-input form-select">
                                    <option value="food">🍕 Food & Dining</option>
                                    <option value="transport">🚗 Transportation</option>
                                    <option value="housing">🏠 Housing & Rent</option>
                                    <option value="utilities">💡 Utilities</option>
                                    <option value="entertainment">🎬 Entertainment</option>
                                    <option value="shopping">🛍️ Shopping</option>
                                    <option value="health">⚕️ Health & Medical</option>
                                    <option value="travel">✈️ Travel</option>
                                    <option value="subscription">📺 Subscriptions</option>
                                    <option value="other" selected>🎯 Other</option>
                                </select>
                                <small class="field-hint">Helps with analytics and expense tracking</small>
                            </div>

                            <div class="form-field">
                                <label class="form-label">Split between *</label>
                                <div class="info-box" style="margin-bottom: 0.75rem; background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); padding: 0.75rem;">
                                    <p style="margin: 0; font-size: 0.85rem; display: flex; align-items: start; gap: 0.5rem;">
                                        <span style="font-size: 1rem;">💡</span>
                                        <span>
                                            <strong>Flexible splitting:</strong> Use the <strong>+</strong> and <strong>−</strong> buttons to add portions when a member covers for external guests. 
                                            Example: If someone brings 2 guests, add 3 portions (them + 2 guests).
                                        </span>
                                    </p>
                                </div>
                                <div id="expenseSplitBetween" class="split-members-list">
                                    <!-- Will be populated dynamically -->
                                </div>
                                <small class="field-hint">Select who should share this expense</small>
                            </div>

                            <div class="form-field">
                                <label for="expenseNotes" class="form-label">Notes <span class="optional-badge">Optional</span></label>
                                <textarea 
                                    id="expenseNotes"
                                    name="notes"
                                    class="form-input form-textarea"
                                    rows="2"
                                    placeholder="Add any additional details..."
                                ></textarea>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddExpenseModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Save Expense
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Record Payment Modal -->
            <div id="recordPaymentModal" class="modal" style="display: none;">
                <div class="modal-content modal-small">
                    <div class="modal-header">
                        <h2>💰 Record Payment</h2>
                        <button class="modal-close" onclick="closeRecordPaymentModal()">&times;</button>
                    </div>
                    
                    <form id="recordPaymentForm" class="expense-form">
                        <div class="form-group">
                            <label for="paymentAmount" class="input-label">
                                <span class="label-icon">💵</span>
                                <span>Amount Paid</span>
                            </label>
                            <div class="input-with-prefix">
                                <span class="input-prefix">$</span>
                                <input 
                                    type="number" 
                                    id="paymentAmount" 
                                    name="amount"
                                    class="input-modern" 
                                    step="0.01" 
                                    min="0.01"
                                    required
                                    placeholder="0.00"
                                >
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="paymentTo" class="input-label">
                                <span class="label-icon">👤</span>
                                <span>Paid To</span>
                            </label>
                            <input 
                                type="text" 
                                id="paymentTo" 
                                class="input-modern" 
                                readonly
                            >
                        </div>

                        <div class="form-group">
                            <label for="paymentDate" class="input-label">
                                <span class="label-icon">📅</span>
                                <span>Payment Date</span>
                            </label>
                            <input 
                                type="date" 
                                id="paymentDate" 
                                name="date"
                                class="input-modern"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label for="paymentNotes" class="input-label">
                                <span class="label-icon">📝</span>
                                <span>Notes (Optional)</span>
                            </label>
                            <textarea 
                                id="paymentNotes" 
                                name="notes"
                                class="input-modern"
                                rows="2"
                                placeholder="Payment method, reference number, etc..."
                            ></textarea>
                        </div>

                        <input type="hidden" id="paymentToId" name="toUserId">

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeRecordPaymentModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-success">
                                <span class="btn-icon">✅</span>
                                <span>Record Payment</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Fund Modal -->
            <div id="createFundModal" class="modal" style="display: none;">
                <div class="modal-content modal-large create-group-modal">
                    <div class="modal-header">
                        <h2>✨ Create New Group</h2>
                        <button class="modal-close" onclick="closeCreateFundModal()">&times;</button>
                    </div>
                    
                    <form id="createFundForm" class="create-group-form" onsubmit="createFund(event)">
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-label">Basic Info</div>
                                <div class="step-connector"></div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-label">Mode</div>
                            </div>
                        </div>

                        <!-- Step 1: Basic Info -->
                        <div class="form-step" data-step="1" style="display: block;">
                            <h3>📝 What's your group name?</h3>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem; text-align: center;">Give it a name everyone will easily recognize</p>
                            
                            <div class="form-group">
                                <label for="fundName">
                                    <span class="label-text">Group Name</span>
                                    <span class="label-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="fundName" 
                                    placeholder="E.g: Dog Expenses, Cancun Trip, Roommates 2025" 
                                    required 
                                    class="input-modern input-large"
                                />
                                <small class="form-hint">💡 Use a clear and descriptive name</small>
                            </div>

                            <!-- Icon Selection -->
                            <div class="form-group">
                                <label>
                                    <span class="label-text">Group Icon</span>
                                    <span class="label-badge">Optional</span>
                                </label>
                                <div class="icon-selection-grid">
                                    <input type="radio" name="groupIcon" value="🐕" id="icon-dog" checked />
                                    <label for="icon-dog" class="icon-option">🐕</label>
                                    
                                    <input type="radio" name="groupIcon" value="✈️" id="icon-plane" />
                                    <label for="icon-plane" class="icon-option">✈️</label>
                                    
                                    <input type="radio" name="groupIcon" value="🏠" id="icon-home" />
                                    <label for="icon-home" class="icon-option">🏠</label>
                                    
                                    <input type="radio" name="groupIcon" value="🎉" id="icon-party" />
                                    <label for="icon-party" class="icon-option">🎉</label>
                                    
                                    <input type="radio" name="groupIcon" value="💼" id="icon-briefcase" />
                                    <label for="icon-briefcase" class="icon-option">💼</label>
                                    
                                    <input type="radio" name="groupIcon" value="🍕" id="icon-pizza" />
                                    <label for="icon-pizza" class="icon-option">🍕</label>
                                    
                                    <input type="radio" name="groupIcon" value="⚽" id="icon-soccer" />
                                    <label for="icon-soccer" class="icon-option">⚽</label>
                                    
                                    <input type="radio" name="groupIcon" value="🎓" id="icon-graduation" />
                                    <label for="icon-graduation" class="icon-option">🎓</label>
                                    
                                    <input type="radio" name="groupIcon" value="🏖️" id="icon-beach" />
                                    <label for="icon-beach" class="icon-option">🏖️</label>
                                    
                                    <input type="radio" name="groupIcon" value="🚗" id="icon-car" />
                                    <label for="icon-car" class="icon-option">🚗</label>
                                    
                                    <input type="radio" name="groupIcon" value="🎸" id="icon-guitar" />
                                    <label for="icon-guitar" class="icon-option">🎸</label>
                                    
                                    <input type="radio" name="groupIcon" value="💎" id="icon-diamond" />
                                    <label for="icon-diamond" class="icon-option">💎</label>
                                </div>
                                <small class="form-hint">Choose an icon that represents your group</small>
                            </div>

                            <div class="form-group">
                                <label for="fundDescription">
                                    <span class="label-text">Description</span>
                                    <span class="label-badge">Optional</span>
                                </label>
                                <textarea 
                                    id="fundDescription" 
                                    rows="3" 
                                    placeholder="E.g: Shared expenses for food, walks, and pet care"
                                    class="input-modern"
                                ></textarea>
                            </div>
                            
                            <!-- Hidden fields with default values -->
                            <input type="hidden" id="isPrivate" value="true" />
                            <input type="hidden" id="fundType" value="0" />
                            
                            <div class="form-step-buttons">
                                <button type="button" class="btn-step btn-step-back" onclick="closeCreateFundModal()">
                                    Cancel
                                </button>
                                <button type="button" class="btn-step btn-step-next" onclick="nextStep(2)">
                                    Next →
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Mode Selection -->
                        <div class="form-step" data-step="2" style="display: none;">
                            <h3>⚡ How do you want to manage expenses?</h3>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem; text-align: center;">Choose the mode that best fits your group</p>
                            
                            <div class="mode-selection-grid">
                                <label class="mode-card">
                                    <input type="radio" name="groupMode" value="simple" checked />
                                    <span class="mode-recommended">✨ Recommended</span>
                                    <div class="mode-title">
                                        <span>📝</span>
                                        <span>Simple Mode</span>
                                    </div>
                                    <div class="mode-description">
                                        Perfect to get started. No wallet needed. Easily track expenses and split bills.
                                    </div>
                                    <ul class="mode-features">
                                        <li>Login with Google or Email</li>
                                        <li>Track debts</li>
                                        <li>Collaborative approval</li>
                                        <li>Settle outside the app</li>
                                    </ul>
                                </label>
                                
                                <label class="mode-card mode-disabled" id="blockchainModeCard" style="opacity: 0.5; cursor: not-allowed; position: relative;">
                                    <input type="radio" name="groupMode" value="blockchain" disabled />
                                    <span class="mode-recommended" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">🚀 Coming Soon</span>
                                    <div class="mode-title">
                                        <span>⛓️</span>
                                        <span>Blockchain Mode</span>
                                    </div>
                                    <div class="mode-description">
                                        Automatic smart contracts. On-chain voting and total transparency.
                                    </div>
                                    <ul class="mode-features">
                                        <li>Requires crypto wallet</li>
                                        <li>Automatic payments</li>
                                        <li>Blockchain voting</li>
                                        <li>Trustless execution</li>
                                    </ul>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1.1rem; font-weight: bold; color: #f59e0b; white-space: nowrap;">IN DEVELOPMENT</div>
                                </label>
                            </div>

                            <!-- Wallet Warning (shown when wallet not connected) -->
                            <div id="walletWarning" class="wallet-warning" style="display: none;">
                                <div class="warning-icon">⚠️</div>
                                <div class="warning-content">
                                    <strong>Wallet Not Connected</strong>
                                    <p>To create a Blockchain mode group, you need to connect your crypto wallet first. Please connect your wallet from the main menu.</p>
                                </div>
                            </div>

                            <!-- Hidden governance fields with defaults -->
                            <input type="hidden" id="approvalPercentage" value="60" />
                            <input type="hidden" id="minimumVotes" value="2" />
                            
                            <div class="form-step-buttons">
                                <button type="button" class="btn-step btn-step-back" onclick="previousStep(1)">
                                    ← Back
                                </button>
                                <button type="submit" class="btn-step btn-step-submit">
                                    🚀 Create Group
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- Smart Settlements Modal -->
    <div id="smartSettlementsModal" class="modal-overlay" onclick="closeSmartSettlements(event)">
        <div class="modal-content smart-settlements-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>🎯 Smart Settlements</h3>
                <button class="close-btn" onclick="closeSmartSettlements()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settlements-intro">
                    <p class="settlements-description">
                        💡 We've optimized your payments to minimize the number of transactions needed to settle all debts.
                    </p>
                    <div class="settlements-stats">
                        <div class="stat-badge">
                            <span class="stat-number" id="settlementsCount">0</span>
                            <span class="stat-label">payments needed</span>
                        </div>
                        <div class="stat-badge">
                            <span class="stat-number" id="settlementsTotal">$0</span>
                            <span class="stat-label">total to settle</span>
                        </div>
                    </div>
                </div>
                
                <div id="settlementsList" class="settlements-list">
                    <!-- Settlements will be rendered here -->
                </div>
                
                <div id="noSettlements" class="empty-state" style="display: none;">
                    <div class="empty-icon">✅</div>
                    <h4>All Settled!</h4>
                    <p>Everyone is even. No payments needed.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSmartSettlements()">Close</button>
                <button class="btn btn-success" id="markAllSettledBtn" onclick="markAllSettled()" style="display: none;">
                    <span class="btn-icon">✓</span>
                    <span>Mark All as Settled</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="i18n.js"></script>
    <script src="theme.js"></script>
    <script src="ethers.umd.min.js"></script>
    
    <!-- Stripe SDK -->
    <script async src="https://js.stripe.com/v3/buy-button.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <!-- App Scripts -->
    <script src="firebase-config.js"></script>
    <script src="firebase-messaging.js"></script>
    
    <!-- Security Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="rate-limiter.js"></script>
    <script src="sanitizer.js"></script>
    
    <!-- Application Scripts -->
    <script src="mode-manager.js"></script>
    <script src="wallet-connector.js"></script>
    <script src="form-wizard.js"></script>
    <script src="app-platform.js"></script>
    
    <script>
        // Mode Selector Interaction
        document.addEventListener('DOMContentLoaded', () => {
            const modeRadios = document.querySelectorAll('input[name="groupMode"]');
            const modeInfoBox = document.getElementById('modeInfoBox');
            
            modeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const selectedMode = e.target.value;
                    
                    if (selectedMode === 'simple') {
                        modeInfoBox.innerHTML = `
                            <div class="info-icon">💡</div>
                            <div class="info-content">
                                <strong>Simple Mode:</strong> Perfect for getting started. No crypto knowledge needed. You can upgrade to Blockchain Mode later if you want automatic payments.
                            </div>
                        `;
                    } else {
                        modeInfoBox.innerHTML = `
                            <div class="info-icon">⚠️</div>
                            <div class="info-content">
                                <strong>Blockchain Mode:</strong> Requires a wallet (MetaMask) and ETH for gas fees. Payments are automatic and trustless. Once created, the group cannot be converted to Simple Mode.
                            </div>
                        `;
                    }
                });
            });
            
            // Initialize Firebase when page loads
            if (typeof window.FirebaseConfig !== 'undefined') {
                window.FirebaseConfig.initialize().then(success => {
                    if (success) {
                        console.log('✅ Firebase ready for Simple Mode');
                    } else {
                        console.warn('⚠️ Firebase initialization failed - Simple Mode unavailable');
                    }
                });
            }
        });
        
        // Settings Modal Functions for App
        function openAppSettings() {
            const modal = document.getElementById('appSettingsModal');
            modal.classList.add('active');
            updateAppSettingsUI();
        }

        function closeAppSettings(event) {
            if (!event || event.target.classList.contains('modal-overlay') || event.target.classList.contains('close-btn')) {
                const modal = document.getElementById('appSettingsModal');
                modal.classList.remove('active');
            }
        }

        function applyAppTranslations() {
            const currentLang = getCurrentLanguage();
            const t = translations[currentLang];
            
            // Update document title
            document.title = `Ant Pool - ${t.app.header.subtitle}`;
            
            // Header
            const versionBadge = document.querySelector('.version-badge');
            if (versionBadge) versionBadge.textContent = t.app.header.subtitle;
            
            // Connect/Disconnect buttons
            const connectBtn = document.querySelector('#connectWallet span:last-child');
            if (connectBtn) connectBtn.textContent = t.app.header.connect;
            
            const disconnectBtn = document.querySelector('#disconnectWallet span:last-child');
            if (disconnectBtn) disconnectBtn.textContent = t.app.header.disconnect;
            
            // Nickname Modal
            const nicknameTitle = document.querySelector('#nicknameModal h2');
            if (nicknameTitle) nicknameTitle.textContent = `👋 ${t.app.nickname.title}`;
            
            const nicknameParagraph = document.querySelector('#nicknameModal p');
            if (nicknameParagraph) nicknameParagraph.innerHTML = t.app.nickname.subtitle;
            
            const nicknameLabel = document.querySelector('#nicknameModal label');
            if (nicknameLabel) nicknameLabel.textContent = t.app.nickname.label;
            
            const nicknameInput = document.querySelector('#nicknameInput');
            if (nicknameInput) nicknameInput.placeholder = t.app.nickname.placeholder;
            
            const nicknameSmall = document.querySelector('#nicknameModal small');
            if (nicknameSmall) nicknameSmall.textContent = t.app.nickname.help;
            
            const nicknameBtn = document.querySelector('#setNicknameBtn');
            if (nicknameBtn) nicknameBtn.textContent = t.app.nickname.button;
            
            // Stats
            const statCards = document.querySelectorAll('.stat-card p');
            if (statCards[0]) statCards[0].textContent = t.app.stats.groupsCreated;
            if (statCards[1]) statCards[1].textContent = t.app.stats.activeGroups;
            if (statCards[2]) statCards[2].textContent = t.app.stats.groupsJoined;
            
            // Invitations
            const invitationsTitle = document.querySelector('.invitations-header h3');
            if (invitationsTitle) invitationsTitle.textContent = `🎫 ${t.app.invitations.title}`;
            
            // Dashboard
            const dashboardTitle = document.querySelector('.action-bar h2');
            if (dashboardTitle) dashboardTitle.textContent = t.app.dashboard.title;
            
            const createBtn = document.querySelector('#createFundBtn span:last-child');
            if (createBtn) createBtn.textContent = t.app.dashboard.createNew;
            
            // Filters
            const filterBtns = document.querySelectorAll('.filter-btn');
            if (filterBtns[0]) filterBtns[0].childNodes[0].textContent = `${t.app.dashboard.filters.all} (`;
            if (filterBtns[1]) filterBtns[1].childNodes[0].textContent = `${t.app.dashboard.filters.created} (`;
            if (filterBtns[2]) filterBtns[2].childNodes[0].textContent = `${t.app.dashboard.filters.participating} (`;
            if (filterBtns[3]) filterBtns[3].childNodes[0].textContent = `🌴 ${t.app.dashboard.filters.travel} (`;
            if (filterBtns[4]) filterBtns[4].childNodes[0].textContent = `💰 ${t.app.dashboard.filters.savings} (`;
            if (filterBtns[5]) filterBtns[5].childNodes[0].textContent = `🤝 ${t.app.dashboard.filters.shared} (`;
            
            // Empty State
            const emptyTitle = document.querySelector('#emptyState h3');
            if (emptyTitle) emptyTitle.textContent = t.app.dashboard.empty.title;
            
            const emptySubtitle = document.querySelector('#emptyState p');
            if (emptySubtitle) emptySubtitle.textContent = t.app.dashboard.empty.subtitle;
            
            const emptyBtn = document.querySelector('#emptyState button span:last-child');
            if (emptyBtn) emptyBtn.textContent = t.app.dashboard.empty.button;
            
            // Back button
            const backBtn = document.querySelector('#backToDashboard span:last-child');
            if (backBtn) backBtn.textContent = t.app.fundDetail.info.backToDashboard;
            
            // Fund Detail Stats
            const statLabels = document.querySelectorAll('.stat-label');
            if (statLabels[0]) statLabels[0].textContent = t.app.fundDetail.info.balance;
            if (statLabels[1]) statLabels[1].textContent = t.app.fundDetail.info.target;
            if (statLabels[2]) statLabels[2].textContent = t.app.fundDetail.info.progress;
            if (statLabels[3]) statLabels[3].textContent = t.app.fundDetail.info.members;
            if (statLabels[4]) statLabels[4].textContent = t.app.fundDetail.info.proposals;
            
            // Fund Detail Loading and Badges
            const fundDetailName = document.querySelector('#fundDetailName');
            if (fundDetailName && fundDetailName.textContent === 'Cargando...') {
                fundDetailName.textContent = t.app.fundDetail.info.loading;
            }
            
            const fundTypeBadge = document.querySelector('#fundTypeBadge');
            if (fundTypeBadge && fundTypeBadge.textContent === 'Tipo') {
                fundTypeBadge.textContent = t.app.fundDetail.info.type;
            }
            
            const groupStatusBadge = document.querySelector('#groupStatusBadge');
            if (groupStatusBadge && groupStatusBadge.textContent === 'Estado') {
                groupStatusBadge.textContent = t.app.fundDetail.info.status;
            }
            
            // Fund Tabs
            const tabButtons = document.querySelectorAll('.fund-tab-btn');
            tabButtons.forEach(btn => {
                const tabId = btn.dataset.tab;
                const span = btn.querySelector('span:last-child');
                if (span && t.app.fundDetail.tabs[tabId]) {
                    span.textContent = t.app.fundDetail.tabs[tabId];
                }
            });
            
            // Deposit Tab
            const depositTitle = document.querySelector('#depositTab h3');
            if (depositTitle) depositTitle.textContent = `💰 ${t.app.fundDetail.deposit.title}`;
            
            const depositSubtitle = document.querySelector('#depositTab p');
            if (depositSubtitle) depositSubtitle.textContent = t.app.fundDetail.deposit.subtitle;
            
            const depositLabel = document.querySelector('label[for="depositAmount"]');
            if (depositLabel) depositLabel.textContent = t.app.fundDetail.deposit.amount;
            
            const depositInput = document.querySelector('#depositAmount');
            if (depositInput) depositInput.placeholder = t.app.fundDetail.deposit.amountPlaceholder;
            
            const depositContribution = document.querySelector('.contribution-info span');
            if (depositContribution && depositContribution.textContent.includes('contribución')) {
                depositContribution.innerHTML = `${t.app.fundDetail.deposit.currentContribution}: <strong id="userContribution">0 ETH</strong>`;
            }
            
            const depositBtn = document.querySelector('#depositBtn');
            if (depositBtn) depositBtn.textContent = t.app.fundDetail.deposit.button;
            
            // Manage Tab
            const manageTitle = document.querySelector('#manageTab h3');
            if (manageTitle) manageTitle.textContent = `⚙️ ${t.app.fundDetail.manage.title}`;
            
            const manageSubtitle = document.querySelector('#manageTab > .tab-card > p');
            if (manageSubtitle) manageSubtitle.textContent = t.app.fundDetail.manage.subtitle;
            
            const memberManagementTitle = document.querySelector('.member-management-section h4');
            if (memberManagementTitle) memberManagementTitle.textContent = `👥 ${t.app.fundDetail.manage.memberManagement}`;
            
            const kickMemberTitle = document.querySelector('.member-management-section p strong');
            if (kickMemberTitle) kickMemberTitle.textContent = t.app.fundDetail.manage.kickMember;
            
            const kickDescription = document.querySelector('.member-management-section .help-text');
            if (kickDescription) kickDescription.textContent = t.app.fundDetail.manage.kickDescription;
            
            const howItWorksTitle = document.querySelector('.member-management-section .info-box p strong');
            if (howItWorksTitle) howItWorksTitle.textContent = `💡 ${t.app.fundDetail.manage.howItWorks}`;
            
            const kickPointsList = document.querySelector('.member-management-section .info-box ul');
            if (kickPointsList) {
                kickPointsList.innerHTML = t.app.fundDetail.manage.kickPoints.map(point => `<li>${point}</li>`).join('');
            }
            
            const noMembersTitle = document.querySelector('#noMembersToKick h4');
            if (noMembersTitle) noMembersTitle.textContent = t.app.fundDetail.manage.noMembersToKick;
            
            const noMembersSubtitle = document.querySelector('#noMembersToKick p');
            if (noMembersSubtitle) noMembersSubtitle.textContent = t.app.fundDetail.manage.noMembersSubtitle;
            
            const dangerZoneTitle = document.querySelector('.danger-zone h4');
            if (dangerZoneTitle) dangerZoneTitle.textContent = `🚨 ${t.app.fundDetail.manage.dangerZone}`;
            
            const closeDistributeTitle = document.querySelector('.danger-zone > p strong');
            if (closeDistributeTitle) closeDistributeTitle.textContent = t.app.fundDetail.manage.closeAndDistribute;
            
            const closeDescription = document.querySelector('.danger-zone > .help-text');
            if (closeDescription) closeDescription.textContent = t.app.fundDetail.manage.closeDescription;
            
            const warningTitle = document.querySelector('.warning-box p strong');
            if (warningTitle) warningTitle.textContent = `⚠️ ${t.app.fundDetail.manage.warning}`;
            
            const warningPointsList = document.querySelector('.warning-box ul');
            if (warningPointsList) {
                warningPointsList.innerHTML = t.app.fundDetail.manage.warningPoints.map(point => 
                    point.includes('irreversible') || point.includes('irreversible') 
                        ? `<li>${point.replace('irreversible', '<strong>irreversible</strong>').replace('irreversible', '<strong>irreversible</strong>')}</li>`
                        : `<li>${point}</li>`
                ).join('');
            }
            
            const distributionPreviewTitle = document.querySelector('#closeFundPreview h5');
            if (distributionPreviewTitle) distributionPreviewTitle.textContent = `📊 ${t.app.fundDetail.manage.distributionPreview}`;
            
            const previewButton = document.querySelector('#previewCloseFundBtn');
            if (previewButton) previewButton.textContent = `📊 ${t.app.fundDetail.manage.previewButton}`;
            
            const closeButton = document.querySelector('#closeFundBtn');
            if (closeButton) closeButton.textContent = `🔒 ${t.app.fundDetail.manage.closeButton}`;
            
            // Invite Tab
            const inviteTitle = document.querySelector('#inviteTab h3');
            if (inviteTitle) inviteTitle.textContent = `🎫 ${t.app.fundDetail.invite.title}`;
            
            const inviteSubtitle = document.querySelector('#inviteTab > .tab-card > p');
            if (inviteSubtitle) inviteSubtitle.textContent = t.app.fundDetail.invite.subtitle;
            
            const inviteInfoTitle = document.querySelector('.invite-info-box p strong');
            if (inviteInfoTitle) inviteInfoTitle.textContent = `ℹ️ ${t.app.fundDetail.invite.infoTitle}`;
            
            const inviteInfoList = document.querySelector('.invite-info-box ul');
            if (inviteInfoList) {
                inviteInfoList.innerHTML = t.app.fundDetail.invite.infoPoints.map(point => `<li>${point}</li>`).join('');
            }
            
            const inviteLabel = document.querySelector('label[for="inviteAddress"]');
            if (inviteLabel) inviteLabel.textContent = t.app.fundDetail.invite.addressLabel;
            
            const inviteInput = document.querySelector('#inviteAddress');
            if (inviteInput) inviteInput.placeholder = t.app.fundDetail.invite.addressPlaceholder;
            
            const inviteHelp = document.querySelector('#inviteTab small');
            if (inviteHelp) inviteHelp.textContent = t.app.fundDetail.invite.addressHelp;
            
            const inviteBtn = document.querySelector('#inviteBtn');
            if (inviteBtn) inviteBtn.textContent = t.app.fundDetail.invite.button;
            
            // Propose Tab
            const proposeTitle = document.querySelector('#proposeTab h3');
            if (proposeTitle) proposeTitle.textContent = `📝 ${t.app.fundDetail.propose.title}`;
            
            const proposeSubtitle = document.querySelector('#proposeTab > .tab-card > p');
            if (proposeSubtitle) proposeSubtitle.textContent = t.app.fundDetail.propose.subtitle;
            
            const proposeHowItWorks = document.querySelector('#proposeTab .info-box p strong');
            if (proposeHowItWorks) proposeHowItWorks.textContent = `💡 ${t.app.fundDetail.propose.howItWorks}`;
            
            const proposeHowItWorksList = document.querySelector('#proposeTab .info-box ul');
            if (proposeHowItWorksList) {
                proposeHowItWorksList.innerHTML = t.app.fundDetail.propose.howItWorksPoints.map(point => `<li>${point}</li>`).join('');
            }
            
            const proposeRecipientLabel = document.querySelector('label[for="proposalRecipient"]');
            if (proposeRecipientLabel) proposeRecipientLabel.textContent = t.app.fundDetail.propose.recipientLabel;
            
            const proposeRecipientInput = document.querySelector('#proposalRecipient');
            if (proposeRecipientInput) proposeRecipientInput.placeholder = t.app.fundDetail.propose.recipientPlaceholder;
            
            const proposeRecipientHelp = document.querySelector('label[for="proposalRecipient"] + input + small');
            if (proposeRecipientHelp) proposeRecipientHelp.textContent = t.app.fundDetail.propose.recipientHelp;
            
            const proposeAmountLabel = document.querySelector('label[for="proposalAmount"]');
            if (proposeAmountLabel) proposeAmountLabel.textContent = t.app.fundDetail.propose.amountLabel;
            
            const proposeAmountInput = document.querySelector('#proposalAmount');
            if (proposeAmountInput) proposeAmountInput.placeholder = t.app.fundDetail.propose.amountPlaceholder;
            
            const proposeAmountHelp = document.querySelector('label[for="proposalAmount"] + input + small');
            if (proposeAmountHelp) proposeAmountHelp.textContent = t.app.fundDetail.propose.amountHelp;
            
            const proposeDescLabel = document.querySelector('label[for="proposalDescription"]');
            if (proposeDescLabel) proposeDescLabel.textContent = t.app.fundDetail.propose.descriptionLabel;
            
            const proposeDescInput = document.querySelector('#proposalDescription');
            if (proposeDescInput) proposeDescInput.placeholder = t.app.fundDetail.propose.descriptionPlaceholder;
            
            const proposeDescHelp = document.querySelector('label[for="proposalDescription"] + textarea + small');
            if (proposeDescHelp) proposeDescHelp.textContent = t.app.fundDetail.propose.descriptionHelp;
            
            const proposeBtn = document.querySelector('#createProposalBtn');
            if (proposeBtn) proposeBtn.textContent = `📝 ${t.app.fundDetail.propose.button}`;
            
            // Propose Tab - Member Selection
            const involvedMembersLabel = document.querySelector('label[for="involvedMembers"]');
            if (involvedMembersLabel) involvedMembersLabel.textContent = t.app.fundDetail.propose.involvedMembersLabel;
            
            const selectAllMembersBtn = document.getElementById('selectAllMembersBtn');
            if (selectAllMembersBtn) selectAllMembersBtn.textContent = `✓ ${t.app.fundDetail.propose.selectAllMembers}`;
            
            const deselectAllMembersBtn = document.getElementById('deselectAllMembersBtn');
            if (deselectAllMembersBtn) deselectAllMembersBtn.textContent = `✗ ${t.app.fundDetail.propose.deselectAllMembers}`;
            
            const involvedMembersHelp = document.querySelector('#proposeTab .form-group small:last-of-type');
            if (involvedMembersHelp) involvedMembersHelp.textContent = t.app.fundDetail.propose.involvedMembersHelp;
            
            // Vote Tab
            const voteTitle = document.querySelector('#voteTab h3');
            if (voteTitle) voteTitle.textContent = `🗳️ ${t.app.fundDetail.vote.title}`;
            
            const voteDescription = document.querySelector('#voteTab .tab-description');
            if (voteDescription) voteDescription.textContent = t.app.fundDetail.vote.description;
            
            const noProposalsTitle = document.querySelector('#noProposals h4');
            if (noProposalsTitle) noProposalsTitle.textContent = t.app.fundDetail.vote.noProposals;
            
            const noProposalsSubtitle = document.querySelector('#noProposals p');
            if (noProposalsSubtitle) noProposalsSubtitle.textContent = t.app.fundDetail.vote.noProposalsSubtitle;
            
            // History Tab
            const historyTitle = document.querySelector('#historyTab h3');
            if (historyTitle) historyTitle.textContent = `📜 ${t.app.fundDetail.history.title}`;
            
            const historyDescription = document.querySelector('#historyTab .tab-description');
            if (historyDescription) historyDescription.textContent = t.app.fundDetail.history.description;
            
            const noHistoryTitle = document.querySelector('#noHistory h4');
            if (noHistoryTitle) noHistoryTitle.textContent = t.app.fundDetail.history.empty;
            
            const noHistorySubtitle = document.querySelector('#noHistory p');
            if (noHistorySubtitle) noHistorySubtitle.textContent = t.app.fundDetail.history.emptySubtitle;
            
            // Balances Tab
            const balancesTitle = document.querySelector('#balancesTab h3');
            if (balancesTitle) balancesTitle.textContent = `⚖️ ${t.app.fundDetail.balances.title}`;
            
            const balancesDescription = document.querySelector('#balancesTab .tab-description');
            if (balancesDescription) balancesDescription.textContent = t.app.fundDetail.balances.description;
            
            const totalContributedLabel = document.querySelectorAll('.balance-stat-label')[0];
            if (totalContributedLabel) totalContributedLabel.textContent = t.app.fundDetail.balances.totalContributions;
            
            const totalSpentLabel = document.querySelectorAll('.balance-stat-label')[1];
            if (totalSpentLabel) totalSpentLabel.textContent = t.app.fundDetail.balances.totalExpenses;
            
            const availableBalanceLabel = document.querySelectorAll('.balance-stat-label')[2];
            if (availableBalanceLabel) availableBalanceLabel.textContent = t.app.fundDetail.balances.currentBalance;
            
            const balancesHowItWorks = document.querySelector('#balancesTab .info-box p strong');
            if (balancesHowItWorks) balancesHowItWorks.textContent = `💡 ${t.app.fundDetail.balances.howItWorks}`;
            
            const balancesHowItWorksList = document.querySelector('#balancesTab .info-box ul');
            if (balancesHowItWorksList) {
                balancesHowItWorksList.innerHTML = t.app.fundDetail.balances.howItWorksPoints.map(point => `<li>${point}</li>`).join('');
            }
            
            const noBalancesTitle = document.querySelector('#noBalances h4');
            if (noBalancesTitle) noBalancesTitle.textContent = t.app.fundDetail.balances.empty;
            
            const noBalancesSubtitle = document.querySelector('#noBalances p');
            if (noBalancesSubtitle) noBalancesSubtitle.textContent = t.app.fundDetail.balances.emptySubtitle;
            
            // QR Scanner Modal
            const qrScannerTitle = document.querySelector('#qrScannerTitle');
            if (qrScannerTitle) qrScannerTitle.textContent = `📷 ${t.app.fundDetail.qrScanner.title}`;
            
            const qrWarningTitle = document.querySelector('#qrWarningTitle');
            if (qrWarningTitle) qrWarningTitle.textContent = `⚠️ ${t.app.fundDetail.qrScanner.warning}`;
            
            const qrWarningList = document.querySelector('#qrWarningList');
            if (qrWarningList) {
                qrWarningList.innerHTML = t.app.fundDetail.qrScanner.warningPoints.map(point => {
                    const parts = point.split(':');
                    if (parts.length > 1) {
                        return `<li><strong>${parts[0]}:</strong>${parts[1]}</li>`;
                    }
                    return `<li>${point}</li>`;
                }).join('');
            }
            
            const qrDetectedLabel = document.querySelector('#qrDetectedLabel');
            if (qrDetectedLabel) qrDetectedLabel.textContent = `✅ ${t.app.fundDetail.qrScanner.detected}`;
            
            const qrFinalConfirmTitle = document.querySelector('#qrFinalConfirmTitle');
            if (qrFinalConfirmTitle) qrFinalConfirmTitle.textContent = `🚨 ${t.app.fundDetail.qrScanner.finalConfirmation}`;
            
            const qrConfirmationText = document.querySelector('#qrConfirmationText');
            if (qrConfirmationText) qrConfirmationText.textContent = t.app.fundDetail.qrScanner.confirmationText;
            
            const qrConfirmationList = document.querySelector('#qrConfirmationList');
            if (qrConfirmationList) {
                qrConfirmationList.innerHTML = t.app.fundDetail.qrScanner.confirmationPoints.map(point => {
                    if (point.includes('Base blockchain')) {
                        return `<li>${point.replace('Base blockchain', '<strong>Base blockchain</strong>')}</li>`;
                    }
                    if (point.includes('blockchain de Base')) {
                        return `<li>${point.replace('blockchain de Base', '<strong>blockchain de Base</strong>')}</li>`;
                    }
                    if (point.includes('cannot be recovered') || point.includes('no pueden recuperarse')) {
                        return `<li>${point.replace('cannot be recovered', '<strong>cannot be recovered</strong>').replace('no pueden recuperarse', '<strong>no pueden recuperarse</strong>')}</li>`;
                    }
                    return `<li>${point}</li>`;
                }).join('');
            }
            
            const qrCheckboxLabel = document.querySelector('#qrCheckboxLabel');
            if (qrCheckboxLabel) qrCheckboxLabel.textContent = t.app.fundDetail.qrScanner.checkboxLabel;
            
            const confirmQRBtn = document.querySelector('#confirmQRBtn');
            if (confirmQRBtn) confirmQRBtn.innerHTML = `✓ ${t.app.fundDetail.qrScanner.confirmButton}`;
            
            const qrCancelBtn2 = document.querySelector('#qrCancelBtn2');
            if (qrCancelBtn2) qrCancelBtn2.textContent = t.app.fundDetail.qrScanner.cancelButton;
            
            const cancelScanBtn = document.querySelector('#cancelScanBtn');
            if (cancelScanBtn) cancelScanBtn.textContent = t.app.fundDetail.qrScanner.cancelScan;
            
            // Create Fund Modal
            const createFundTitle = document.querySelector('#createFundModal h2');
            if (createFundTitle) createFundTitle.textContent = `✨ ${t.app.createFund.title}`;
            
            // Section headers
            // Section headers (removed fund type and privacy sections)
            // No section headers to translate now
            
            // Form fields
            const fundNameLabel = document.querySelector('label[for="fundName"] .label-text');
            if (fundNameLabel) fundNameLabel.textContent = t.app.createFund.fields.name;
            
            const fundNameInput = document.querySelector('#fundName');
            if (fundNameInput) fundNameInput.placeholder = t.app.createFund.fields.namePlaceholder;
            
            const fundDescLabel = document.querySelector('label[for="fundDescription"] .label-text');
            if (fundDescLabel) fundDescLabel.textContent = t.app.createFund.fields.description;
            
            const fundDescInput = document.querySelector('#fundDescription');
            if (fundDescInput) fundDescInput.placeholder = t.app.createFund.fields.descriptionPlaceholder;
            
            // Voting fields
            const approvalLabel = document.querySelector('label[for="approvalPercentage"] .label-text');
            if (approvalLabel) approvalLabel.textContent = t.app.createFund.fields.approvalPercentage;
            
            const approvalParent = document.querySelector('label[for="approvalPercentage"]');
            if (approvalParent) {
                const approvalHint = approvalParent.parentElement.querySelector('.form-hint');
                if (approvalHint) approvalHint.textContent = t.app.createFund.fields.approvalHint;
            }
            
            const minimumVotesLabel = document.querySelector('label[for="minimumVotes"] .label-text');
            if (minimumVotesLabel) minimumVotesLabel.textContent = t.app.createFund.fields.minimumVotes;
            
            const minimumVotesParent = document.querySelector('label[for="minimumVotes"]');
            if (minimumVotesParent) {
                const minimumVotesHint = minimumVotesParent.parentElement.querySelector('.form-hint');
                if (minimumVotesHint) minimumVotesHint.textContent = t.app.createFund.fields.minimumVotesHint;
            }
            
            // Buttons
            const cancelCreateBtn = document.querySelector('#createFundModal .btn-secondary');
            if (cancelCreateBtn) cancelCreateBtn.textContent = t.app.createFund.buttons.cancel;
            
            const createSubmitBtn = document.querySelector('#createFundModal .btn-primary[type="submit"]');
            if (createSubmitBtn) createSubmitBtn.innerHTML = `🚀 ${t.app.createFund.buttons.create}`;
        }

        function updateAppSettingsUI() {
            const currentLang = getCurrentLanguage();
            const currentTheme = getCurrentTheme();
            const settings = translations[currentLang].settings;
            
            // Update settings title
            const settingsTitleText = document.querySelector('#appSettingsModal .settings-title-text');
            if (settingsTitleText) settingsTitleText.textContent = settings.title;
            
            // Update language buttons
            document.querySelectorAll('[data-lang]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
            
            // Update theme buttons
            document.querySelectorAll('[data-theme]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === currentTheme);
            });
        }

        // Initialize settings UI on load
        document.addEventListener('DOMContentLoaded', () => {
            applyAppTranslations();
            updateAppSettingsUI();
        });
    </script>

    <!-- Recurring Expense Modal -->
    <div id="recurringExpenseModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>🔄 Create Recurring Expense</h2>
                <button class="modal-close" onclick="closeRecurringExpenseModal()">&times;</button>
            </div>
            
            <form id="recurringExpenseForm" class="expense-form-clean">
                <div class="form-header-clean">
                    <h3>Automate Regular Expenses</h3>
                    <p style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                        Perfect for rent, utilities, subscriptions, or any expense that repeats regularly.
                    </p>
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="recurringDescription" class="form-label">Description *</label>
                        <input 
                            type="text" 
                            id="recurringDescription"
                            class="form-input"
                            placeholder="e.g., Monthly Rent, Netflix, Groceries"
                            required
                        >
                    </div>

                    <div class="form-field">
                        <label for="recurringAmount" class="form-label">Amount *</label>
                        <div class="amount-input-wrapper">
                            <span class="currency-symbol" id="recurringCurrencySymbol">$</span>
                            <input 
                                type="number" 
                                id="recurringAmount"
                                class="form-input amount-input"
                                placeholder="0.00"
                                step="any"
                                required
                            >
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="recurringCurrency" class="form-label">Currency</label>
                        <select id="recurringCurrency" class="form-input form-select" onchange="updateRecurringCurrencySymbol()">
                            <option value="USD" selected>🇺🇸 USD</option>
                            <option value="EUR">🇪🇺 EUR</option>
                            <option value="GBP">🇬🇧 GBP</option>
                            <option value="MXN">🇲🇽 MXN</option>
                            <option value="COP">🇨🇴 COP</option>
                            <option value="BRL">🇧🇷 BRL</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="recurringCategory" class="form-label">Category</label>
                        <select id="recurringCategory" class="form-input form-select">
                            <option value="food">🍕 Food & Dining</option>
                            <option value="transport">🚗 Transportation</option>
                            <option value="housing" selected>🏠 Housing & Rent</option>
                            <option value="utilities">💡 Utilities</option>
                            <option value="entertainment">🎬 Entertainment</option>
                            <option value="shopping">🛍️ Shopping</option>
                            <option value="health">⚕️ Health & Medical</option>
                            <option value="travel">✈️ Travel</option>
                            <option value="subscription">📺 Subscriptions</option>
                            <option value="other">🎯 Other</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="recurringFrequency" class="form-label">Frequency *</label>
                        <select id="recurringFrequency" class="form-input form-select" onchange="updateRecurringFrequencyOptions()">
                            <option value="daily">📅 Daily</option>
                            <option value="weekly">📆 Weekly</option>
                            <option value="monthly" selected>🗓️ Monthly</option>
                        </select>
                    </div>

                    <div class="form-field" id="dayOfMonthField">
                        <label for="recurringDayOfMonth" class="form-label">Day of Month *</label>
                        <select id="recurringDayOfMonth" class="form-input form-select">
                            <option value="1" selected>1st of month</option>
                            <option value="15">15th of month</option>
                            <option value="30">30th of month (last day for shorter months)</option>
                        </select>
                        <small class="field-hint">When should this expense be created each month?</small>
                    </div>

                    <div class="form-field" id="dayOfWeekField" style="display: none;">
                        <label for="recurringDayOfWeek" class="form-label">Day of Week *</label>
                        <select id="recurringDayOfWeek" class="form-input form-select">
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                            <option value="7">Sunday</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Paid by *</label>
                        <div id="recurringPaidBy" class="split-members-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Split between *</label>
                        <div class="info-box" style="margin-bottom: 0.75rem; background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); padding: 0.75rem;">
                            <p style="margin: 0; font-size: 0.85rem; display: flex; align-items: start; gap: 0.5rem;">
                                <span style="font-size: 1rem;">💡</span>
                                <span>
                                    <strong>Flexible splitting:</strong> Use the <strong>+</strong> and <strong>−</strong> buttons to add portions when a member covers for external guests.
                                </span>
                            </p>
                        </div>
                        <div id="recurringSplitBetween" class="split-members-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRecurringExpenseModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        🔄 Create Recurring Expense
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>💰 Set Group Budget</h2>
                <button class="modal-close" onclick="closeBudgetModal()">&times;</button>
            </div>
            
            <form id="budgetForm" class="expense-form-clean">
                <div class="form-header-clean" style="padding: 1rem 1.5rem 0;">
                    <p style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin: 0;">
                        Set a spending limit and get alerts when approaching it. Perfect for trips or monthly shared costs.
                    </p>
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="budgetAmount" class="form-label">Budget Amount *</label>
                        <div class="amount-input-wrapper">
                            <span class="currency-symbol" id="budgetCurrencySymbol">$</span>
                            <input 
                                type="number" 
                                id="budgetAmount"
                                class="form-input amount-input"
                                placeholder="2000"
                                step="any"
                                required
                            >
                        </div>
                        <small class="field-hint">Total amount you plan to spend</small>
                    </div>

                    <div class="form-field">
                        <label for="budgetCurrency" class="form-label">Currency</label>
                        <select id="budgetCurrency" class="form-input form-select" onchange="updateBudgetCurrencySymbol()">
                            <option value="USD" selected>🇺🇸 USD</option>
                            <option value="EUR">🇪🇺 EUR</option>
                            <option value="GBP">🇬🇧 GBP</option>
                            <option value="MXN">🇲🇽 MXN</option>
                            <option value="COP">🇨🇴 COP</option>
                            <option value="BRL">🇧🇷 BRL</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="budgetPeriod" class="form-label">Budget Period *</label>
                        <select id="budgetPeriod" class="form-input form-select">
                            <option value="trip">🏖️ One-time (trip/event)</option>
                            <option value="monthly">📆 Monthly</option>
                            <option value="weekly">📅 Weekly</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Alerts</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="alert50" checked>
                                <span>50%</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="alert80" checked>
                                <span>80%</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="alert100" checked>
                                <span>100%</span>
                            </label>
                        </div>
                        <small class="field-hint">Visual warnings when thresholds are reached</small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBudgetModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        💰 Set Budget
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>📊 Expense Analytics</h2>
                <button class="modal-close" onclick="closeAnalyticsModal()">&times;</button>
            </div>
            
            <div class="analytics-container">
                <!-- Timeframe selector -->
                <div class="timeframe-selector" style="margin-bottom: 2rem;">
                    <button class="btn-timeframe active" onclick="switchTimeframe('week')">Week</button>
                    <button class="btn-timeframe" onclick="switchTimeframe('month')">Month</button>
                    <button class="btn-timeframe" onclick="switchTimeframe('year')">Year</button>
                    <button class="btn-timeframe" onclick="switchTimeframe('all')">All Time</button>
                </div>

                <!-- Summary Stats -->
                <div id="analyticsStats" class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- Populated dynamically -->
                </div>

                <!-- Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="chart-container">
                        <h3 style="margin-bottom: 1rem;">By Category</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="margin-bottom: 1rem;">By Member</h3>
                        <canvas id="memberChart"></canvas>
                    </div>
                </div>

                <div class="chart-container" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Spending Over Time</h3>
                    <canvas id="timelineChart"></canvas>
                </div>

                <!-- Export Options -->
                <div class="export-section" style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">📥 Export Data</h3>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="exportToCSV()">
                            📄 Export to CSV
                        </button>
                        <button class="btn btn-secondary" onclick="exportToPDF()">
                            📑 Export to PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recurring Expense Details/Edit Modal -->
    <div id="recurringDetailsModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>🔄 Recurring Expense Details</h2>
                <button class="modal-close" onclick="closeRecurringDetailsModal()">&times;</button>
            </div>
            
            <div id="recurringDetailsContent" style="padding: 1.5rem;">
                <!-- Populated dynamically -->
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRecurringDetailsModal()">
                    Close
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteRecurring()">
                    🗑️ Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Recurring Expenses Modal (List View) -->
    <div id="manageRecurringModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>🔄 Manage Recurring Expenses</h2>
                <button class="modal-close" onclick="closeManageRecurringModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <p style="color: rgba(255,255,255,0.7); margin: 0;">
                        View and manage all your recurring expenses. Click on any expense to see details and make changes.
                    </p>
                    <button class="btn btn-primary" onclick="closeManageRecurringModal(); showRecurringExpenseModal();">
                        ➕ Add New
                    </button>
                </div>
                
                <div id="manageRecurringList">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- OpenAI Configuration Modal -->
    <div id="openaiConfigModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>🔑 Configure OpenAI API</h2>
                <button class="modal-close" onclick="closeOpenAIConfigModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem;">
                    To use receipt scanning, you need an OpenAI API key. Your key is stored locally and never shared.
                </p>
                
                <div class="form-field">
                    <label for="openaiApiKey" class="form-label">OpenAI API Key</label>
                    <input 
                        type="password" 
                        id="openaiApiKey"
                        class="form-input"
                        placeholder="sk-..."
                    >
                    <small class="field-hint">
                        Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #667eea;">platform.openai.com</a>
                    </small>
                </div>
                
                <div style="background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <strong style="color: #667eea;">💡 Tip:</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                        Each receipt scan costs approximately $0.01-0.03 USD. Your API key is stored in your browser's local storage.
                    </p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeOpenAIConfigModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveOpenAIConfig()">
                    💾 Save API Key
                </button>
            </div>
        </div>
    </div>

    <!-- Cookie Consent -->
    <script src="cookie-consent.js"></script>
    
    <!-- Analytics Events -->
    <script>
        // Track key user actions
        function trackEvent(eventName, eventParams = {}) {
            if (typeof gtag !== 'undefined' && window.CookieConsent && window.CookieConsent.isAnalyticsEnabled()) {
                gtag('event', eventName, eventParams);
            }
        }
        
        // Track group creation
        window.addEventListener('groupCreated', function(e) {
            trackEvent('group_created', {
                'group_type': e.detail.type || 'unknown'
            });
        });
        
        // Track expense added
        window.addEventListener('expenseAdded', function(e) {
            trackEvent('expense_added', {
                'amount_usd': e.detail.amount || 0
            });
        });
        
        // Track wallet connection
        window.addEventListener('walletConnected', function(e) {
            trackEvent('wallet_connected', {
                'wallet_type': e.detail.wallet || 'unknown'
            });
        });
    </script>

    <!-- Service Worker Registration & PWA Install -->
    <script>
        // PWA Install Prompt
        let deferredPrompt;
        let installPromptDismissed = localStorage.getItem('pwaInstallDismissed') === 'true';

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt if not dismissed
            if (!installPromptDismissed) {
                const promptEl = document.getElementById('pwaInstallPrompt');
                if (promptEl) {
                    promptEl.style.display = 'block';
                    setTimeout(() => promptEl.classList.add('show'), 100);
                }
            }
        });

        // Install button click
        document.addEventListener('DOMContentLoaded', () => {
            const installBtn = document.getElementById('installPWAButton');
            const dismissBtn = document.getElementById('dismissPWAPrompt');
            const promptEl = document.getElementById('pwaInstallPrompt');

            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('✅ PWA installed');
                        showToast('App installed successfully! 🎉', 'success');
                    }
                    
                    deferredPrompt = null;
                    promptEl.style.display = 'none';
                });
            }

            if (dismissBtn) {
                dismissBtn.addEventListener('click', () => {
                    promptEl.classList.remove('show');
                    setTimeout(() => {
                        promptEl.style.display = 'none';
                    }, 300);
                    localStorage.setItem('pwaInstallDismissed', 'true');
                    installPromptDismissed = true;
                });
            }
        });

        // Service Worker Registration with visual feedback
        if ('serviceWorker' in navigator) {
            let swInstalling = false;
            
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => {
                        console.log('✅ Service Worker registered:', reg.scope);
                        
                        // Show installing message
                        if (reg.installing) {
                            swInstalling = true;
                            showToast('Installing app for offline use... 📦', 'info', 0);
                        } else if (reg.active) {
                            // Already installed and active
                            // showOfflineReadyIndicator();
                        }
                        
                        // Listen for Service Worker state changes
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // Update available
                                        showToast('New version available! Refresh to update. 🔄', 'info', 0);
                                    } else {
                                        // First install
                                        if (swInstalling) {
                                            // Hide installing toast
                                            const toasts = document.querySelectorAll('.toast');
                                            toasts.forEach(toast => {
                                                if (toast.textContent.includes('Installing')) {
                                                    toast.remove();
                                                }
                                            });
                                        }
                                        // showToast('App installed! Ready for offline use ✓', 'success');
                                        // showOfflineReadyIndicator();
                                    }
                                }
                                
                                if (newWorker.state === 'activated') {
                                    console.log('✅ Service Worker activated');
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.error('❌ Service Worker registration failed:', err);
                        showToast('Offline mode unavailable', 'error');
                    });
                
                // Listen for controller change (new SW activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('🔄 New Service Worker activated');
                });
            });
        }

        // Show offline-ready indicator
        function showOfflineReadyIndicator() {
            const indicator = document.getElementById('offlineReadyIndicator');
            if (indicator) {
                indicator.style.display = 'block';
                setTimeout(() => indicator.classList.add('show'), 100);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    indicator.classList.remove('show');
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 300);
                }, 5000);
            }
        }

        // Online/Offline status
        window.addEventListener('online', () => {
            showToast('Back online! 🌐', 'success');
        });

        window.addEventListener('offline', () => {
            showToast('You\'re offline. Using cached version 📴', 'warning', 0);
        });
    </script>

    <!-- Challenge Mode Modal -->
    <div id="challengeModeModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>🎮 Challenge Mode</h2>
                <button class="modal-close" onclick="closeChallengeModal()">&times;</button>
            </div>
            
            <!-- Step 1: Mode Selection -->
            <div id="challengeModeSelection" class="challenge-step">
                <div class="challenge-intro">
                    <h3>Who will pay?</h3>
                    <p>Make it fun! Choose how to decide who pays for this expense.</p>
                </div>
                
                <div class="mode-options">
                    <div class="mode-card" onclick="selectChallengeMode('physical')">
                        <div class="mode-icon">🎯</div>
                        <h4>We're Together</h4>
                        <p>Play mini-games by passing the phone around</p>
                        <div class="mode-badge">Interactive Games</div>
                    </div>
                    
                    <div class="mode-card" onclick="selectChallengeMode('remote')">
                        <div class="mode-icon">🎲</div>
                        <h4>We're Apart</h4>
                        <p>Automatic selection methods</p>
                        <div class="mode-badge">Quick & Easy</div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2a: Game Selection (Physical Mode) -->
            <div id="gameSelection" class="challenge-step" style="display: none;">
                <div class="challenge-intro">
                    <button class="btn-back" onclick="resetChallengeState()">← Back</button>
                    <h3>Choose Your Game</h3>
                    <p>Everyone will play - the loser pays!</p>
                </div>
                
                <div class="game-grid">
                    <div class="game-card" onclick="selectGame('quickTap')">
                        <div class="game-icon">⚡</div>
                        <h4>Quick Tap</h4>
                        <p>Tap when the button turns green!</p>
                        <div class="game-difficulty easy">EASY</div>
                    </div>
                    
                    <div class="game-card" onclick="selectGame('numberGuess')">
                        <div class="game-icon">🎯</div>
                        <h4>Number Guess</h4>
                        <p>Guess a number between 1-100</p>
                        <div class="game-difficulty medium">MEDIUM</div>
                    </div>
                    
                    <div class="game-card disabled" title="Coming soon!">
                        <div class="game-icon">🎨</div>
                        <h4>Color Match</h4>
                        <p>Say the color, not the word!</p>
                        <div class="game-difficulty medium">COMING SOON</div>
                    </div>
                    
                    <div class="game-card disabled" title="Coming soon!">
                        <div class="game-icon">📳</div>
                        <h4>Shake It!</h4>
                        <p>Shake your phone the hardest!</p>
                        <div class="game-difficulty fun">COMING SOON</div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2b: Remote Selection Options -->
            <div id="remoteSelection" class="challenge-step" style="display: none;">
                <div class="challenge-intro">
                    <button class="btn-back" onclick="resetChallengeState()">← Back</button>
                    <h3>Selection Method</h3>
                    <p>How should we choose who pays?</p>
                </div>
                
                <div class="remote-options">
                    <div class="remote-card" onclick="selectRemoteMethod('random')">
                        <div class="remote-icon">🎰</div>
                        <h4>Random Spin</h4>
                        <p>Everyone has equal chance</p>
                        <small style="color: #888; margin-top: 0.5rem; display: block;">Classic spin the wheel - completely random selection with no bias. Most transparent and fun!</small>
                        <div class="remote-badge">Most Fair</div>
                    </div>
                    
                    <div class="remote-card" onclick="selectRemoteMethod('fair')">
                        <div class="remote-icon">⚖️</div>
                        <h4>Fair Rotation</h4>
                        <p>Tracks who paid last</p>
                        <small style="color: #888; margin-top: 0.5rem; display: block;">Automatically selects the person who has paid the fewest times recently. Ensures everyone contributes equally over time.</small>
                        <div class="remote-badge">Balanced</div>
                    </div>
                    
                    <div class="remote-card" onclick="selectRemoteMethod('balance')">
                        <div class="remote-icon">💰</div>
                        <h4>By Balance</h4>
                        <p>Who owes the most pays</p>
                        <small style="color: #888; margin-top: 0.5rem; display: block;">Selects based on current group balances. Person who has contributed least (or owes most) gets selected.</small>
                        <div class="remote-badge">Smart</div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Game Play Area -->
            <div id="gamePlay" class="challenge-step" style="display: none;">
                <div id="gamePlayArea">
                    <!-- Game content will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Load Challenge Games Script -->
    <script src="challenge-games.js"></script>

</body>
</html>
