<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://www.gstatic.com https://apis.google.com https://*.firebaseio.com;
        script-src-elem 'self' https://cdn.jsdelivr.net https://unpkg.com https://www.gstatic.com https://apis.google.com https://*.firebaseio.com;
        style-src 'self' 'unsafe-inline'; 
        img-src 'self' data: https:; 
        media-src 'self' blob:;
        font-src 'self' https://fonts.gstatic.com;
        frame-src 'self' https://*.firebaseapp.com https://accounts.google.com;
        connect-src 'self' http://127.0.0.1:8545 http://localhost:8545 https://*.base.org https://*.polygon.technology https://polygon-rpc.com https://*.basescan.org https://*.polygonscan.com wss://*.base.org wss://*.polygon.technology https://*.walletconnect.com wss://*.walletconnect.com https://cdn.jsdelivr.net https://*.coinbase.com https://chain-proxy.wallet.coinbase.com wss://*.walletlink.org https://*.walletlink.org https://www.gstatic.com https://*.firebaseio.com wss://*.firebaseio.com https://*.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://apis.google.com https://accounts.google.com https://api.exchangerate-api.com https://api.openai.com;
    ">
    <title>Ant Pool - Cooperative Finance Colony</title>
    <meta name="description" content="Work together like ants. Share expenses the simple way or use blockchain for automatic payments. Your choice.">
    <link rel="icon" type="image/x-icon" href="/assets/ant_pool_icon.ico">
    <link rel="stylesheet" href="styles-platform.css">
    <link rel="stylesheet" href="wallet-connector.css">
    <link rel="stylesheet" href="create-group-styles.css">
    <link rel="stylesheet" href="simple-mode-styles.css">
    <link rel="stylesheet" href="form-wizard-styles.css">
    <link rel="stylesheet" href="new-features-styles.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText" class="loading-text">Cargando...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Sign In Modal (for Simple Mode) -->
    <div id="signInModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>üîê Get Started - No Wallet Needed!</h2>
                <button class="modal-close" onclick="closeSignInModal()">&times;</button>
            </div>
            
            <div class="sign-in-content">
                <p class="sign-in-message">Start with Google/Email for <strong>Simple Mode</strong> (expense tracking). Connect wallet later if you want blockchain features.</p>
                
                <div class="sign-in-buttons">
                    <button class="btn btn-wallet" onclick="signInWithWallet()">
                        <span class="btn-icon">ü¶ä</span>
                        <span>Connect Wallet (MetaMask)</span>
                    </button>
                    <div class="sign-in-hint">
                        <strong>‚úÖ Full Access:</strong> Simple Mode + Blockchain Mode with automatic payments
                    </div>
                    
                    <div class="divider-text">
                        <span>or</span>
                    </div>
                    
                    <button class="btn btn-google" onclick="signInWithGoogleOnly()">
                        <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Continue with Google
                    </button>
                    <div class="sign-in-hint sign-in-warning">
                        <strong>‚ö†Ô∏è Limited Access:</strong> Simple Mode only (expense tracking). No blockchain features.
                    </div>
                    
                    <button class="btn btn-secondary" onclick="showEmailSignIn()">
                        üìß Sign in with Email
                    </button>
                    <div class="sign-in-hint sign-in-warning">
                        <strong>‚ö†Ô∏è Limited Access:</strong> Simple Mode only (expense tracking). No blockchain features.
                    </div>
                </div>
                
                <div id="emailSignInForm" style="display: none;">
                    <div class="sign-in-hint sign-in-warning" style="margin-bottom: 1rem;">
                        <strong>‚ö†Ô∏è Limited Access</strong>
                        Without wallet: Simple Mode only. Connect wallet later for blockchain features.
                    </div>
                    <form onsubmit="handleEmailSignIn(event)">
                        <div class="form-group">
                            <label for="signInEmail">Email</label>
                            <input type="email" id="signInEmail" class="input-modern" required>
                        </div>
                        <div class="form-group">
                            <label for="signInPassword">Password</label>
                            <input type="password" id="signInPassword" class="input-modern" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            Sign In
                        </button>
                        <button type="button" class="btn btn-link" onclick="showCreateAccount()">
                            Create new account
                        </button>
                        <button type="button" class="btn btn-link" onclick="closeEmailSignIn()">
                            Back to options
                        </button>
                    </form>
                </div>
                
                <div id="createAccountForm" style="display: none;">
                    <div class="sign-in-hint sign-in-warning" style="margin-bottom: 1rem;">
                        <strong>‚ö†Ô∏è Limited Access</strong>
                        Without wallet: Simple Mode only. Connect wallet later for blockchain features.
                    </div>
                    <form onsubmit="handleCreateAccount(event)">
                        <div class="form-group">
                            <label for="createName">Display Name</label>
                            <input type="text" id="createName" class="input-modern" required>
                        </div>
                        <div class="form-group">
                            <label for="createEmail">Email</label>
                            <input type="email" id="createEmail" class="input-modern" required>
                        </div>
                        <div class="form-group">
                            <label for="createPassword">Password</label>
                            <input type="password" id="createPassword" class="input-modern" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            Create Account
                        </button>
                        <button type="button" class="btn btn-link" onclick="showEmailSignIn()">
                            Back to Sign In
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="container">
            <div class="header-content">
                <div class="logo" onclick="goToHome()" style="cursor: pointer;" title="Go to Home">
                    <h1><img src="/assets/LogoAntPool.png" alt="Ant Pool" style="height: 36px; vertical-align: middle; margin-right: 10px;">Ant Pool</h1>
                    <span class="version-badge">üêú Simple Mode or Blockchain - You Choose</span>
                </div>
                
                <div class="header-actions">
                    <!-- Unified Session Badge -->
                    <div id="unifiedSessionBadge" class="unified-session-badge" style="display: none;">
                        <div class="session-info">
                            <div class="session-auth" id="sessionAuthDisplay">
                                <span class="session-icon">üë§</span>
                                <span id="sessionUserName"></span>
                            </div>
                            <div class="session-wallet" id="sessionWalletDisplay" style="display: none;">
                                <span class="session-icon">ü¶ä</span>
                                <span id="sessionWalletAddress"></span>
                            </div>
                        </div>
                        <div class="session-status" id="sessionStatus"></div>
                    </div>
                    <button class="settings-btn-app" onclick="openAppSettings()" title="Settings">
                        ‚öôÔ∏è
                    </button>
                    <button id="signOutFirebase" class="btn btn-secondary" style="display: none;" onclick="signOutFromFirebase()" title="Sign out from Google/Email">
                        <span class="btn-icon">üö™</span>
                        <span>Sign Out</span>
                    </button>
                    <button id="signInSimpleMode" class="btn btn-secondary" style="display: none;" onclick="showSignInModal()">
                        <span class="btn-icon">üîê</span>
                        <span>Sign In</span>
                    </button>
                    <button id="connectWallet" class="btn btn-primary">
                        <span class="btn-icon">ü¶ä</span>
                        <span>Conectar Wallet</span>
                    </button>
                    <button id="disconnectWallet" class="btn btn-secondary" style="display: none;">
                        <span class="btn-icon">üö™</span>
                        <span>Desconectar</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="appSettingsModal" class="modal-overlay" onclick="closeAppSettings(event)">
        <div class="settings-modal" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2><span class="settings-emoji">‚öôÔ∏è</span> <span class="settings-title-text">Settings</span></h2>
                <button class="close-btn" onclick="closeAppSettings()">&times;</button>
            </div>
            <div class="settings-content">
                <!-- Language Selection -->
                <div class="setting-group">
                    <label>üåç Language</label>
                    <div class="setting-options">
                        <button class="setting-option" data-lang="en" onclick="changeLanguage('en')">
                            <span class="option-flag">üá∫üá∏</span>
                            <span>English</span>
                            <span class="option-check">‚úì</span>
                        </button>
                        <button class="setting-option" data-lang="es" onclick="changeLanguage('es')">
                            <span class="option-flag">üá™üá∏</span>
                            <span>Espa√±ol</span>
                            <span class="option-check">‚úì</span>
                        </button>
                    </div>
                </div>

                <!-- Theme Selection -->
                <div class="setting-group">
                    <label>üé® Theme</label>
                    <div class="setting-options">
                        <button class="setting-option" data-theme="light" onclick="changeTheme('light')">
                            <span class="option-icon">‚òÄÔ∏è</span>
                            <span>Light Mode</span>
                            <span class="option-check">‚úì</span>
                        </button>
                        <button class="setting-option" data-theme="dark" onclick="changeTheme('dark')">
                            <span class="option-icon">üåô</span>
                            <span>Dark Mode</span>
                            <span class="option-check">‚úì</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="modal" style="display: none;">
        <div class="modal-content qr-scanner-modal">
            <div class="modal-header">
                <h3 id="qrScannerTitle">üì∑ Scan QR Code</h3>
                <button class="modal-close" id="closeQRScannerBtn1">&times;</button>
            </div>
            
            <div class="warning-box qr-warning">
                <p><strong id="qrWarningTitle">‚ö†Ô∏è IMPORTANT - Read carefully:</strong></p>
                <ul id="qrWarningList">
                    <li><strong>Base Network Only:</strong> The address MUST be a valid address on the <strong>Base blockchain</strong></li>
                    <li><strong>Verify carefully:</strong> If you send funds to an incorrect address, <strong>they will be lost forever</strong></li>
                    <li><strong>No refunds:</strong> Blockchain transactions are irreversible</li>
                    <li><strong>Your responsibility:</strong> Double-check that the address belongs to the intended recipient</li>
                </ul>
            </div>
            
            <div id="qrReader" class="qr-reader"></div>
            
            <div id="qrScanResult" style="display: none;">
                <div class="scan-result-box">
                    <p><strong id="qrDetectedLabel">‚úÖ Address detected:</strong></p>
                    <div class="address-display">
                        <code id="scannedAddress"></code>
                    </div>
                </div>
                
                <div class="warning-box critical-warning">
                    <p><strong id="qrFinalConfirmTitle">üö® FINAL CONFIRMATION</strong></p>
                    <p id="qrConfirmationText">By clicking "Confirm", you declare that:</p>
                    <ul id="qrConfirmationList">
                        <li>This address is correct and belongs to the intended recipient</li>
                        <li>This address is on the <strong>Base blockchain</strong></li>
                        <li>You understand that funds sent to an incorrect address <strong>cannot be recovered</strong></li>
                        <li>You assume full responsibility for this address</li>
                    </ul>
                    
                    <label class="checkbox-label">
                        <input type="checkbox" id="qrConfirmCheckbox">
                        <span id="qrCheckboxLabel">I have verified the address and accept full responsibility</span>
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="qrCancelBtn2">Cancel</button>
                    <button id="confirmQRBtn" class="btn btn-primary" disabled>
                        ‚úì Confirm and Use Address
                    </button>
                </div>
            </div>
            
            <button id="cancelScanBtn" class="btn btn-secondary btn-block">
                Cancel Scan
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            
            <!-- Nickname Setup Modal (first time users) -->
            <div id="nicknameModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h2>üëã ¬°Bienvenido a Ant Pool!</h2>
                    <p>Comparte gastos de forma simple o usa blockchain para pagos autom√°ticos. <strong>No necesitas wallet para empezar.</strong></p>
                    <p>Primero, establece un <strong>nickname</strong> para identificarte en los grupos.</p>
                    
                    <div class="form-group">
                        <label for="nicknameInput">Tu Nickname *</label>
                        <input 
                            type="text" 
                            id="nicknameInput" 
                            placeholder="Ej: Juan, Maria123, etc."
                            minlength="3"
                            maxlength="32"
                            pattern="[a-zA-Z0-9]+"
                            required
                        >
                        <small>3-32 caracteres, solo letras y n√∫meros. Te identificar√° en todos tus grupos.</small>
                    </div>
                    
                    <button id="setNicknameBtn" class="btn btn-primary btn-block">
                        Establecer Nickname y Continuar
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="dashboard-section">
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <h3 id="totalFundsCreated">0</h3>
                            <p>Grupos Creados</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3 id="totalFundsParticipating">0</h3>
                            <p>Grupos Activos</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">ÔøΩ</div>
                        <div class="stat-content">
                            <h3 id="totalValueLocked">$0.00</h3>
                            <p>Total Gastado (USD)</p>
                        </div>
                    </div>
                </div>

                <!-- Pending Invitations Banner -->
                <div id="pendingInvitationsSection" class="pending-invitations-section" style="display: none;">
                    <div class="invitations-header">
                        <h3>üé´ Invitaciones Pendientes</h3>
                        <span class="invitations-count" id="invitationsCount">0</span>
                    </div>
                    <div id="invitationsList" class="invitations-list">
                        <!-- Invitations will be loaded here -->
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="action-bar">
                    <h2>Mis Grupos</h2>
                    <button id="createFundBtn" class="btn btn-primary btn-create-group" title="Create a new expense group">
                        <span class="btn-icon">‚ûï</span>
                        <span class="btn-text">
                            <strong>Create New Group</strong>
                            <small>Tap here to create group</small>
                        </span>
                    </button>
                </div>

                <!-- Fund Filters -->
                <div class="fund-filters">
                    <button class="filter-btn active" data-filter="all">
                        Todos (<span id="countAll">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="created">
                        Creados (<span id="countCreated">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="participating">
                        Participando (<span id="countParticipating">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="travel">
                        üå¥ Viajes (<span id="countTravel">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="savings">
                        üí∞ Ahorros (<span id="countSavings">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="shared">
                        ü§ù Compartidos (<span id="countShared">0</span>)
                    </button>
                </div>

                <!-- Funds Grid -->
                <div id="fundsGrid" class="funds-grid">
                    <!-- Funds will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-icon">üöÄ</div>
                    <h3>¬°Comienza tu primera aventura!</h3>
                    <p>Crea tu primer grupo para gestionar gastos compartidos. <strong>Sin wallet necesaria</strong> - empieza con Simple Mode o usa blockchain para pagos autom√°ticos.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('createFundBtn').click()">
                        <span class="btn-icon">‚ú®</span>
                        <span>Crear Mi Primer Grupo</span>
                    </button>
                </div>

            </section>

            <!-- Fund Detail Section (Single Fund View) -->
            <section id="fundDetailSection" class="fund-detail-section">
                
                <!-- Back Button -->
                <div class="back-bar">
                    <button id="backToDashboard" class="btn btn-secondary">
                        <span class="btn-icon">‚Üê</span>
                        <span>Back to My Groups</span>
                    </button>
                </div>

                <!-- Fund Header -->
                <div class="fund-detail-header">
                    <div class="fund-header-icon" id="fundHeaderIcon">üå¥</div>
                    <div class="fund-header-info">
                        <h1 id="fundDetailName">Cargando...</h1>
                        <p id="fundDetailDescription">-</p>
                        <div class="fund-badges">
                            <span class="badge" id="fundTypeBadge">Tipo</span>
                            <span class="badge" id="fundStatusBadge">Estado</span>
                        </div>
                    </div>
                </div>

                <!-- Fund Stats Bar -->
                <div class="fund-stats-bar">
                    <div class="fund-stat-item stat-balance">
                        <span class="stat-label">üí∞ Total Balance</span>
                        <span class="stat-value" id="fundBalanceMain">0 ETH</span>
                        <div class="stat-breakdown" id="fundBalanceBreakdown" style="display: none;"></div>
                    </div>
                    <div class="fund-stat-item">
                        <span class="stat-label">üë• Members</span>
                        <span class="stat-value" id="fundMembers">0</span>
                    </div>
                    <div class="fund-stat-item">
                        <span class="stat-label">üí∏ Expenses</span>
                        <span class="stat-value" id="fundProposals">0</span>
                    </div>
                </div>

                <!-- Invitation Banner (if pending) -->
                <div id="invitationBanner" class="invitation-banner" style="display: none;">
                    <div class="invitation-content">
                        <span class="invitation-icon">üé´</span>
                        <p>You have a pending invitation for this fund</p>
                    </div>
                    <button id="acceptInvitationBtn" class="btn btn-primary">
                        Aceptar Invitaci√≥n
                    </button>
                </div>

                <!-- Closed Fund Banner -->
                <div id="closedFundBanner" class="closed-fund-banner" style="display: none;">
                    <div class="closed-fund-content">
                        <span class="closed-fund-icon">üîí</span>
                        <div>
                            <h4>Grupo Cerrado</h4>
                            <p>Este grupo ha sido cerrado permanentemente. Los fondos fueron distribuidos proporcionalmente entre todos los miembros.</p>
                        </div>
                    </div>
                </div>

                <!-- Fund Tabs -->
                <div class="fund-tabs">
                    <button class="fund-tab-btn active" data-tab="deposit">
                        <span class="tab-icon">üíµ</span>
                        <span>Depositar</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="invite">
                        <span class="tab-icon">üé´</span>
                        <span>Invitar</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="propose">
                        <span class="tab-icon">üìù</span>
                        <span>Proponer Gasto</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="vote">
                        <span class="tab-icon">üó≥Ô∏è</span>
                        <span>Votar</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="history">
                        <span class="tab-icon">üìú</span>
                        <span>Historial</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="balances">
                        <span class="tab-icon">‚öñÔ∏è</span>
                        <span>Balances</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="members">
                        <span class="tab-icon">üë•</span>
                        <span>Miembros</span>
                    </button>
                    <button class="fund-tab-btn" data-tab="manage">
                        <span class="tab-icon">‚öôÔ∏è</span>
                        <span>Gestionar</span>
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="fund-tab-content">
                    
                    <!-- Deposit Tab -->
                    <div id="depositTab" class="tab-pane active">
                        <div class="tab-card">
                            <h3>üí∞ Aportar al Bote Com√∫n</h3>
                            <p>Deposita dinero al grupo. √ötil para gastos futuros o para equilibrar balances.</p>
                            
                            <div class="form-group">
                                <label for="depositAmount">Monto a Depositar (ETH)</label>
                                <input type="number" id="depositAmount" placeholder="0.0" step="0.01" min="0.01">
                            </div>
                            
                            <div class="contribution-info">
                                <span>Tu contribuci√≥n actual: <strong id="userContribution">0 ETH</strong></span>
                            </div>
                            
                            <button id="depositBtn" class="btn btn-primary btn-block">
                                Aportar al Bote
                            </button>
                        </div>
                    </div>

                    <!-- Invite Tab -->
                    <div id="inviteTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>üé´ Invitar Miembros</h3>
                            <p>Invita amigos para que se unan al grupo. Ellos deber√°n aceptar la invitaci√≥n.</p>
                            
                            <div class="invite-info-box">
                                <p><strong>‚ÑπÔ∏è Informaci√≥n:</strong></p>
                                <ul>
                                    <li>Solo el creador del grupo puede invitar</li>
                                    <li>Los invitados ver√°n la invitaci√≥n en su dashboard</li>
                                    <li>Deben aceptar antes de poder registrar gastos</li>
                                    <li>No puedes invitarte a ti mismo</li>
                                </ul>
                            </div>
                            
                            <div class="form-group">
                                <label for="inviteAddress">Nickname o Direcci√≥n</label>
                                <input type="text" id="inviteAddress" placeholder="Ej: Bob o 0x123...">
                                <small>Ingresa el nickname del usuario o su direcci√≥n Ethereum</small>
                            </div>
                            
                            <button id="inviteBtn" class="btn btn-primary btn-block">
                                Enviar Invitaci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Propose Tab -->
                    <div id="proposeTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>üìù Proponer Gasto</h3>
                            <p>Prop√≥n usar dinero del bote com√∫n para pagar a un proveedor externo. El grupo votar√° si aprueba.</p>
                            
                            <div class="info-box">
                                <p><strong>üí° C√≥mo funciona:</strong></p>
                                <ul>
                                    <li>Prop√≥n pagar un gasto desde el bote com√∫n (hotel, restaurante, etc.)</li>
                                    <li>Indica a qui√©n se le pagar√° (proveedor externo con su direcci√≥n)</li>
                                    <li>El grupo vota si aprueba o rechaza usar el dinero del bote</li>
                                    <li>Si se aprueba, el dinero se env√≠a directo del bote al proveedor</li>
                                </ul>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalRecipient">A qui√©n se le pagar√° (Direcci√≥n del proveedor)</label>
                                <div class="input-with-button">
                                    <input type="text" id="proposalRecipient" placeholder="0x123... (direcci√≥n del hotel, restaurante, etc.)">
                                    <button type="button" id="openQRScannerBtn" class="btn-qr-scan" title="Scan QR Code">
                                        üì∑
                                    </button>
                                </div>
                                <small>Direcci√≥n Ethereum del agente externo que recibir√° el pago</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalAmount">Monto a Pagar (ETH)</label>
                                <input type="number" id="proposalAmount" placeholder="0.0" step="0.01" min="0.01">
                                <small>Cantidad que se pagar√° del bote com√∫n al proveedor</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="proposalDescription">Descripci√≥n del Gasto</label>
                                <textarea id="proposalDescription" rows="3" placeholder="Ej: Hotel 3 noches en Canc√∫n - Pago a Marriott, Cena grupal en Restaurante La Costa..."></textarea>
                                <small>Explica el motivo del gasto y a qui√©n se le pagar√°</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="involvedMembers">¬øQui√©nes est√°n involucrados en este gasto?</label>
                                <div class="info-box warning" style="margin-bottom: 1rem; background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3);">
                                    <p><strong>‚ö†Ô∏è IMPORTANTE:</strong></p>
                                    <ul style="margin: 0.5rem 0 0 1.2rem; font-size: 0.9rem;">
                                        <li><strong>Only selected members can vote!</strong></li>
                                        <li>Make sure to check YOUR OWN checkbox if you want to vote</li>
                                        <li>If you uncheck yourself, you won't be able to vote on your own proposal</li>
                                    </ul>
                                </div>
                                <div class="info-box" style="margin-bottom: 1rem; background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3);">
                                    <p><strong>üí° Flexible Bill Splitting:</strong></p>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                        Use the <strong>+</strong> and <strong>‚àí</strong> buttons to add extra portions when a member covers for people outside the group. 
                                        For example: if your sister brings 2 friends, add 3 portions (her + 2 friends) and the expense will be split counting her 3 times.
                                    </p>
                                </div>
                                <div class="members-selection-actions">
                                    <button type="button" id="selectAllMembersBtn" class="btn-select-action">
                                        ‚úì Seleccionar Todos
                                    </button>
                                    <button type="button" id="deselectAllMembersBtn" class="btn-select-action">
                                        ‚úó Deseleccionar Todos
                                    </button>
                                </div>
                                <div id="involvedMembersList" class="members-checkbox-list">
                                    <!-- Member checkboxes will be loaded here -->
                                </div>
                                <small>Selecciona los miembros que compartir√°n este gasto. Usa los botones +/‚àí para ajustar cu√°ntas porciones del gasto corresponden a cada miembro.</small>
                            </div>
                            
                            <button id="createProposalBtn" class="btn btn-primary btn-block">
                                üìù Proponer Uso de Fondos
                            </button>
                        </div>
                    </div>

                    <!-- Vote Tab -->
                    <div id="voteTab" class="tab-pane">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3>üó≥Ô∏è Votar Propuestas</h3>
                                <p class="tab-description">Propuestas de uso de fondos. Vota si apruebas o rechazas pagar a cada proveedor.</p>
                            </div>
                            <button onclick="refreshCurrentView()" class="btn btn-secondary" style="height: fit-content;" title="Refresh proposals from blockchain">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div id="proposalsList">
                            <!-- Proposals will be loaded here -->
                        </div>
                        <div id="noProposals" class="empty-state" style="display: none;">
                            <div class="empty-icon">üìã</div>
                            <h4>No hay propuestas activas</h4>
                            <p>Crea la primera propuesta para este fondo</p>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div id="historyTab" class="tab-pane">
                        <!-- Simple Mode: Add Expense Action Card -->
                        <div id="simpleAddExpenseCard" class="action-card" style="display: none;">
                            <div class="action-card-content">
                                <div class="action-card-icon">üí∏</div>
                                <div class="action-card-text">
                                    <h4>Register an Expense</h4>
                                    <p>Track shared expenses with your group. Split costs fairly and keep everyone in sync.</p>
                                </div>
                                <button id="addExpenseCardBtn" class="btn btn-primary btn-large btn-add-expense" title="Click to add a new expense">
                                    <span class="btn-icon">üíµ</span>
                                    <span class="btn-text">
                                        <strong>Add Expense</strong>
                                        <small>Click to add new payment</small>
                                    </span>
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions for New Features -->
                        <div id="simpleQuickActions" class="quick-actions-compact" style="display: none; margin-bottom: 1rem;">
                            <button class="quick-action-btn-compact" onclick="showRecurringExpenseModal()" title="Set up recurring expenses like rent or subscriptions">
                                <span class="quick-icon">üîÑ</span>
                                <span class="quick-label">Recurring</span>
                            </button>
                            
                            <button class="quick-action-btn-compact" onclick="showBudgetModal()" title="Set spending limits and get alerts">
                                <span class="quick-icon">üí∞</span>
                                <span class="quick-label">Budget</span>
                            </button>
                            
                            <button class="quick-action-btn-compact" onclick="showAnalyticsModal()" title="View spending analytics and insights">
                                <span class="quick-icon">üìä</span>
                                <span class="quick-label">Analytics</span>
                            </button>
                            
                            <button class="quick-action-btn-compact" onclick="showOpenAIConfigModal()" title="Configure OpenAI for receipt scanning">
                                <span class="quick-icon">üîë</span>
                                <span class="quick-label">AI Setup</span>
                            </button>
                        </div>

                        <!-- Budget Status Bar (if budget is set) -->
                        <div id="budgetStatusBar" style="display: none; margin-bottom: 1.5rem;">
                            <div class="collapsible-header" onclick="toggleCollapsible('budgetContent')" style="background: rgba(255,255,255,0.05); padding: 1rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s ease;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem;">üí∞</span>
                                    <strong style="font-size: 1rem;">Budget Tracker</strong>
                                </div>
                                <span id="budgetContentToggle" style="font-size: 1.2rem; transition: transform 0.3s ease;">‚ñº</span>
                            </div>
                            <div id="budgetContent" class="collapsible-content" style="display: none; margin-top: 0.5rem;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- Active Recurring Expenses -->
                        <div id="recurringExpensesSection" style="display: none; margin-bottom: 1.5rem;">
                            <div class="collapsible-header" onclick="toggleCollapsible('recurringContent')" style="background: rgba(255,255,255,0.05); padding: 1rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s ease;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem;">üîÑ</span>
                                    <strong style="font-size: 1rem;">Active Recurring Expenses</strong>
                                    <span id="recurringCount" class="badge-count" style="background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">0</span>
                                </div>
                                <span id="recurringContentToggle" style="font-size: 1.2rem; transition: transform 0.3s ease;">‚ñº</span>
                            </div>
                            <div id="recurringContent" class="collapsible-content" style="display: none; margin-top: 0.5rem;">
                                <div style="display: flex; justify-content: flex-end; margin-bottom: 0.75rem;">
                                    <button class="btn btn-secondary btn-small" onclick="showManageRecurringModal()" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                                        üìã View All
                                    </button>
                                </div>
                                <div id="recurringExpensesList" class="recurring-list">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <h3>üìú Proposal History</h3>
                        <p class="tab-description">All proposals: executed, cancelled and expired</p>
                        
                        <!-- Expense Search Filter - Collapsible -->
                        <div id="expenseSearchSection" style="display: none; margin-bottom: 1rem;">
                            <div class="collapsible-header" onclick="toggleCollapsible('searchContent')" style="background: rgba(255,255,255,0.05); padding: 1rem 1.5rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s ease;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem;">üîç</span>
                                    <strong style="font-size: 1rem;">Search & Filter</strong>
                                </div>
                                <span id="searchContentToggle" style="font-size: 1.2rem; transition: transform 0.3s ease;">‚ñº</span>
                            </div>
                            <div id="searchContent" class="collapsible-content" style="display: none; margin-top: 0.5rem;">
                                <div class="expense-search-section">
                                    <div class="search-filters">
                                        <div class="search-input-wrapper">
                                            <input type="text" 
                                                   id="expenseSearchInput" 
                                                   class="search-input" 
                                                   placeholder="üîç Search by name..." 
                                                   onkeyup="filterExpenses()">
                                        </div>
                                        <div class="date-filters-row">
                                            <div class="date-filter-group">
                                                <label class="filter-label">From:</label>
                                                <input type="date" 
                                                       id="expenseFilterStart" 
                                                       class="date-filter-input" 
                                                       onchange="filterExpenses()">
                                            </div>
                                            <div class="date-filter-group">
                                                <label class="filter-label">To:</label>
                                                <input type="date" 
                                                       id="expenseFilterEnd" 
                                                       class="date-filter-input" 
                                                       onchange="filterExpenses()">
                                            </div>
                                            <button class="btn-clear-filters" onclick="clearExpenseFilters()" title="Clear filters">
                                                ‚úï
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="historyList">
                            <!-- History will be loaded here -->
                        </div>
                        <div id="noHistory" class="empty-state" style="display: none;">
                            <div class="empty-icon">üìã</div>
                            <h4>No history yet</h4>
                            <p>Proposal history will appear here</p>
                        </div>
                    </div>

                    <!-- Balances Tab -->
                    <div id="balancesTab" class="tab-pane">
                        <div class="balances-header-simple">
                            <h3>‚öñÔ∏è Group Balances</h3>
                            <p class="tab-description">See who owes money and who is owed based on shared expenses</p>
                        </div>

                        <!-- Date Filter for Timeline -->
                        <div id="timelineFilterSection" class="timeline-filter-section" style="display: none;">
                            <div class="filter-header">
                                <h4>üìÖ Expense Timeline</h4>
                                <button class="toggle-timeline-btn" onclick="toggleTimeline()">
                                    <span id="timelineToggleIcon">‚ñº</span> <span id="timelineToggleText">Show Timeline</span>
                                </button>
                            </div>
                            <div id="timelineContent" class="timeline-content" style="display: none;">
                                <div class="date-range-selector">
                                    <div class="date-input-group">
                                        <label for="startDate">From:</label>
                                        <input type="date" id="startDate" class="date-input" onchange="filterTimelineByDate()">
                                    </div>
                                    <div class="date-input-group">
                                        <label for="endDate">To:</label>
                                        <input type="date" id="endDate" class="date-input" onchange="filterTimelineByDate()">
                                    </div>
                                    <button class="btn-reset-dates" onclick="resetDateFilter()">
                                        üîÑ Reset
                                    </button>
                                </div>
                                <div id="expenseTimeline" class="expense-timeline">
                                    <!-- Timeline items will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Balance Dashboard for Simple Mode -->
                        <div id="simpleModeBalanceDashboard" class="balance-dashboard-simple" style="display: none;">
                            <div class="dashboard-stats">
                                <div class="stat-card stat-expenses">
                                    <div class="stat-icon">üí∏</div>
                                    <div class="stat-content">
                                        <span class="stat-label">Total Expenses</span>
                                        <span class="stat-value" id="simpleModeTotalExpenses">$0</span>
                                    </div>
                                </div>
                                <div class="stat-card stat-per-person">
                                    <div class="stat-icon">üë§</div>
                                    <div class="stat-content">
                                        <span class="stat-label">Per Person</span>
                                        <span class="stat-value" id="simpleModePerPerson">$0</span>
                                    </div>
                                </div>
                                <div class="stat-card stat-members">
                                    <div class="stat-icon">üë•</div>
                                    <div class="stat-content">
                                        <span class="stat-label">Active Members</span>
                                        <span class="stat-value" id="simpleModeActiveMembers">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Visual Balance Chart -->
                            <div class="balance-chart-container">
                                <h4 class="chart-title">üí∞ Balance Overview</h4>
                                <div id="balanceChart" class="balance-chart">
                                    <!-- Chart will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Balance List -->
                        <div class="balances-list-container">
                            <div id="balancesList" class="balances-list-simple">
                                <!-- Balances will be loaded here -->
                            </div>
                            
                            <div id="noBalances" class="empty-state" style="display: none;">
                                <div class="empty-icon">‚öñÔ∏è</div>
                                <h4>No members yet</h4>
                                <p>Balances will appear when members start contributing to expenses</p>
                            </div>
                        </div>

                        <!-- Smart Settlements Button -->
                        <div id="smartSettlementsSection" class="smart-settlements-section" style="display: none;">
                            <button class="btn-smart-settle" onclick="openSmartSettlements()">
                                <span class="btn-icon">üéØ</span>
                                <div class="btn-content">
                                    <span class="btn-title">Smart Settlements</span>
                                    <span class="btn-subtitle">Simplify payments with one click</span>
                                </div>
                            </button>
                        </div>

                        <!-- How it works info -->
                        <div class="info-box-simple">
                            <h4>üí° How balances work:</h4>
                            <ul class="info-list">
                                <li><strong>Green (+):</strong> Others owe you money</li>
                                <li><strong>Red (-):</strong> You owe money to others</li>
                                <li><strong>Balanced transactions:</strong> Simplified to minimize payments</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Members Tab -->
                    <div id="membersTab" class="tab-pane">
                        <h3>üë• Miembros del Fondo</h3>
                        <div id="membersList">
                            <!-- Members will be loaded here -->
                        </div>
                        <div id="noMembers" class="empty-state" style="display: none;">
                            <div class="empty-icon">üë§</div>
                            <h4>No hay miembros a√∫n</h4>
                        </div>
                    </div>

                    <!-- Manage Tab -->
                    <div id="manageTab" class="tab-pane">
                        <div class="tab-card">
                            <h3>‚öôÔ∏è Gesti√≥n del Fondo</h3>
                            <p>Opciones avanzadas para administrar el fondo.</p>
                            
                            <div class="manage-section">
                                <!-- Kick Member Section -->
                                <div class="member-management-section">
                                    <h4>üë• Gesti√≥n de Miembros</h4>
                                    <p><strong>Expulsar Miembro</strong></p>
                                    <p class="help-text">
                                        Expulsa a un miembro del grupo devolvi√©ndole su parte proporcional de los fondos actuales.
                                    </p>
                                    
                                    <div class="info-box">
                                        <p><strong>üí° C√≥mo funciona:</strong></p>
                                        <ul>
                                            <li>El miembro es removido del grupo permanentemente</li>
                                            <li>Recibe: (Su aportaci√≥n / Total aportaciones) √ó Balance actual</li>
                                            <li>No podr√° participar en votaciones futuras</li>
                                            <li>Sus votos anteriores quedan registrados</li>
                                        </ul>
                                    </div>
                                    
                                    <div id="kickMembersList" class="kick-members-list">
                                        <!-- Member cards will be loaded here -->
                                    </div>
                                    
                                    <div id="noMembersToKick" class="empty-state" style="display: none;">
                                        <div class="empty-icon">üë•</div>
                                        <h4>No hay miembros para expulsar</h4>
                                        <p>Solo hay un miembro en el grupo o no eres el creador</p>
                                    </div>
                                </div>
                                
                                <div class="danger-zone">
                                    <h4>üö® Zona de Peligro</h4>
                                    <p><strong>Cerrar y Distribuir Fondo</strong></p>
                                    <p class="help-text">
                                        Esta acci√≥n cerrar√° permanentemente el fondo y distribuir√° todos los fondos restantes 
                                        proporcionalmente entre los contribuyentes seg√∫n su aportaci√≥n.
                                    </p>
                                    
                                    <div class="info-box warning-box">
                                        <p><strong>‚ö†Ô∏è Advertencia:</strong></p>
                                        <ul>
                                            <li>Esta acci√≥n es <strong>irreversible</strong></li>
                                            <li>Solo el creador del fondo puede ejecutarla</li>
                                            <li>Cada contribuyente recibir√°: (su aportaci√≥n / total) √ó balance actual</li>
                                            <li>El fondo quedar√° cerrado permanentemente</li>
                                            <li>No se podr√°n hacer m√°s dep√≥sitos ni propuestas</li>
                                        </ul>
                                    </div>
                                    
                                    <div id="closeFundPreview" class="distribution-preview" style="display: none;">
                                        <h5>üìä Vista Previa de Distribuci√≥n</h5>
                                        <div id="distributionList"></div>
                                    </div>
                                    
                                    <div class="button-group">
                                        <button id="previewCloseFundBtn" class="btn btn-secondary">
                                            üìä Vista Previa de Distribuci√≥n
                                        </button>
                                        <button id="closeFundBtn" class="btn btn-danger">
                                            üîí Cerrar y Distribuir Fondo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </section>

            <!-- Floating Add Expense Button (Simple Mode only) -->
            <button id="addExpenseBtn" class="fab-btn" style="display: none;" onclick="showAddExpenseModal()" title="Add Expense">
                <span class="fab-icon">‚ûï</span>
                <span class="fab-text">Add Expense</span>
            </button>

            <!-- Add Expense Modal (Simple Mode) -->
            <div id="addExpenseModal" class="modal" style="display: none;">
                <div class="modal-content modal-medium">
                    <div class="modal-header">
                        <h2>‚ûï Add Expense</h2>
                        <button class="modal-close" onclick="closeAddExpenseModal()">&times;</button>
                    </div>
                    
                    <form id="addExpenseForm" class="expense-form-clean">
                        <div class="form-header-clean">
                            <h3>Add Expense</h3>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <button type="button" class="btn-scan-receipt" onclick="triggerReceiptScan()">
                                    üì∏ Scan Receipt
                                </button>
                                <input 
                                    type="file" 
                                    id="receiptImageInput" 
                                    accept="image/*" 
                                    capture="environment"
                                    style="display: none;"
                                    onchange="handleReceiptImage(event)"
                                >
                            </div>
                        </div>

                        <div id="scanningIndicator" style="display: none; background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; padding: 1rem; border-radius: 8px; margin: 1rem 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div class="spinner-small"></div>
                                <div>
                                    <strong style="color: #667eea;">Scanning receipt...</strong>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                                        Extracting amount, description, and date from image
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-field">
                                <label for="expenseDescription" class="form-label">Description *</label>
                                <input 
                                    type="text" 
                                    id="expenseDescription"
                                    name="description"
                                    class="form-input"
                                    placeholder="What did you pay for?"
                                    required
                                    autocomplete="off"
                                >
                            </div>

                            <div class="form-field">
                                <label for="expenseAmount" class="form-label">Amount *</label>
                                <div class="form-hint" style="margin-bottom: 0.5rem; font-size: 0.85rem; color: #9ca3af;">
                                    Enter a <strong>positive</strong> number for expenses, or a <strong>negative</strong> number for payments received/loans.
                                </div>
                                <div class="amount-input-wrapper">
                                    <span class="currency-symbol" id="currencySymbol">$</span>
                                    <input 
                                        type="number" 
                                        id="expenseAmount"
                                        name="amount"
                                        class="form-input amount-input"
                                        placeholder="0.00"
                                        step="any"
                                        required
                                    >
                                </div>
                                <div class="form-examples" style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                    Examples: 50 (expense), -50 (payment received)
                                </div>
                            </div>

                            <div class="form-field">
                                <label for="expenseCurrency" class="form-label">Currency</label>
                                <select id="expenseCurrency" name="currency" class="form-input form-select" onchange="updateCurrencySymbol()">
                                    <option value="USD" selected>üá∫üá∏ USD - US Dollar</option>
                                    <option value="EUR">üá™üá∫ EUR - Euro</option>
                                    <option value="GBP">üá¨üáß GBP - British Pound</option>
                                    <option value="MXN">üá≤üáΩ MXN - Mexican Peso</option>
                                    <option value="COP">üá®üá¥ COP - Colombian Peso</option>
                                    <option value="BRL">üáßüá∑ BRL - Brazilian Real</option>
                                    <option value="CAD">üá®üá¶ CAD - Canadian Dollar</option>
                                    <option value="AUD">üá¶üá∫ AUD - Australian Dollar</option>
                                    <option value="JPY">üáØüáµ JPY - Japanese Yen</option>
                                    <option value="CNY">üá®üá≥ CNY - Chinese Yuan</option>
                                    <option value="INR">üáÆüá≥ INR - Indian Rupee</option>
                                    <option value="CHF">üá®üá≠ CHF - Swiss Franc</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <label class="form-label">Paid by *</label>
                                <div id="expensePaidBy" class="split-members-list">
                                    <!-- Will be populated dynamically with checkboxes -->
                                </div>
                                <small class="field-hint">Select who paid (can be multiple people)</small>
                            </div>

                            <div class="form-field">
                                <label for="expenseDate" class="form-label">Date</label>
                                <input 
                                    type="date" 
                                    id="expenseDate"
                                    name="date"
                                    class="form-input"
                                >
                            </div>

                            <div class="form-field">
                                <label for="expenseCategory" class="form-label">Category</label>
                                <select id="expenseCategory" name="category" class="form-input form-select">
                                    <option value="food">üçï Food & Dining</option>
                                    <option value="transport">üöó Transportation</option>
                                    <option value="housing">üè† Housing & Rent</option>
                                    <option value="utilities">üí° Utilities</option>
                                    <option value="entertainment">üé¨ Entertainment</option>
                                    <option value="shopping">üõçÔ∏è Shopping</option>
                                    <option value="health">‚öïÔ∏è Health & Medical</option>
                                    <option value="travel">‚úàÔ∏è Travel</option>
                                    <option value="subscription">üì∫ Subscriptions</option>
                                    <option value="other" selected>üéØ Other</option>
                                </select>
                                <small class="field-hint">Helps with analytics and expense tracking</small>
                            </div>

                            <div class="form-field">
                                <label class="form-label">Split between *</label>
                                <div class="info-box" style="margin-bottom: 0.75rem; background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); padding: 0.75rem;">
                                    <p style="margin: 0; font-size: 0.85rem; display: flex; align-items: start; gap: 0.5rem;">
                                        <span style="font-size: 1rem;">üí°</span>
                                        <span>
                                            <strong>Flexible splitting:</strong> Use the <strong>+</strong> and <strong>‚àí</strong> buttons to add portions when a member covers for external guests. 
                                            Example: If someone brings 2 guests, add 3 portions (them + 2 guests).
                                        </span>
                                    </p>
                                </div>
                                <div id="expenseSplitBetween" class="split-members-list">
                                    <!-- Will be populated dynamically -->
                                </div>
                                <small class="field-hint">Select who should share this expense</small>
                            </div>

                            <div class="form-field">
                                <label for="expenseNotes" class="form-label">Notes <span class="optional-badge">Optional</span></label>
                                <textarea 
                                    id="expenseNotes"
                                    name="notes"
                                    class="form-input form-textarea"
                                    rows="2"
                                    placeholder="Add any additional details..."
                                ></textarea>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddExpenseModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Save Expense
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Record Payment Modal -->
            <div id="recordPaymentModal" class="modal" style="display: none;">
                <div class="modal-content modal-small">
                    <div class="modal-header">
                        <h2>üí∞ Record Payment</h2>
                        <button class="modal-close" onclick="closeRecordPaymentModal()">&times;</button>
                    </div>
                    
                    <form id="recordPaymentForm" class="expense-form">
                        <div class="form-group">
                            <label for="paymentAmount" class="input-label">
                                <span class="label-icon">üíµ</span>
                                <span>Amount Paid</span>
                            </label>
                            <div class="input-with-prefix">
                                <span class="input-prefix">$</span>
                                <input 
                                    type="number" 
                                    id="paymentAmount" 
                                    name="amount"
                                    class="input-modern" 
                                    step="0.01" 
                                    min="0.01"
                                    required
                                    placeholder="0.00"
                                >
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="paymentTo" class="input-label">
                                <span class="label-icon">üë§</span>
                                <span>Paid To</span>
                            </label>
                            <input 
                                type="text" 
                                id="paymentTo" 
                                class="input-modern" 
                                readonly
                            >
                        </div>

                        <div class="form-group">
                            <label for="paymentDate" class="input-label">
                                <span class="label-icon">üìÖ</span>
                                <span>Payment Date</span>
                            </label>
                            <input 
                                type="date" 
                                id="paymentDate" 
                                name="date"
                                class="input-modern"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label for="paymentNotes" class="input-label">
                                <span class="label-icon">üìù</span>
                                <span>Notes (Optional)</span>
                            </label>
                            <textarea 
                                id="paymentNotes" 
                                name="notes"
                                class="input-modern"
                                rows="2"
                                placeholder="Payment method, reference number, etc..."
                            ></textarea>
                        </div>

                        <input type="hidden" id="paymentToId" name="toUserId">

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeRecordPaymentModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-success">
                                <span class="btn-icon">‚úÖ</span>
                                <span>Record Payment</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Fund Modal -->
            <div id="createFundModal" class="modal" style="display: none;">
                <div class="modal-content modal-large create-group-modal">
                    <div class="modal-header">
                        <h2>‚ú® Crear Nuevo Grupo</h2>
                        <button class="modal-close" onclick="closeCreateFundModal()">&times;</button>
                    </div>
                    
                    <form id="createFundForm" class="create-group-form" onsubmit="createFund(event)">
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-label">B√°sico</div>
                                <div class="step-connector"></div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-label">Tipo</div>
                                <div class="step-connector"></div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-number">3</div>
                                <div class="step-label">Modo</div>
                            </div>
                        </div>

                        <!-- Step 1: Basic Info -->
                        <div class="form-step" data-step="1" style="display: block;">
                            <h3>üìù ¬øC√≥mo se llama tu grupo?</h3>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem; text-align: center;">Dale un nombre que todos reconozcan f√°cilmente</p>
                            
                            <div class="form-group">
                                <label for="fundName">
                                    <span class="label-text">Nombre del Grupo</span>
                                    <span class="label-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="fundName" 
                                    placeholder="Ej: Gastos del Xolo, Viaje a Canc√∫n, Roommates 2025" 
                                    required 
                                    class="input-modern input-large"
                                />
                                <small class="form-hint">üí° Usa un nombre claro y descriptivo</small>
                            </div>

                            <div class="form-group">
                                <label for="fundDescription">
                                    <span class="label-text">Descripci√≥n</span>
                                    <span class="label-badge">Opcional</span>
                                </label>
                                <textarea 
                                    id="fundDescription" 
                                    rows="3" 
                                    placeholder="Ej: Gastos compartidos de comida, paseos y cuidados del perro"
                                    class="input-modern"
                                ></textarea>
                            </div>
                            
                            <!-- Hidden fields with default values -->
                            <input type="hidden" id="isPrivate" value="true" />
                            <input type="hidden" id="fundType" value="0" />
                            
                            <div class="form-step-buttons">
                                <button type="button" class="btn-step btn-step-back" onclick="closeCreateFundModal()">
                                    Cancelar
                                </button>
                                <button type="button" class="btn-step btn-step-next" onclick="nextStep(2)">
                                    Siguiente ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Mode Selection -->
                        <div class="form-step" data-step="2" style="display: none;">
                            <h3>‚ö° ¬øC√≥mo quieres manejar los gastos?</h3>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem; text-align: center;">Elige el modo que mejor se adapte a tu grupo</p>
                            
                            <div class="mode-selection-grid">
                                <label class="mode-card">
                                    <input type="radio" name="groupMode" value="simple" checked />
                                    <span class="mode-recommended">‚ú® Recomendado</span>
                                    <div class="mode-title">
                                        <span>üìù</span>
                                        <span>Modo Simple</span>
                                    </div>
                                    <div class="mode-description">
                                        Perfecto para empezar. Sin billetera necesaria. Registra gastos y divide cuentas f√°cilmente.
                                    </div>
                                    <ul class="mode-features">
                                        <li>Inicio con Google o Email</li>
                                        <li>Seguimiento de deudas</li>
                                        <li>Aprobaci√≥n colaborativa</li>
                                        <li>Liquidar fuera de la app</li>
                                    </ul>
                                </label>
                                
                                <label class="mode-card mode-disabled" id="blockchainModeCard" style="opacity: 0.5; cursor: not-allowed; position: relative;">
                                    <input type="radio" name="groupMode" value="blockchain" disabled />
                                    <span class="mode-recommended" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">üöÄ Coming Soon</span>
                                    <div class="mode-title">
                                        <span>‚õìÔ∏è</span>
                                        <span>Modo Blockchain</span>
                                    </div>
                                    <div class="mode-description">
                                        Contratos inteligentes autom√°ticos. Votaci√≥n on-chain y transparencia total.
                                    </div>
                                    <ul class="mode-features">
                                        <li>Requiere Wallet cripto</li>
                                        <li>Pagos autom√°ticos</li>
                                        <li>Votaci√≥n en blockchain</li>
                                        <li>Ejecuci√≥n sin confianza</li>
                                    </ul>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1.1rem; font-weight: bold; color: #f59e0b; white-space: nowrap;">EN DESARROLLO</div>
                                </label>
                            </div>

                            <!-- Wallet Warning (shown when wallet not connected) -->
                            <div id="walletWarning" class="wallet-warning" style="display: none;">
                                <div class="warning-icon">‚ö†Ô∏è</div>
                                <div class="warning-content">
                                    <strong>Wallet Not Connected</strong>
                                    <p>To create a Blockchain mode group, you need to connect your crypto wallet first. Please connect your wallet from the main menu.</p>
                                </div>
                            </div>

                            <!-- Hidden governance fields with defaults -->
                            <input type="hidden" id="approvalPercentage" value="60" />
                            <input type="hidden" id="minimumVotes" value="2" />
                            
                            <div class="form-step-buttons">
                                <button type="button" class="btn-step btn-step-back" onclick="previousStep(1)">
                                    ‚Üê Atr√°s
                                </button>
                                <button type="submit" class="btn-step btn-step-submit">
                                    üöÄ Crear Grupo
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- Smart Settlements Modal -->
    <div id="smartSettlementsModal" class="modal-overlay" onclick="closeSmartSettlements(event)">
        <div class="modal-content smart-settlements-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üéØ Smart Settlements</h3>
                <button class="close-btn" onclick="closeSmartSettlements()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settlements-intro">
                    <p class="settlements-description">
                        üí° We've optimized your payments to minimize the number of transactions needed to settle all debts.
                    </p>
                    <div class="settlements-stats">
                        <div class="stat-badge">
                            <span class="stat-number" id="settlementsCount">0</span>
                            <span class="stat-label">payments needed</span>
                        </div>
                        <div class="stat-badge">
                            <span class="stat-number" id="settlementsTotal">$0</span>
                            <span class="stat-label">total to settle</span>
                        </div>
                    </div>
                </div>
                
                <div id="settlementsList" class="settlements-list">
                    <!-- Settlements will be rendered here -->
                </div>
                
                <div id="noSettlements" class="empty-state" style="display: none;">
                    <div class="empty-icon">‚úÖ</div>
                    <h4>All Settled!</h4>
                    <p>Everyone is even. No payments needed.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSmartSettlements()">Close</button>
                <button class="btn btn-success" id="markAllSettledBtn" onclick="markAllSettled()" style="display: none;">
                    <span class="btn-icon">‚úì</span>
                    <span>Mark All as Settled</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="i18n.js"></script>
    <script src="theme.js"></script>
    <script src="ethers.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- App Scripts -->
    <script src="firebase-credentials.js"></script>
    <script src="firebase-config.js"></script>
    <script src="mode-manager.js"></script>
    <script src="wallet-connector.js"></script>
    <script src="form-wizard.js"></script>
    <script src="app-platform.js"></script>
    
    <script>
        // Mode Selector Interaction
        document.addEventListener('DOMContentLoaded', () => {
            const modeRadios = document.querySelectorAll('input[name="groupMode"]');
            const modeInfoBox = document.getElementById('modeInfoBox');
            
            modeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const selectedMode = e.target.value;
                    
                    if (selectedMode === 'simple') {
                        modeInfoBox.innerHTML = `
                            <div class="info-icon">üí°</div>
                            <div class="info-content">
                                <strong>Simple Mode:</strong> Perfect for getting started. No crypto knowledge needed. You can upgrade to Blockchain Mode later if you want automatic payments.
                            </div>
                        `;
                    } else {
                        modeInfoBox.innerHTML = `
                            <div class="info-icon">‚ö†Ô∏è</div>
                            <div class="info-content">
                                <strong>Blockchain Mode:</strong> Requires a wallet (MetaMask) and ETH for gas fees. Payments are automatic and trustless. Once created, the group cannot be converted to Simple Mode.
                            </div>
                        `;
                    }
                });
            });
            
            // Initialize Firebase when page loads
            if (typeof window.FirebaseConfig !== 'undefined') {
                window.FirebaseConfig.initialize().then(success => {
                    if (success) {
                        console.log('‚úÖ Firebase ready for Simple Mode');
                    } else {
                        console.warn('‚ö†Ô∏è Firebase initialization failed - Simple Mode unavailable');
                    }
                });
            }
        });
        
        // Settings Modal Functions for App
        function openAppSettings() {
            const modal = document.getElementById('appSettingsModal');
            modal.classList.add('active');
            updateAppSettingsUI();
        }

        function closeAppSettings(event) {
            if (!event || event.target.classList.contains('modal-overlay') || event.target.classList.contains('close-btn')) {
                const modal = document.getElementById('appSettingsModal');
                modal.classList.remove('active');
            }
        }

        function applyAppTranslations() {
            const currentLang = getCurrentLanguage();
            const t = translations[currentLang];
            
            // Update document title
            document.title = `SplitExpense - ${t.app.header.subtitle}`;
            
            // Header
            const versionBadge = document.querySelector('.version-badge');
            if (versionBadge) versionBadge.textContent = t.app.header.subtitle;
            
            // Connect/Disconnect buttons
            const connectBtn = document.querySelector('#connectWallet span:last-child');
            if (connectBtn) connectBtn.textContent = t.app.header.connect;
            
            const disconnectBtn = document.querySelector('#disconnectWallet span:last-child');
            if (disconnectBtn) disconnectBtn.textContent = t.app.header.disconnect;
            
            // Nickname Modal
            const nicknameTitle = document.querySelector('#nicknameModal h2');
            if (nicknameTitle) nicknameTitle.textContent = `üëã ${t.app.nickname.title}`;
            
            const nicknameParagraph = document.querySelector('#nicknameModal p');
            if (nicknameParagraph) nicknameParagraph.innerHTML = t.app.nickname.subtitle;
            
            const nicknameLabel = document.querySelector('#nicknameModal label');
            if (nicknameLabel) nicknameLabel.textContent = t.app.nickname.label;
            
            const nicknameInput = document.querySelector('#nicknameInput');
            if (nicknameInput) nicknameInput.placeholder = t.app.nickname.placeholder;
            
            const nicknameSmall = document.querySelector('#nicknameModal small');
            if (nicknameSmall) nicknameSmall.textContent = t.app.nickname.help;
            
            const nicknameBtn = document.querySelector('#setNicknameBtn');
            if (nicknameBtn) nicknameBtn.textContent = t.app.nickname.button;
            
            // Stats
            const statCards = document.querySelectorAll('.stat-card p');
            if (statCards[0]) statCards[0].textContent = t.app.stats.fundsCreated;
            if (statCards[1]) statCards[1].textContent = t.app.stats.activeFunds;
            if (statCards[2]) statCards[2].textContent = t.app.stats.totalETH;
            
            // Invitations
            const invitationsTitle = document.querySelector('.invitations-header h3');
            if (invitationsTitle) invitationsTitle.textContent = `üé´ ${t.app.invitations.title}`;
            
            // Dashboard
            const dashboardTitle = document.querySelector('.action-bar h2');
            if (dashboardTitle) dashboardTitle.textContent = t.app.dashboard.title;
            
            const createBtn = document.querySelector('#createFundBtn span:last-child');
            if (createBtn) createBtn.textContent = t.app.dashboard.createNew;
            
            // Filters
            const filterBtns = document.querySelectorAll('.filter-btn');
            if (filterBtns[0]) filterBtns[0].childNodes[0].textContent = `${t.app.dashboard.filters.all} (`;
            if (filterBtns[1]) filterBtns[1].childNodes[0].textContent = `${t.app.dashboard.filters.created} (`;
            if (filterBtns[2]) filterBtns[2].childNodes[0].textContent = `${t.app.dashboard.filters.participating} (`;
            if (filterBtns[3]) filterBtns[3].childNodes[0].textContent = `üå¥ ${t.app.dashboard.filters.travel} (`;
            if (filterBtns[4]) filterBtns[4].childNodes[0].textContent = `üí∞ ${t.app.dashboard.filters.savings} (`;
            if (filterBtns[5]) filterBtns[5].childNodes[0].textContent = `ü§ù ${t.app.dashboard.filters.shared} (`;
            
            // Empty State
            const emptyTitle = document.querySelector('#emptyState h3');
            if (emptyTitle) emptyTitle.textContent = t.app.dashboard.empty.title;
            
            const emptySubtitle = document.querySelector('#emptyState p');
            if (emptySubtitle) emptySubtitle.textContent = t.app.dashboard.empty.subtitle;
            
            const emptyBtn = document.querySelector('#emptyState button span:last-child');
            if (emptyBtn) emptyBtn.textContent = t.app.dashboard.empty.button;
            
            // Back button
            const backBtn = document.querySelector('#backToDashboard span:last-child');
            if (backBtn) backBtn.textContent = t.app.fundDetail.info.backToDashboard;
            
            // Fund Detail Stats
            const statLabels = document.querySelectorAll('.stat-label');
            if (statLabels[0]) statLabels[0].textContent = t.app.fundDetail.info.balance;
            if (statLabels[1]) statLabels[1].textContent = t.app.fundDetail.info.target;
            if (statLabels[2]) statLabels[2].textContent = t.app.fundDetail.info.progress;
            if (statLabels[3]) statLabels[3].textContent = t.app.fundDetail.info.members;
            if (statLabels[4]) statLabels[4].textContent = t.app.fundDetail.info.proposals;
            
            // Fund Detail Loading and Badges
            const fundDetailName = document.querySelector('#fundDetailName');
            if (fundDetailName && fundDetailName.textContent === 'Cargando...') {
                fundDetailName.textContent = t.app.fundDetail.info.loading;
            }
            
            const fundTypeBadge = document.querySelector('#fundTypeBadge');
            if (fundTypeBadge && fundTypeBadge.textContent === 'Tipo') {
                fundTypeBadge.textContent = t.app.fundDetail.info.type;
            }
            
            const fundStatusBadge = document.querySelector('#fundStatusBadge');
            if (fundStatusBadge && fundStatusBadge.textContent === 'Estado') {
                fundStatusBadge.textContent = t.app.fundDetail.info.status;
            }
            
            // Fund Tabs
            const tabButtons = document.querySelectorAll('.fund-tab-btn');
            tabButtons.forEach(btn => {
                const tabId = btn.dataset.tab;
                const span = btn.querySelector('span:last-child');
                if (span && t.app.fundDetail.tabs[tabId]) {
                    span.textContent = t.app.fundDetail.tabs[tabId];
                }
            });
            
            // Deposit Tab
            const depositTitle = document.querySelector('#depositTab h3');
            if (depositTitle) depositTitle.textContent = `üí∞ ${t.app.fundDetail.deposit.title}`;
            
            const depositSubtitle = document.querySelector('#depositTab p');
            if (depositSubtitle) depositSubtitle.textContent = t.app.fundDetail.deposit.subtitle;
            
            const depositLabel = document.querySelector('label[for="depositAmount"]');
            if (depositLabel) depositLabel.textContent = t.app.fundDetail.deposit.amount;
            
            const depositInput = document.querySelector('#depositAmount');
            if (depositInput) depositInput.placeholder = t.app.fundDetail.deposit.amountPlaceholder;
            
            const depositContribution = document.querySelector('.contribution-info span');
            if (depositContribution && depositContribution.textContent.includes('contribuci√≥n')) {
                depositContribution.innerHTML = `${t.app.fundDetail.deposit.currentContribution}: <strong id="userContribution">0 ETH</strong>`;
            }
            
            const depositBtn = document.querySelector('#depositBtn');
            if (depositBtn) depositBtn.textContent = t.app.fundDetail.deposit.button;
            
            // Manage Tab
            const manageTitle = document.querySelector('#manageTab h3');
            if (manageTitle) manageTitle.textContent = `‚öôÔ∏è ${t.app.fundDetail.manage.title}`;
            
            const manageSubtitle = document.querySelector('#manageTab > .tab-card > p');
            if (manageSubtitle) manageSubtitle.textContent = t.app.fundDetail.manage.subtitle;
            
            const memberManagementTitle = document.querySelector('.member-management-section h4');
            if (memberManagementTitle) memberManagementTitle.textContent = `üë• ${t.app.fundDetail.manage.memberManagement}`;
            
            const kickMemberTitle = document.querySelector('.member-management-section p strong');
            if (kickMemberTitle) kickMemberTitle.textContent = t.app.fundDetail.manage.kickMember;
            
            const kickDescription = document.querySelector('.member-management-section .help-text');
            if (kickDescription) kickDescription.textContent = t.app.fundDetail.manage.kickDescription;
            
            const howItWorksTitle = document.querySelector('.member-management-section .info-box p strong');
            if (howItWorksTitle) howItWorksTitle.textContent = `üí° ${t.app.fundDetail.manage.howItWorks}`;
            
            const kickPointsList = document.querySelector('.member-management-section .info-box ul');
            if (kickPointsList) {
                kickPointsList.innerHTML = t.app.fundDetail.manage.kickPoints.map(point => `<li>${point}</li>`).join('');
            }
            
            const noMembersTitle = document.querySelector('#noMembersToKick h4');
            if (noMembersTitle) noMembersTitle.textContent = t.app.fundDetail.manage.noMembersToKick;
            
            const noMembersSubtitle = document.querySelector('#noMembersToKick p');
            if (noMembersSubtitle) noMembersSubtitle.textContent = t.app.fundDetail.manage.noMembersSubtitle;
            
            const dangerZoneTitle = document.querySelector('.danger-zone h4');
            if (dangerZoneTitle) dangerZoneTitle.textContent = `üö® ${t.app.fundDetail.manage.dangerZone}`;
            
            const closeDistributeTitle = document.querySelector('.danger-zone > p strong');
            if (closeDistributeTitle) closeDistributeTitle.textContent = t.app.fundDetail.manage.closeAndDistribute;
            
            const closeDescription = document.querySelector('.danger-zone > .help-text');
            if (closeDescription) closeDescription.textContent = t.app.fundDetail.manage.closeDescription;
            
            const warningTitle = document.querySelector('.warning-box p strong');
            if (warningTitle) warningTitle.textContent = `‚ö†Ô∏è ${t.app.fundDetail.manage.warning}`;
            
            const warningPointsList = document.querySelector('.warning-box ul');
            if (warningPointsList) {
                warningPointsList.innerHTML = t.app.fundDetail.manage.warningPoints.map(point => 
                    point.includes('irreversible') || point.includes('irreversible') 
                        ? `<li>${point.replace('irreversible', '<strong>irreversible</strong>').replace('irreversible', '<strong>irreversible</strong>')}</li>`
                        : `<li>${point}</li>`
                ).join('');
            }
            
            const distributionPreviewTitle = document.querySelector('#closeFundPreview h5');
            if (distributionPreviewTitle) distributionPreviewTitle.textContent = `üìä ${t.app.fundDetail.manage.distributionPreview}`;
            
            const previewButton = document.querySelector('#previewCloseFundBtn');
            if (previewButton) previewButton.textContent = `üìä ${t.app.fundDetail.manage.previewButton}`;
            
            const closeButton = document.querySelector('#closeFundBtn');
            if (closeButton) closeButton.textContent = `üîí ${t.app.fundDetail.manage.closeButton}`;
            
            // Invite Tab
            const inviteTitle = document.querySelector('#inviteTab h3');
            if (inviteTitle) inviteTitle.textContent = `üé´ ${t.app.fundDetail.invite.title}`;
            
            const inviteSubtitle = document.querySelector('#inviteTab > .tab-card > p');
            if (inviteSubtitle) inviteSubtitle.textContent = t.app.fundDetail.invite.subtitle;
            
            const inviteInfoTitle = document.querySelector('.invite-info-box p strong');
            if (inviteInfoTitle) inviteInfoTitle.textContent = `‚ÑπÔ∏è ${t.app.fundDetail.invite.infoTitle}`;
            
            const inviteInfoList = document.querySelector('.invite-info-box ul');
            if (inviteInfoList) {
                inviteInfoList.innerHTML = t.app.fundDetail.invite.infoPoints.map(point => `<li>${point}</li>`).join('');
            }
            
            const inviteLabel = document.querySelector('label[for="inviteAddress"]');
            if (inviteLabel) inviteLabel.textContent = t.app.fundDetail.invite.addressLabel;
            
            const inviteInput = document.querySelector('#inviteAddress');
            if (inviteInput) inviteInput.placeholder = t.app.fundDetail.invite.addressPlaceholder;
            
            const inviteHelp = document.querySelector('#inviteTab small');
            if (inviteHelp) inviteHelp.textContent = t.app.fundDetail.invite.addressHelp;
            
            const inviteBtn = document.querySelector('#inviteBtn');
            if (inviteBtn) inviteBtn.textContent = t.app.fundDetail.invite.button;
            
            // Propose Tab
            const proposeTitle = document.querySelector('#proposeTab h3');
            if (proposeTitle) proposeTitle.textContent = `üìù ${t.app.fundDetail.propose.title}`;
            
            const proposeSubtitle = document.querySelector('#proposeTab > .tab-card > p');
            if (proposeSubtitle) proposeSubtitle.textContent = t.app.fundDetail.propose.subtitle;
            
            const proposeHowItWorks = document.querySelector('#proposeTab .info-box p strong');
            if (proposeHowItWorks) proposeHowItWorks.textContent = `üí° ${t.app.fundDetail.propose.howItWorks}`;
            
            const proposeHowItWorksList = document.querySelector('#proposeTab .info-box ul');
            if (proposeHowItWorksList) {
                proposeHowItWorksList.innerHTML = t.app.fundDetail.propose.howItWorksPoints.map(point => `<li>${point}</li>`).join('');
            }
            
            const proposeRecipientLabel = document.querySelector('label[for="proposalRecipient"]');
            if (proposeRecipientLabel) proposeRecipientLabel.textContent = t.app.fundDetail.propose.recipientLabel;
            
            const proposeRecipientInput = document.querySelector('#proposalRecipient');
            if (proposeRecipientInput) proposeRecipientInput.placeholder = t.app.fundDetail.propose.recipientPlaceholder;
            
            const proposeRecipientHelp = document.querySelector('label[for="proposalRecipient"] + input + small');
            if (proposeRecipientHelp) proposeRecipientHelp.textContent = t.app.fundDetail.propose.recipientHelp;
            
            const proposeAmountLabel = document.querySelector('label[for="proposalAmount"]');
            if (proposeAmountLabel) proposeAmountLabel.textContent = t.app.fundDetail.propose.amountLabel;
            
            const proposeAmountInput = document.querySelector('#proposalAmount');
            if (proposeAmountInput) proposeAmountInput.placeholder = t.app.fundDetail.propose.amountPlaceholder;
            
            const proposeAmountHelp = document.querySelector('label[for="proposalAmount"] + input + small');
            if (proposeAmountHelp) proposeAmountHelp.textContent = t.app.fundDetail.propose.amountHelp;
            
            const proposeDescLabel = document.querySelector('label[for="proposalDescription"]');
            if (proposeDescLabel) proposeDescLabel.textContent = t.app.fundDetail.propose.descriptionLabel;
            
            const proposeDescInput = document.querySelector('#proposalDescription');
            if (proposeDescInput) proposeDescInput.placeholder = t.app.fundDetail.propose.descriptionPlaceholder;
            
            const proposeDescHelp = document.querySelector('label[for="proposalDescription"] + textarea + small');
            if (proposeDescHelp) proposeDescHelp.textContent = t.app.fundDetail.propose.descriptionHelp;
            
            const proposeBtn = document.querySelector('#createProposalBtn');
            if (proposeBtn) proposeBtn.textContent = `üìù ${t.app.fundDetail.propose.button}`;
            
            // Propose Tab - Member Selection
            const involvedMembersLabel = document.querySelector('label[for="involvedMembers"]');
            if (involvedMembersLabel) involvedMembersLabel.textContent = t.app.fundDetail.propose.involvedMembersLabel;
            
            const selectAllMembersBtn = document.getElementById('selectAllMembersBtn');
            if (selectAllMembersBtn) selectAllMembersBtn.textContent = `‚úì ${t.app.fundDetail.propose.selectAllMembers}`;
            
            const deselectAllMembersBtn = document.getElementById('deselectAllMembersBtn');
            if (deselectAllMembersBtn) deselectAllMembersBtn.textContent = `‚úó ${t.app.fundDetail.propose.deselectAllMembers}`;
            
            const involvedMembersHelp = document.querySelector('#proposeTab .form-group small:last-of-type');
            if (involvedMembersHelp) involvedMembersHelp.textContent = t.app.fundDetail.propose.involvedMembersHelp;
            
            // Vote Tab
            const voteTitle = document.querySelector('#voteTab h3');
            if (voteTitle) voteTitle.textContent = `üó≥Ô∏è ${t.app.fundDetail.vote.title}`;
            
            const voteDescription = document.querySelector('#voteTab .tab-description');
            if (voteDescription) voteDescription.textContent = t.app.fundDetail.vote.description;
            
            const noProposalsTitle = document.querySelector('#noProposals h4');
            if (noProposalsTitle) noProposalsTitle.textContent = t.app.fundDetail.vote.noProposals;
            
            const noProposalsSubtitle = document.querySelector('#noProposals p');
            if (noProposalsSubtitle) noProposalsSubtitle.textContent = t.app.fundDetail.vote.noProposalsSubtitle;
            
            // History Tab
            const historyTitle = document.querySelector('#historyTab h3');
            if (historyTitle) historyTitle.textContent = `üìú ${t.app.fundDetail.history.title}`;
            
            const historyDescription = document.querySelector('#historyTab .tab-description');
            if (historyDescription) historyDescription.textContent = t.app.fundDetail.history.description;
            
            const noHistoryTitle = document.querySelector('#noHistory h4');
            if (noHistoryTitle) noHistoryTitle.textContent = t.app.fundDetail.history.empty;
            
            const noHistorySubtitle = document.querySelector('#noHistory p');
            if (noHistorySubtitle) noHistorySubtitle.textContent = t.app.fundDetail.history.emptySubtitle;
            
            // Balances Tab
            const balancesTitle = document.querySelector('#balancesTab h3');
            if (balancesTitle) balancesTitle.textContent = `‚öñÔ∏è ${t.app.fundDetail.balances.title}`;
            
            const balancesDescription = document.querySelector('#balancesTab .tab-description');
            if (balancesDescription) balancesDescription.textContent = t.app.fundDetail.balances.description;
            
            const totalContributedLabel = document.querySelectorAll('.balance-stat-label')[0];
            if (totalContributedLabel) totalContributedLabel.textContent = t.app.fundDetail.balances.totalContributions;
            
            const totalSpentLabel = document.querySelectorAll('.balance-stat-label')[1];
            if (totalSpentLabel) totalSpentLabel.textContent = t.app.fundDetail.balances.totalExpenses;
            
            const availableBalanceLabel = document.querySelectorAll('.balance-stat-label')[2];
            if (availableBalanceLabel) availableBalanceLabel.textContent = t.app.fundDetail.balances.currentBalance;
            
            const balancesHowItWorks = document.querySelector('#balancesTab .info-box p strong');
            if (balancesHowItWorks) balancesHowItWorks.textContent = `üí° ${t.app.fundDetail.balances.howItWorks}`;
            
            const balancesHowItWorksList = document.querySelector('#balancesTab .info-box ul');
            if (balancesHowItWorksList) {
                balancesHowItWorksList.innerHTML = t.app.fundDetail.balances.howItWorksPoints.map(point => `<li>${point}</li>`).join('');
            }
            
            const noBalancesTitle = document.querySelector('#noBalances h4');
            if (noBalancesTitle) noBalancesTitle.textContent = t.app.fundDetail.balances.empty;
            
            const noBalancesSubtitle = document.querySelector('#noBalances p');
            if (noBalancesSubtitle) noBalancesSubtitle.textContent = t.app.fundDetail.balances.emptySubtitle;
            
            // QR Scanner Modal
            const qrScannerTitle = document.querySelector('#qrScannerTitle');
            if (qrScannerTitle) qrScannerTitle.textContent = `üì∑ ${t.app.fundDetail.qrScanner.title}`;
            
            const qrWarningTitle = document.querySelector('#qrWarningTitle');
            if (qrWarningTitle) qrWarningTitle.textContent = `‚ö†Ô∏è ${t.app.fundDetail.qrScanner.warning}`;
            
            const qrWarningList = document.querySelector('#qrWarningList');
            if (qrWarningList) {
                qrWarningList.innerHTML = t.app.fundDetail.qrScanner.warningPoints.map(point => {
                    const parts = point.split(':');
                    if (parts.length > 1) {
                        return `<li><strong>${parts[0]}:</strong>${parts[1]}</li>`;
                    }
                    return `<li>${point}</li>`;
                }).join('');
            }
            
            const qrDetectedLabel = document.querySelector('#qrDetectedLabel');
            if (qrDetectedLabel) qrDetectedLabel.textContent = `‚úÖ ${t.app.fundDetail.qrScanner.detected}`;
            
            const qrFinalConfirmTitle = document.querySelector('#qrFinalConfirmTitle');
            if (qrFinalConfirmTitle) qrFinalConfirmTitle.textContent = `üö® ${t.app.fundDetail.qrScanner.finalConfirmation}`;
            
            const qrConfirmationText = document.querySelector('#qrConfirmationText');
            if (qrConfirmationText) qrConfirmationText.textContent = t.app.fundDetail.qrScanner.confirmationText;
            
            const qrConfirmationList = document.querySelector('#qrConfirmationList');
            if (qrConfirmationList) {
                qrConfirmationList.innerHTML = t.app.fundDetail.qrScanner.confirmationPoints.map(point => {
                    if (point.includes('Base blockchain')) {
                        return `<li>${point.replace('Base blockchain', '<strong>Base blockchain</strong>')}</li>`;
                    }
                    if (point.includes('blockchain de Base')) {
                        return `<li>${point.replace('blockchain de Base', '<strong>blockchain de Base</strong>')}</li>`;
                    }
                    if (point.includes('cannot be recovered') || point.includes('no pueden recuperarse')) {
                        return `<li>${point.replace('cannot be recovered', '<strong>cannot be recovered</strong>').replace('no pueden recuperarse', '<strong>no pueden recuperarse</strong>')}</li>`;
                    }
                    return `<li>${point}</li>`;
                }).join('');
            }
            
            const qrCheckboxLabel = document.querySelector('#qrCheckboxLabel');
            if (qrCheckboxLabel) qrCheckboxLabel.textContent = t.app.fundDetail.qrScanner.checkboxLabel;
            
            const confirmQRBtn = document.querySelector('#confirmQRBtn');
            if (confirmQRBtn) confirmQRBtn.innerHTML = `‚úì ${t.app.fundDetail.qrScanner.confirmButton}`;
            
            const qrCancelBtn2 = document.querySelector('#qrCancelBtn2');
            if (qrCancelBtn2) qrCancelBtn2.textContent = t.app.fundDetail.qrScanner.cancelButton;
            
            const cancelScanBtn = document.querySelector('#cancelScanBtn');
            if (cancelScanBtn) cancelScanBtn.textContent = t.app.fundDetail.qrScanner.cancelScan;
            
            // Create Fund Modal
            const createFundTitle = document.querySelector('#createFundModal h2');
            if (createFundTitle) createFundTitle.textContent = `‚ú® ${t.app.createFund.title}`;
            
            // Section headers
            // Section headers (removed fund type and privacy sections)
            // No section headers to translate now
            
            // Form fields
            const fundNameLabel = document.querySelector('label[for="fundName"] .label-text');
            if (fundNameLabel) fundNameLabel.textContent = t.app.createFund.fields.name;
            
            const fundNameInput = document.querySelector('#fundName');
            if (fundNameInput) fundNameInput.placeholder = t.app.createFund.fields.namePlaceholder;
            
            const fundDescLabel = document.querySelector('label[for="fundDescription"] .label-text');
            if (fundDescLabel) fundDescLabel.textContent = t.app.createFund.fields.description;
            
            const fundDescInput = document.querySelector('#fundDescription');
            if (fundDescInput) fundDescInput.placeholder = t.app.createFund.fields.descriptionPlaceholder;
            
            // Voting fields
            const approvalLabel = document.querySelector('label[for="approvalPercentage"] .label-text');
            if (approvalLabel) approvalLabel.textContent = t.app.createFund.fields.approvalPercentage;
            
            const approvalHint = document.querySelector('label[for="approvalPercentage"]').parentElement.querySelector('.form-hint');
            if (approvalHint) approvalHint.textContent = t.app.createFund.fields.approvalHint;
            
            const minimumVotesLabel = document.querySelector('label[for="minimumVotes"] .label-text');
            if (minimumVotesLabel) minimumVotesLabel.textContent = t.app.createFund.fields.minimumVotes;
            
            const minimumVotesHint = document.querySelector('label[for="minimumVotes"]').parentElement.querySelector('.form-hint');
            if (minimumVotesHint) minimumVotesHint.textContent = t.app.createFund.fields.minimumVotesHint;
            
            // Buttons
            const cancelCreateBtn = document.querySelector('#createFundModal .btn-secondary');
            if (cancelCreateBtn) cancelCreateBtn.textContent = t.app.createFund.buttons.cancel;
            
            const createSubmitBtn = document.querySelector('#createFundModal .btn-primary[type="submit"]');
            if (createSubmitBtn) createSubmitBtn.innerHTML = `üöÄ ${t.app.createFund.buttons.create}`;
        }

        function updateAppSettingsUI() {
            const currentLang = getCurrentLanguage();
            const currentTheme = getCurrentTheme();
            const settings = translations[currentLang].settings;
            
            // Update settings title
            const settingsTitleText = document.querySelector('#appSettingsModal .settings-title-text');
            if (settingsTitleText) settingsTitleText.textContent = settings.title;
            
            // Update language buttons
            document.querySelectorAll('[data-lang]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
            
            // Update theme buttons
            document.querySelectorAll('[data-theme]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === currentTheme);
            });
        }

        // Initialize settings UI on load
        document.addEventListener('DOMContentLoaded', () => {
            applyAppTranslations();
            updateAppSettingsUI();
        });
    </script>

    <!-- Recurring Expense Modal -->
    <div id="recurringExpenseModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>üîÑ Create Recurring Expense</h2>
                <button class="modal-close" onclick="closeRecurringExpenseModal()">&times;</button>
            </div>
            
            <form id="recurringExpenseForm" class="expense-form-clean">
                <div class="form-header-clean">
                    <h3>Automate Regular Expenses</h3>
                    <p style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                        Perfect for rent, utilities, subscriptions, or any expense that repeats regularly.
                    </p>
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="recurringDescription" class="form-label">Description *</label>
                        <input 
                            type="text" 
                            id="recurringDescription"
                            class="form-input"
                            placeholder="e.g., Monthly Rent, Netflix, Groceries"
                            required
                        >
                    </div>

                    <div class="form-field">
                        <label for="recurringAmount" class="form-label">Amount *</label>
                        <div class="amount-input-wrapper">
                            <span class="currency-symbol" id="recurringCurrencySymbol">$</span>
                            <input 
                                type="number" 
                                id="recurringAmount"
                                class="form-input amount-input"
                                placeholder="0.00"
                                step="any"
                                required
                            >
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="recurringCurrency" class="form-label">Currency</label>
                        <select id="recurringCurrency" class="form-input form-select" onchange="updateRecurringCurrencySymbol()">
                            <option value="USD" selected>üá∫üá∏ USD</option>
                            <option value="EUR">üá™üá∫ EUR</option>
                            <option value="GBP">üá¨üáß GBP</option>
                            <option value="MXN">üá≤üáΩ MXN</option>
                            <option value="COP">üá®üá¥ COP</option>
                            <option value="BRL">üáßüá∑ BRL</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="recurringCategory" class="form-label">Category</label>
                        <select id="recurringCategory" class="form-input form-select">
                            <option value="food">üçï Food & Dining</option>
                            <option value="transport">üöó Transportation</option>
                            <option value="housing" selected>üè† Housing & Rent</option>
                            <option value="utilities">üí° Utilities</option>
                            <option value="entertainment">üé¨ Entertainment</option>
                            <option value="shopping">üõçÔ∏è Shopping</option>
                            <option value="health">‚öïÔ∏è Health & Medical</option>
                            <option value="travel">‚úàÔ∏è Travel</option>
                            <option value="subscription">üì∫ Subscriptions</option>
                            <option value="other">üéØ Other</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="recurringFrequency" class="form-label">Frequency *</label>
                        <select id="recurringFrequency" class="form-input form-select" onchange="updateRecurringFrequencyOptions()">
                            <option value="daily">üìÖ Daily</option>
                            <option value="weekly">üìÜ Weekly</option>
                            <option value="monthly" selected>üóìÔ∏è Monthly</option>
                        </select>
                    </div>

                    <div class="form-field" id="dayOfMonthField">
                        <label for="recurringDayOfMonth" class="form-label">Day of Month *</label>
                        <select id="recurringDayOfMonth" class="form-input form-select">
                            <option value="1" selected>1st of month</option>
                            <option value="15">15th of month</option>
                            <option value="30">30th of month (last day for shorter months)</option>
                        </select>
                        <small class="field-hint">When should this expense be created each month?</small>
                    </div>

                    <div class="form-field" id="dayOfWeekField" style="display: none;">
                        <label for="recurringDayOfWeek" class="form-label">Day of Week *</label>
                        <select id="recurringDayOfWeek" class="form-input form-select">
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                            <option value="7">Sunday</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Paid by *</label>
                        <div id="recurringPaidBy" class="split-members-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Split between *</label>
                        <div class="info-box" style="margin-bottom: 0.75rem; background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); padding: 0.75rem;">
                            <p style="margin: 0; font-size: 0.85rem; display: flex; align-items: start; gap: 0.5rem;">
                                <span style="font-size: 1rem;">üí°</span>
                                <span>
                                    <strong>Flexible splitting:</strong> Use the <strong>+</strong> and <strong>‚àí</strong> buttons to add portions when a member covers for external guests.
                                </span>
                            </p>
                        </div>
                        <div id="recurringSplitBetween" class="split-members-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRecurringExpenseModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üîÑ Create Recurring Expense
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>üí∞ Set Group Budget</h2>
                <button class="modal-close" onclick="closeBudgetModal()">&times;</button>
            </div>
            
            <form id="budgetForm" class="expense-form-clean">
                <div class="form-header-clean" style="padding: 1rem 1.5rem 0;">
                    <p style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin: 0;">
                        Set a spending limit and get alerts when approaching it. Perfect for trips or monthly shared costs.
                    </p>
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="budgetAmount" class="form-label">Budget Amount *</label>
                        <div class="amount-input-wrapper">
                            <span class="currency-symbol" id="budgetCurrencySymbol">$</span>
                            <input 
                                type="number" 
                                id="budgetAmount"
                                class="form-input amount-input"
                                placeholder="2000"
                                step="any"
                                required
                            >
                        </div>
                        <small class="field-hint">Total amount you plan to spend</small>
                    </div>

                    <div class="form-field">
                        <label for="budgetCurrency" class="form-label">Currency</label>
                        <select id="budgetCurrency" class="form-input form-select" onchange="updateBudgetCurrencySymbol()">
                            <option value="USD" selected>üá∫üá∏ USD</option>
                            <option value="EUR">üá™üá∫ EUR</option>
                            <option value="GBP">üá¨üáß GBP</option>
                            <option value="MXN">üá≤üáΩ MXN</option>
                            <option value="COP">üá®üá¥ COP</option>
                            <option value="BRL">üáßüá∑ BRL</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="budgetPeriod" class="form-label">Budget Period *</label>
                        <select id="budgetPeriod" class="form-input form-select">
                            <option value="trip">üèñÔ∏è One-time (trip/event)</option>
                            <option value="monthly">üìÜ Monthly</option>
                            <option value="weekly">üìÖ Weekly</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Alerts</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="alert50" checked>
                                <span>50%</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="alert80" checked>
                                <span>80%</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="alert100" checked>
                                <span>100%</span>
                            </label>
                        </div>
                        <small class="field-hint">Visual warnings when thresholds are reached</small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBudgetModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üí∞ Set Budget
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>üìä Expense Analytics</h2>
                <button class="modal-close" onclick="closeAnalyticsModal()">&times;</button>
            </div>
            
            <div class="analytics-container">
                <!-- Timeframe selector -->
                <div class="timeframe-selector" style="margin-bottom: 2rem;">
                    <button class="btn-timeframe active" onclick="switchTimeframe('week')">Week</button>
                    <button class="btn-timeframe" onclick="switchTimeframe('month')">Month</button>
                    <button class="btn-timeframe" onclick="switchTimeframe('year')">Year</button>
                    <button class="btn-timeframe" onclick="switchTimeframe('all')">All Time</button>
                </div>

                <!-- Summary Stats -->
                <div id="analyticsStats" class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- Populated dynamically -->
                </div>

                <!-- Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="chart-container">
                        <h3 style="margin-bottom: 1rem;">By Category</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="margin-bottom: 1rem;">By Member</h3>
                        <canvas id="memberChart"></canvas>
                    </div>
                </div>

                <div class="chart-container" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Spending Over Time</h3>
                    <canvas id="timelineChart"></canvas>
                </div>

                <!-- Export Options -->
                <div class="export-section" style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">üì• Export Data</h3>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="exportToCSV()">
                            üìÑ Export to CSV
                        </button>
                        <button class="btn btn-secondary" onclick="exportToPDF()">
                            üìë Export to PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recurring Expense Details/Edit Modal -->
    <div id="recurringDetailsModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>üîÑ Recurring Expense Details</h2>
                <button class="modal-close" onclick="closeRecurringDetailsModal()">&times;</button>
            </div>
            
            <div id="recurringDetailsContent" style="padding: 1.5rem;">
                <!-- Populated dynamically -->
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRecurringDetailsModal()">
                    Close
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteRecurring()">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Recurring Expenses Modal (List View) -->
    <div id="manageRecurringModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>üîÑ Manage Recurring Expenses</h2>
                <button class="modal-close" onclick="closeManageRecurringModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <p style="color: rgba(255,255,255,0.7); margin: 0;">
                        View and manage all your recurring expenses. Click on any expense to see details and make changes.
                    </p>
                    <button class="btn btn-primary" onclick="closeManageRecurringModal(); showRecurringExpenseModal();">
                        ‚ûï Add New
                    </button>
                </div>
                
                <div id="manageRecurringList">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- OpenAI Configuration Modal -->
    <div id="openaiConfigModal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>üîë Configure OpenAI API</h2>
                <button class="modal-close" onclick="closeOpenAIConfigModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem;">
                    To use receipt scanning, you need an OpenAI API key. Your key is stored locally and never shared.
                </p>
                
                <div class="form-field">
                    <label for="openaiApiKey" class="form-label">OpenAI API Key</label>
                    <input 
                        type="password" 
                        id="openaiApiKey"
                        class="form-input"
                        placeholder="sk-..."
                    >
                    <small class="field-hint">
                        Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #667eea;">platform.openai.com</a>
                    </small>
                </div>
                
                <div style="background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <strong style="color: #667eea;">üí° Tip:</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                        Each receipt scan costs approximately $0.01-0.03 USD. Your API key is stored in your browser's local storage.
                    </p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeOpenAIConfigModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveOpenAIConfig()">
                    üíæ Save API Key
                </button>
            </div>
        </div>
    </div>

</body>
</html>
