{
  "rules": {
    "groups": {
      ".read": "auth != null && root.child('system/admins').child(auth.uid).val() === true",
      ".indexOn": ["createdBy"],
      "$groupId": {
        ".read": "auth != null",
        ".write": "auth != null && (!data.exists() || data.child('createdBy').val() === auth.uid || data.child('members').child(auth.uid).exists())",
        ".validate": "newData.hasChildren(['id', 'name', 'createdBy', 'createdAt'])",
        
        "name": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
        },
        
        "description": {
          ".validate": "newData.isString() && newData.val().length <= 500"
        },
        
        "targetAmount": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 1000000000000"
        },
        
        "currency": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Z]{3}$/)"
        },
        
        "members": {
          "$memberId": {
            ".write": "auth != null && ($memberId === auth.uid || root.child('groups').child($groupId).child('createdBy').val() === auth.uid)",
            
            "email": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
            },
            
            "name": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
            }
          }
        },
        
        "expenses": {
          "$expenseId": {
            ".write": "auth != null && root.child('groups').child($groupId).child('members').child(auth.uid).exists()",
            
            "description": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
            },
            
            "amount": {
              ".validate": "newData.isNumber() && newData.val() > 0 && newData.val() <= 1000000000000"
            },
            
            "notes": {
              ".validate": "!newData.exists() || (newData.isString() && newData.val().length <= 1000)"
            }
          }
        },
        
        "settlements": {
          "$settlementId": {
            ".write": "auth != null && root.child('groups').child($groupId).child('members').child(auth.uid).exists()",
            
            "amount": {
              ".validate": "newData.isNumber() && newData.val() > 0 && newData.val() <= 1000000000000"
            },
            
            "notes": {
              ".validate": "!newData.exists() || (newData.isString() && newData.val().length <= 500)"
            }
          }
        },
        
        "recurringExpenses": {
          "$recurringId": {
            ".write": "auth != null && root.child('groups').child($groupId).child('members').child(auth.uid).exists()",
            
            "description": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
            },
            
            "amount": {
              ".validate": "newData.isNumber() && newData.val() > 0 && newData.val() <= 1000000000000"
            }
          }
        },
        
        "budget": {
          "amount": {
            ".validate": "newData.isNumber() && newData.val() > 0 && newData.val() <= 1000000000000"
          }
        },
        
        "colony": {
          ".read": "auth != null",
          ".write": "auth != null && root.child('groups').child($groupId).child('members').child(auth.uid).exists()",
          
          "state": {
            ".validate": "newData.isString() && newData.val().matches(/^(forming|active|stable|consolidated)$/)"
          },
          
          "totalActivity": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          
          "weeklyActivity": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          
          "consecutiveActiveWeeks": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          }
        },
        
        "mascot": {
          ".read": "auth != null",
          ".write": "auth != null && root.child('groups').child($groupId).child('members').child(auth.uid).exists()",
          
          "equipped": {
            "head": {
              ".validate": "!newData.exists() || newData.isString()"
            },
            "accessory": {
              ".validate": "!newData.exists() || newData.isString()"
            }
          },
          
          "wardrobe": {
            "$itemId": {
              "copies": {
                ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100"
              },
              "level": {
                ".validate": "newData.isString() && newData.val().matches(/^(basic|silver|gold)$/)"
              },
              "lastObtained": {
                ".validate": "newData.isNumber()"
              }
            }
          }
        }
      }
    },
    
    "weeklyChests": {
      "$groupId": {
        "$weekId": {
          ".read": "auth != null && root.child('groups').child($groupId).child('members').child(auth.uid).exists()",
          ".write": "auth != null",
          
          "state": {
            ".validate": "newData.isString()"
          },
          
          "description": {
            ".validate": "newData.isString() && newData.val().length <= 500"
          },
          
          "isOpened": {
            ".validate": "newData.isBoolean()"
          },
          
          "openedBy": {
            ".validate": "!newData.exists() || newData.isString()"
          },
          
          "openedAt": {
            ".validate": "!newData.exists() || newData.isNumber()"
          }
        }
      }
    },
    
    "users": {
      ".read": "auth != null && root.child('system/admins').child(auth.uid).val() === true",
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null && auth.uid === $userId"
      }
    },
    
    "notifications": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null",
        ".indexOn": ["timestamp"],
        
        "$notificationId": {
          ".validate": "newData.hasChildren(['type', 'message', 'timestamp'])"
        }
      }
    },
    
    "fcmTokens": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null && auth.uid === $userId",
        
        "$tokenId": {
          ".validate": "newData.hasChildren(['token', 'createdAt', 'lastUsed'])"
        }
      }
    },
    
    "system": {
      "exchangeRates": {
        ".read": true,
        ".write": "auth != null"
      },
      "admins": {
        ".read": "auth != null",
        ".write": "auth != null",
        "$adminId": {
          ".validate": "newData.isBoolean()"
        }
      }
    }
  }
}
